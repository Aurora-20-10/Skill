<!DOCTYPE html>

<html data-theme="dark" lang="vi">
<head>
<style>
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1,1);white-space:nowrap;border:0}
    
/* Dashboard removed */
#dashboardSec, #tab-dashboard { display:none !important; }

/* Fix: chỉ hiển thị panel đang hoạt động */
section[id$="Sec"]{ display:none; }
section[id$="Sec"].active{ display:block; }
</style>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Bảng điều khiển Kỹ năng – Bản đã sửa</title>
<!-- Fonts -->
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Global error handler to surface runtime errors via toast notifications
window.addEventListener('error', function(e) {
  try {
    // Use toast if available, otherwise fallback to alert
    if (typeof toast === 'function') {
      toast('Lỗi runtime: ' + (e.message || e.error && e.error.message || 'Unknown'));
    } else {
      alert('Lỗi runtime: ' + (e.message || 'Unknown'));
    }
  } catch (_) {
    /* ignore */
  }
});
/* ===== Toast + Focus Trap Utils ===== */
  function toast(msg, timeout=1600){
    const wrap = document.getElementById('toastContainer');
    if (!wrap) { try { alert(String(msg||'')); } catch(_){} return; }
    const node = document.createElement('div');
    node.className = 'toast';
    node.textContent = String(msg || '');
    wrap.appendChild(node);
    setTimeout(()=>{ node.style.opacity='0'; node.style.transform='translateY(6px)'; }, Math.max(800, timeout-300));
    setTimeout(()=>{ node.remove(); }, timeout);
  }

  function trapFocus(modal){
    const fsel = 'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
    const focusables = Array.from(modal.querySelectorAll(fsel)).filter(el=>!el.disabled && el.offsetParent!==null);
    const first = focusables[0] || modal, last = focusables[focusables.length-1] || modal;
    function loop(e){
      if(e.key !== 'Tab') return;
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    modal.__trapLoop = loop;
    modal.addEventListener('keydown', loop);
  }
  function untrapFocus(modal){
    if(modal && modal.__trapLoop){ modal.removeEventListener('keydown', modal.__trapLoop); delete modal.__trapLoop; }
  }


  // Close modals on ESC
  document.addEventListener('keydown', (e)=>{
    if(e.key !== 'Escape') return;
    const openModals = Array.from(document.querySelectorAll('.modal.open'));
    if(!openModals.length) return;
    const top = openModals[openModals.length-1];
    if(top.id === 'editModal'){ try { closeEdit(); } catch(_) { top.classList.remove('open'); top.setAttribute('aria-hidden','true'); } }
    else if(top.id === 'restoreModal'){ try { btnCloseRestore && btnCloseRestore.click(); } catch(_) { top.classList.remove('open'); top.setAttribute('aria-hidden','true'); } }
    else if(top.id === 'logModal'){ try { closeQuickLog(); } catch(_) { top.classList.remove('open'); top.setAttribute('aria-hidden','true'); } }
  });


  function debounce(fn, ms=220){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }




document.addEventListener('DOMContentLoaded', () => {
  const restoreModal = document.getElementById('restoreModal');
  const btnCloseRestore = document.getElementById('btnCloseRestore');
  if (btnCloseRestore) {
    btnCloseRestore.addEventListener('click', () => {
      try { untrapFocus(restoreModal); } catch (_) {}
    });
  }
  if (restoreModal) {
    restoreModal.addEventListener('click', (e) => {
      if (e.target === restoreModal) {
        try { untrapFocus(restoreModal); } catch (_) {}
      }
    });
  }
});

</script>
<style>
    :root {
      --bg: #0b0d10;
      --surface: #11151a;
      --surface-2: #0f1419;
      --text: #e6e9ee;
      --muted: #9aa4b2;
      --primary: #80d0ff;
      --primary-2: #3aa3ff;
      --accent: #a78bfa;
      --outline: rgba(255,255,255,.08);
      --shadow: rgba(0,0,0,.35);
      --overlay: rgba(0,0,0,.6);
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #ef4444;
      --radius-xl: 1.25rem;
      --radius-lg: 1rem;
      --radius-md: .75rem;
      --radius-sm: .5rem;
      --ring: 0 0 0 1.5px var(--outline);
      --shadow-2: 0 10px 30px var(--shadow);
    }
    [data-theme="light"] {
      --bg: #f6f8fb;
      --surface: #ffffff;
      --surface-2: #f2f5f9;
      --text: #0c1117;
      --muted: #415066;
      --outline: rgba(0,0,0,.08);
      --shadow: rgba(0,0,0,.15);
      --overlay: rgba(0,0,0,.35);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:
        radial-gradient(1000px 600px at 10% -10%, rgba(76,29,149,.25), transparent 60%),
        radial-gradient(900px 500px at 110% -20%, rgba(28,100,242,.25), transparent 60%),
        var(--bg);
      color: var(--text);
      line-height: 1.45;
    }

    header.appbar {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(1.2) blur(8px);
      background: color-mix(in lab, var(--bg) 65%, transparent);
      border-bottom: 1px solid var(--outline);
    }
    .appbar-inner {
      max-width: 1100px; margin: 0 auto; padding: .9rem 1.2rem;
      display: flex; align-items: center; gap: 12px;
    }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg,var(--primary),var(--accent));
      box-shadow: var(--shadow-2);
    }
    h1.title {
      font-size: 1.05rem; margin: 0; font-weight: 700; letter-spacing: .2px;
    }
    .spacer { flex: 1 1 auto; }
    .btn {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .55rem .9rem; border-radius: .7rem;
      border: 1px solid var(--outline);
      background: var(--surface);
      color: var(--text); cursor: pointer;
      box-shadow: 0 6px 20px var(--shadow);
      user-select: none;
    }
    .btn[aria-pressed="true"] { outline: 2px solid var(--primary-2); }
    .btn:hover { filter: brightness(1.04); }
    .btn.small { padding: .4rem .65rem; border-radius: .6rem; font-size: .9rem; }
    .chip {
      display: inline-flex; align-items: center; gap: .35rem;
      padding: .25rem .55rem; border-radius: 999px;
      background: color-mix(in lab, var(--primary) 20%, transparent);
      color: color-mix(in lab, var(--primary-2) 85%, var(--text));
      font-size: .78rem; border: 1px solid var(--outline);
    }

    main { max-width: 1100px; margin: 18px auto 60px; padding: 0 1.2rem; }

    /* Tabs */
    .tabs {
      display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: .6rem; margin-bottom: 14px;
    }
    .tab {
      border: 1px solid var(--outline); background: var(--surface);
      padding: .65rem .8rem; border-radius: .8rem;
      display: inline-flex; align-items: center; justify-content: center; gap: .5rem;
      font-weight: 600; cursor: pointer; user-select: none;
    }
    .tab[aria-selected="true"] {
      background: linear-gradient(180deg,
        color-mix(in lab, var(--primary) 18%, var(--surface)),
        var(--surface));
      border-color: color-mix(in lab, var(--primary) 40%, var(--outline));
      box-shadow: inset 0 0 0 1px color-mix(in lab, var(--primary) 45%, transparent),
                  0 10px 24px var(--shadow);
    }

    section.view {
      display: none;
      border: 1px solid var(--outline);
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2);
      padding: 1rem;
    }
    section.view.active { display: block; }

    /* Cards */
    .grid {
      display: grid; gap: .9rem;
      grid-template-columns: repeat(12, 1fr);
    }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .card {
      background: var(--surface-2);
      border: 1px solid var(--outline);
      border-radius: var(--radius-lg);
      padding: 1rem;
      box-shadow: var(--shadow-2);
    }
    .card h3 { margin: 0 0 .25rem; font-size: 1rem; }
    .muted { color: var(--muted); font-size: .92rem; }

    .row { display: flex; gap: .65rem; flex-wrap: wrap; align-items: center; }
    .right { margin-left: auto; }
    .field {
      display: grid; gap: .35rem; width: 100%;
    }
    label { font-size: .86rem; color: var(--muted); }
    input[type="text"], select, textarea {
      width: 100%; padding: .6rem .7rem; border-radius: .6rem;
      border: 1px solid var(--outline); background: var(--surface);
      color: var(--text);
    }
    textarea { min-height: 90px; resize: vertical; }

    /* Skill card */
    .skill-card { display: grid; gap: .65rem; }
    .skill-head { display: flex; align-items: center; gap: .6rem; }
    .skill-actions { display: flex; gap: .5rem; margin-left: auto; }
    .tag { font-size: .75rem; padding: .25rem .5rem; border-radius: .5rem; border: 1px solid var(--outline); color: var(--muted); }
    .tag.phase-1 { color: var(--success); }
    .tag.phase-2 { color: var(--warning); }
    .tag.phase-3 { color: var(--danger); }


    /* Toast */
    .toast-container { position: fixed; inset: auto 1rem 1rem auto; z-index: 60; display: grid; gap: .5rem; }
    .toast {
      background: var(--surface); color: var(--text);
      border: 1px solid var(--outline); border-radius: var(--radius-lg);
      box-shadow: var(--shadow-2); padding: .6rem .8rem; font-size: .9rem;
      max-width: 360px; opacity: 0; transform: translateY(6px);
      animation: toastIn .2s ease forwards;
    }
    @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }

    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center; z-index: 50;
      background: var(--overlay);
    }
    .modal.open { display: grid; }
    .modal .dialog {
      max-height: 88vh; overflow: auto;
      background: var(--surface); border: 1px solid var(--outline); border-radius: var(--radius-xl);
      width: min(680px, 92vw); padding: 1rem;
      box-shadow: var(--shadow-2);
    }

    /* Footer */
    footer {
      max-width: 1100px; margin: 24px auto; padding: 0 1.2rem;
      color: var(--muted); font-size: .9rem;
    }

    @media (max-width: 980px) {
      .tabs { grid-template-columns: 1fr 1fr; }
      .col-6 { grid-column: span 12; }
      .col-4 { grid-column: span 12; }
    }
  
    /* --- UI polish --- */
    .chip.sm, .tag.sm { font-size: .72rem; padding: .2rem .45rem; border-radius: .5rem; }
    .meta-row { display: flex; gap: .35rem; flex-wrap: wrap; margin: .35rem 0 .15rem; }
    .skill-actions { margin-left: auto; }
    .skill-head h3 { flex: 0 1 auto; }
    .skill-head { gap: .5rem; }
    .title-row { display:flex; align-items:center; gap:.5rem; }
    .phase-pill { margin-left:.25rem; }
    .card .section-title { margin:.2rem 0 .6rem; font-weight:700; font-size:.92rem; color:var(--muted); }
    .dialog .grid { gap:.8rem; }
    .dialog .field label { font-size:.82rem; color:var(--muted); }
    .dialog input[type="text"], .dialog select, .dialog input[type="date"], .dialog textarea {
      padding:.55rem .65rem;
    }
    .dialog .toolbar { display:flex; gap:.5rem; justify-content:flex-end; align-items:center; }

    .kitem { display:flex; align-items:center; gap:.55rem; padding:.4rem .5rem; border-radius:.5rem; }
  .kitem:hover { background: color-mix(in lab, var(--outline) 45%, transparent); }
  .kcode { font-weight: 700; width: 2.2rem; text-align:center; border:1px solid var(--outline); border-radius:.45rem; padding:.1rem .35rem; }
  .kname { opacity:.9; }
  .klist .col { padding:.2rem; }
  .kgrid { display:grid; grid-template-columns: 1fr 1fr; gap:.2rem; }
  @media (max-width: 680px){ .kgrid { grid-template-columns: 1fr; } }
.card.dim { opacity:.45; filter:saturate(.7); }
.badge-warn { display:inline-flex; align-items:center; gap:.35rem; font-size:.72rem; padding:.2rem .45rem; border-radius:.45rem; border:1px solid var(--outline); background:rgba(239,68,68,.12); color:#ef4444; }
.badge-ok { display:inline-flex; font-size:.72rem; padding:.2rem .45rem; border-radius:.45rem; border:1px solid var(--outline); background:rgba(34,197,94,.12); color:#22c55e; }

/* CP block (view-only) */
.cp-block{margin-top:.6rem;border:1px solid var(--outline);border-radius:.6rem;padding:.6rem .8rem;background:var(--surface)}
.cp-block summary{cursor:pointer;font-weight:700}
.cp-block .cp-sec{margin-top:.45rem}
.cp-block .cp-sec h4{margin:.1rem 0 .25rem;font-size:.9rem;color:var(--muted);font-weight:700}
.cp-block ul{margin:.15rem 0 .25rem .9rem;padding:0}
.cp-block li{margin:.1rem 0}

/* CP mapping mini UI */
.cp-map{margin-top:.4rem;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
.cp-map label{font-size:.85rem;opacity:.8}
.cp-map select,.cp-map button{padding:.4rem .6rem;border:1px solid var(--outline);border-radius:.45rem;background:var(--surface)}
.cp-map button{cursor:pointer}
</style>
<style>
.p1-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:16px 0}
.p1-card{border:1px solid rgba(0,0,0,0.08);border-radius:12px;padding:12px;background:rgba(255,255,255,0.6);backdrop-filter:blur(4px)}
.p1-card h4{margin:0 0 6px 0;font-size:14px;opacity:.7}
.p1-card .big{font-size:28px;font-weight:700}
.p1-card .sub{font-size:12px;opacity:.7}
.p1-btn{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(0,0,0,0.15);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.p1-btn:active{transform:translateY(1px)}
#useCaseModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:9998}
#useCaseModal.open{display:flex}
#useCaseModal .dialog{width:min(720px,92vw);background:#fff;border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,0.12)}
#useCaseModal .row{display:flex;gap:8px}
#useCaseModal label{font-size:12px;opacity:.8}
#useCaseModal input,#useCaseModal select,#useCaseModal textarea{width:100%;padding:8px;border:1px solid rgba(0,0,0,0.15);border-radius:8px}
#useCaseModal textarea{min-height:72px}
#p1-log{width:100%;border-collapse:collapse;margin-top:8px}
#p1-log th,#p1-log td{border:1px solid rgba(0,0,0,0.12);padding:6px 8px;font-size:12px}
#p1-log th{background:rgba(0,0,0,0.04)}
@media (prefers-color-scheme: dark){
  .p1-card{background:rgba(30,30,30,0.6);border-color:rgba(255,255,255,0.08)}
  .p1-btn{background:#121212;border-color:rgba(255,255,255,0.15);color:#eaeaea}
  #useCaseModal .dialog{background:#1c1c1c;color:#eaeaea}
  #useCaseModal input,#useCaseModal select,#useCaseModal textarea{background:#121212;color:#eaeaea;border-color:rgba(255,255,255,0.16)}
  #p1-log th{background:rgba(255,255,255,0.05)}
}
</style>
<style>
.p2-wrap{margin:16px 0;padding:12px;border:1px solid rgba(0,0,0,0.1);border-radius:12px;background:rgba(255,255,255,0.6);backdrop-filter:blur(4px)}
.p2-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.p2-col{flex:1;min-width:240px}
.p2-col-2{flex:2;min-width:320px}
.p2-col-3{flex:3;min-width:420px}
.p2-label{font-size:12px;opacity:.75;margin-bottom:4px}
.p2-input,.p2-textarea,.p2-select{width:100%;padding:8px;border:1px solid rgba(0,0,0,0.15);border-radius:8px;background:#fff}
.p2-textarea{min-height:72px}
.p2-btn{display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(0,0,0,0.15);background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.p2-btn:active{transform:translateY(1px)}
.p2-list{border:1px dashed rgba(0,0,0,0.2);border-radius:10px;padding:8px}
.p2-item{display:flex;align-items:center;gap:8px;margin:6px 0}
.p2-item input[type="text"]{flex:1}
.p2-muted{font-size:12px;opacity:.7}
.p2-badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(0,0,0,0.15);font-size:12px;margin-left:6px}
.p2-hr{height:1px;background:linear-gradient(90deg,transparent,rgba(0,0,0,0.2),transparent);margin:10px 0}
@media (prefers-color-scheme: dark){
  .p2-wrap{background:rgba(30,30,30,0.6);border-color:rgba(255,255,255,0.1)}
  .p2-input,.p2-textarea,.p2-select{background:#121212;color:#eaeaea;border-color:rgba(255,255,255,0.18)}
  .p2-btn{background:#1a1a1a;color:#eaeaea;border-color:rgba(255,255,255,0.2)}
  .p2-list{border-color:rgba(255,255,255,0.25)}
}
</style>
<style>
/* a11y helpers */
.skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
.skip-link:focus{position:fixed;left:1rem;top:1rem;width:auto;height:auto;padding:.5rem .75rem;background:Canvas;color:CanvasText;z-index:10000;outline:2px solid;outline-offset:2px;border-radius:.5rem}
:focus-visible{outline:2px solid var(--focus, currentColor);outline-offset:2px}
@media (prefers-reduced-motion: reduce){
  *,*::before,*::after{animation-duration:0.001ms !important; animation-iteration-count:1 !important; transition-duration:0.001ms !important; scroll-behavior:auto !important}
}
</style><style id="aurora-visual-refresh">
/* ========= AURORA VISUAL REFRESH v1 ========= */
:root{
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 24px;
  --space-6: 32px;
  --elev-1: 0 1px 2px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.06);
  --elev-2: 0 4px 12px rgba(0,0,0,.12);
  --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}
[data-theme="light"]{
  --bg: #f7f8fb;
  --surface: #ffffff;
  --surface-2: #f4f6fb;
  --text: #0f172a;
  --muted: #64748b;
  --border: #e5e7eb;
  --primary: #6E56CF; /* Iris */
  --primary-contrast: #ffffff;
  --accent: #0ea5e9;
  --focus: #6E56CF;
}
[data-theme="dark"]{
  --bg: #0b1020;
  --surface: #11162a;
  --surface-2: #0d1326;
  --text: #e6eaf5;
  --muted: #9aa4c7;
  --border: #212a45;
  --primary: #8b7ff2; /* soft iris */
  --primary-contrast: #0b0f1f;
  --accent: #22d3ee;
  --focus: #8b7ff2;
}
html, body{
  font-family: var(--font-ui);
  color: var(--text);
  background: radial-gradient(1200px 600px at 20% -10%, rgba(142,109,255,.08), transparent 60%),
              radial-gradient(1000px 500px at 120% 10%, rgba(34,211,238,.06), transparent 60%),
              var(--bg);
  line-height: 1.55;
}
main{
  max-width: 1240px;
  margin-inline: auto;
  padding: var(--space-6) var(--space-5);
}
/* Header/Appbar */
header, .appbar{
  position: sticky; top:0; z-index: 50;
  backdrop-filter: blur(6px);
  background: color-mix(in oklab, var(--bg) 85%, transparent);
  border-bottom: 1px solid var(--border);
}
header .row, .appbar .row{ align-items: center; min-height: 56px; padding: 0 var(--space-5); }
/* Cards / Panels */
.card, .panel, .kpanel, .p1-cards > div, .p2-col, .p2-col-3, .p2-col-2 {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--elev-1);
  padding: var(--space-5);
}
/* Grid & rows */
.grid{ gap: var(--space-5); }
.row{ display:flex; gap: var(--space-4); flex-wrap: wrap; }
.col-12{ flex: 0 0 100%; }
.col-6{ flex: 0 0 calc(50% - var(--space-4)); }
/* Text & headings */
h1,h2,h3{ letter-spacing: -0.01em; }
h1{ font-size: clamp(22px, 2vw + 12px, 28px); font-weight: 700; }
h2{ font-size: clamp(18px, 1.8vw + 6px, 22px); font-weight: 650; color: var(--text); }
small, .small{ color: var(--muted); }
/* Buttons */
.btn, .p2-btn, button, [role="button"]{
  height: 40px; padding: 0 14px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  background: var(--surface-2);
  color: var(--text);
  display:inline-flex; align-items:center; gap:8px;
  transition: transform .04s ease, background .2s ease, border-color .2s ease;
}
.btn:hover, .p2-btn:hover, button:hover{ transform: translateY(-1px); background: color-mix(in oklab, var(--surface) 80%, var(--bg)); }
.btn.primary, .p2-btn.primary{ background: var(--primary); color: var(--primary-contrast); border-color: color-mix(in oklab, var(--primary), black 10%); }
.btn.ghost{ background: transparent; border-color: var(--border); }
.btn:active{ transform: translateY(0); }
/* Inputs */
input[type="text"], input[type="number"], input[type="search"], input[type="date"], textarea, select, .p2-input{
  height: 40px; padding: 0 12px;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text);
}
textarea{ min-height: 96px; padding: 10px 12px; }
/* Fields */
.field{ display:flex; flex-direction:column; gap: 6px; }
.field label, .p2-label{ font-size: 12.5px; color: var(--muted); }
/* Tabs */
.tabs, [role="tablist"]{ display:flex; gap: 8px; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
.tab, [role="tab"]{
  padding: 8px 12px; border-radius: 999px; border: 1px solid transparent;
  color: var(--muted); background: transparent;
}
[role="tab"][aria-selected="true"]{
  color: var(--primary-contrast);
  background: var(--primary);
  border-color: color-mix(in oklab, var(--primary), black 10%);
}
/* Chips/Tags */
.chip, .tag, .badge, .p2-badge{
  display:inline-flex; align-items:center; gap:6px;
  padding: 4px 10px; border-radius: 999px;
  background: color-mix(in oklab, var(--primary) 10%, var(--surface-2));
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 12.5px;
}
/* Toast */
.toast-container, .toast{
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  box-shadow: var(--elev-2);
}
/* Modal/Overlay */
.modal, .dialog, .overlay, [role="dialog"]{
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--elev-2);
}
/* Lists */
.klist li{ padding: 8px 0; border-bottom: 1px dashed var(--border); }
.klist li:last-child{ border-bottom: none; }
/* Utilities */
.spacer{ height: var(--space-5); }
.right{ margin-left:auto; }
hr, .p2-hr{ border: 0; border-top:1px solid var(--border); opacity:.7 }
code, pre{ font-family: var(--font-mono); }
a{ color: var(--accent); text-decoration-color: color-mix(in oklab, var(--accent), transparent 70%); }
a:hover{ text-decoration-color: var(--accent); }
</style>
<style id="af-skill-css">
  .af-card{margin-top:1rem;border:1px solid var(--outline, #e3e7ec);background:var(--surface, #fff);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.06);padding:16px}
  .af-row{display:grid;grid-template-columns:280px 1fr;gap:16px}
  @media (max-width:980px){.af-row{grid-template-columns:1fr}}
  .af-muted{color:var(--muted, #6b7280);font-size:.92rem}
  .af-section-title{margin:.2rem 0 .6rem;font-size:1.05rem}
  .af-field{display:flex;flex-direction:column;margin-bottom:.6rem}
  .af-field label{font-size:.85rem;color:var(--muted, #6b7280);margin-bottom:.25rem}
  .af-select,.af-input,.af-textarea{padding:.5rem .6rem;border:1px solid var(--outline,#e5e7eb);border-radius:10px;background:var(--surface,#fff);font:inherit}
  .af-chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .5rem;border-radius:999px;border:1px solid var(--outline,#e5e7eb);font-size:.78rem;color:var(--muted,#6b7280);}
  .af-table{width:100%;border-collapse:collapse}
  .af-table th,.af-table td{border:1px solid var(--outline,#e5e7eb);padding:.5rem;text-align:left;vertical-align:top}
  .af-table th{background:#f8fafc}
  .af-cp-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  @media (max-width:980px){.af-cp-list{grid-template-columns:1fr}}
  .af-cp{border:1px solid var(--outline,#e5e7eb);border-radius:10px;padding:.5rem}
  .af-flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .af-btn{padding:.55rem .85rem;border:1px solid #111827;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
  .af-btn.secondary{background:#fff;color:#111827;border-color:#111827}
  .af-btn:disabled{opacity:.6;cursor:not-allowed}
  .af-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:980px){.af-stats{grid-template-columns:1fr}}
  .af-stat{border:1px solid var(--outline,#e5e7eb);border-radius:12px;padding:12px;background:var(--surface,#fff)}
  .af-right table{margin-top:6px}
  .af-note{font-size:.82rem;color:var(--muted,#6b7280)}
</style>
<style id="dash-size-fix">
/* Stable chart sizing */
.chart-wrap { width: 100%; max-width: 100%; }
.chart-wrap canvas { width: 100% !important; height: 280px !important; display:block; }
@media (min-width: 1280px) { .chart-wrap canvas { height: 320px !important; } }
</style><link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400..700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

<style id="aurora-futurist-pack">
/* ===== AURORA FUTURIST PACK v2 (CSS-only, drop-in) ===== */
:root{
  /* Tunable FX */
  --fx-grid: rgba(255,255,255,.045);
  --fx-glow: 0 10px 30px rgba(139,127,242,.25), 0 2px 8px rgba(34,211,238,.18);
  --fx-glow-weak: 0 6px 18px rgba(139,127,242,.18);
  --fx-border: color-mix(in oklab, var(--primary) 18%, var(--border));
  --fx-border-strong: color-mix(in oklab, var(--primary) 36%, var(--border));
}

/* Background: holo grid + aurora */
html, body{ position: relative; }
body::before{
  content:""; position:fixed; inset:-20vmax; z-index:-2;
  background:
    radial-gradient(1200px 600px at 15% -10%, color-mix(in oklab, var(--primary) 25%, transparent), transparent 60%),
    radial-gradient(1000px 520px at 110% 0%, color-mix(in oklab, var(--accent) 18%, transparent), transparent 60%);
  pointer-events:none;
}
body::after{
  content:""; position:fixed; inset:0; z-index:-1; pointer-events:none;
  background:
    linear-gradient(to right, var(--fx-grid) 1px, transparent 1px) 0 0/24px 24px,
    linear-gradient(to bottom, var(--fx-grid) 1px, transparent 1px) 0 0/24px 24px;
  mask: radial-gradient(80% 60% at 50% 10%, rgba(255,255,255,.7), transparent 60%);
  -webkit-mask: radial-gradient(80% 60% at 50% 10%, rgba(255,255,255,.7), transparent 60%);
  opacity:.45;
}

/* Headlines switch to Space Grotesk for a more "future" look */
h1,h2,h3,.title{ font-family: "Space Grotesk", Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; letter-spacing: .2px; }

/* Appbar polish */
header.appbar, .appbar{
  background: color-mix(in oklab, var(--bg) 78%, transparent);
  border-bottom: 1px solid var(--fx-border);
  box-shadow: 0 6px 18px rgba(0,0,0,.18);
}
.appbar .logo{ 
  background: linear-gradient(135deg, var(--primary), var(--accent));
  filter: drop-shadow(0 4px 10px rgba(0,0,0,.25));
}

/* Cards / Panels glass effect */
.card, .panel, .kpanel, .p1-card, .p2-wrap, .dialog, .af-card, section.view {
  background: color-mix(in oklab, var(--surface) 70%, transparent);
  border: 1px solid var(--fx-border);
  backdrop-filter: blur(10px) saturate(1.08);
  -webkit-backdrop-filter: blur(10px) saturate(1.08);
  position: relative; overflow: clip;
  transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
}
.card:hover, .panel:hover, .kpanel:hover, .p1-card:hover, .p2-wrap:hover, .af-card:hover, section.view:hover{
  transform: translateY(-2px);
  border-color: var(--fx-border-strong);
  box-shadow: var(--fx-glow);
}

/* Subtle gradient top edge for depth */
.card::after, .panel::after, .kpanel::after, .p1-card::after, .p2-wrap::after, .af-card::after, section.view::after{
  content:""; position:absolute; inset:0 0 auto 0; height:2px;
  background: linear-gradient(90deg, color-mix(in oklab, var(--primary) 45%, transparent), transparent, color-mix(in oklab, var(--accent) 40%, transparent));
  opacity:.6;
}

/* Tabs = segmented control */
.tabs, [role="tablist"]{
  background: color-mix(in oklab, var(--surface) 70%, transparent);
  border: 1px solid var(--fx-border);
  border-radius: 14px;
  padding: 6px;
  box-shadow: var(--fx-glow-weak);
}
.tab, [role="tab"]{
  background: transparent; border: 1px solid transparent; border-radius: 999px;
  padding: 8px 12px; color: var(--muted);
  transition: background .15s ease, color .15s ease, border-color .15s ease, transform .12s ease;
}
.tab:hover, [role="tab"]:hover{ transform: translateY(-1px); }
.tab[aria-selected="true"], [role="tab"][aria-selected="true"]{
  color: var(--primary-contrast);
  background: linear-gradient(90deg, var(--primary), var(--accent));
  border-color: color-mix(in oklab, var(--primary) 60%, black 10%);
  box-shadow: 0 6px 18px color-mix(in oklab, var(--primary) 30%, transparent);
}

/* Buttons */
.btn, .p2-btn, button, [role="button"]{
  border-color: var(--fx-border);
  background: color-mix(in oklab, var(--surface) 75%, transparent);
  transition: transform .12s ease, background .2s ease, box-shadow .2s ease, border-color .2s ease;
}
.btn:hover, .p2-btn:hover, button:hover{ transform: translateY(-1px); border-color: var(--fx-border-strong); }
.btn.primary, .p2-btn.primary{
  background: linear-gradient(90deg, var(--primary), var(--accent));
  color: var(--primary-contrast);
  border-color: color-mix(in oklab, var(--primary) 50%, black 10%);
  box-shadow: var(--fx-glow);
}

/* Inputs */
input[type="text"], input[type="number"], input[type="search"], input[type="date"], textarea, select, .p2-input, .p2-textarea, .p2-select{
  background: color-mix(in oklab, var(--surface-2) 85%, transparent);
  border: 1px solid var(--fx-border);
  transition: box-shadow .15s ease, border-color .15s ease, background .2s ease;
}
input:focus, textarea:focus, select:focus{
  outline: none;
  border-color: var(--fx-border-strong);
  box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary) 35%, transparent);
}

/* Chips/Tags */
.chip, .tag, .badge, .p2-badge{
  background: color-mix(in oklab, var(--primary) 12%, var(--surface-2));
  border-color: var(--fx-border);
}

/* Tiny polish */
hr, .p2-hr{ border-top-color: var(--fx-border); }
.muted, .small{ color: color-mix(in oklab, var(--muted) 92%, var(--text)); }

/* Improve charts container contrast without touching Chart.js */
.chart-wrap canvas{ filter: drop-shadow(0 6px 16px rgba(0,0,0,.18)); }
</style>


<style id="cp-tab-css">
/* === 24CP Tab tweaks === */
#cpSec.view{ padding-top: 8px; }
#cpSec .af-card{ margin-top: 8px; }
</style>


<style id="theme-dark-fix">
/* === Dark-friendly overrides for legacy #fff backgrounds === */
.p1-btn, .p2-btn {
  background: color-mix(in oklab, var(--surface, #0f172a) 78%, transparent) !important;
  color: var(--text, #e5e7eb) !important;
  border-color: var(--border, rgba(255,255,255,.14)) !important;
}
.p2-input, .p2-textarea, .p2-select, input[type="text"], input[type="number"], input[type="search"], input[type="date"], textarea, select {
  background: color-mix(in oklab, var(--surface-2, #0b1022) 88%, transparent) !important;
  color: var(--text, #e5e7eb) !important;
  border-color: var(--border, rgba(255,255,255,.14)) !important;
}
#useCaseModal .dialog{
  background: color-mix(in oklab, var(--surface, #0f172a) 92%, transparent) !important;
}
.af-btn.secondary{
  background: color-mix(in oklab, var(--surface, #0f172a) 80%, transparent) !important;
  color: var(--text, #e5e7eb) !important;
  border-color: var(--border, rgba(255,255,255,.14)) !important;
}
/* Chips & badges from older theme */
.badge, .chip, .tag {
  background: color-mix(in oklab, var(--primary, #7c3aed) 12%, var(--surface-2, #0b1022)) !important;
  border-color: var(--border, rgba(255,255,255,.14)) !important;
}
/* Table header legibility */
table thead th{
  color: var(--muted-contrast, #e5e7eb);
  background: color-mix(in oklab, var(--surface, #0f172a) 86%, transparent) !important;
}
</style>


<style id="af-table-dark">
/* Dark theme for detail table "Chi tiết kỹ năng" */
.af-table th{
  background: color-mix(in oklab, var(--surface, #0f172a) 90%, transparent) !important;
  color: var(--text, #e5e7eb) !important;
  border-color: var(--border, rgba(255,255,255,.14)) !important;
}
.af-table td{
  background: color-mix(in oklab, var(--surface-2, #0b1022) 82%, transparent) !important;
  color: var(--text, #e5e7eb) !important;
  border-color: var(--border, rgba(255,255,255,.14)) !important;
}
</style>


<style id="operate-dock-css">
/* === Operate Dock (24CP) === */
#operateDock{
  position: sticky; bottom: -1px; z-index: 50;
  background: color-mix(in oklab, var(--surface,#0f172a) 96%, transparent);
  border: 1px solid var(--border, rgba(255,255,255,.14));
  border-radius: 14px;
  padding: 10px;
  margin-top: 10px;
  display: grid;
  gap: 10px;
}
@media (min-width: 960px){
  #operateDock{ grid-template-columns: 1fr auto auto auto; align-items: center; }
}
#opSkill{ font-weight: 700; }
#cpSelect{ min-width: 220px; }
#timerView{ font-variant-numeric: tabular-nums; font-weight: 800; }
#dockBtns .btn{ height: 34px; }
.smallnote{ font-size: .82rem; opacity: .75; }
</style>

<style id="operate-dock-clock-css">
/* ==== Ticking Clock (always-on) ==== */
.timer-block{ display:flex; align-items:center; gap:10px; }
#clockFace{
  position: relative; width: 42px; height: 42px; border-radius: 999px;
  border: 1px solid var(--border, rgba(255,255,255,.14));
  background:
    radial-gradient(circle at 50% 50%, rgba(255,255,255,.06), transparent 60%) ,
    radial-gradient(10px 10px at 50% 50%, rgba(0,0,0,.2), transparent 70%);
  box-shadow: inset 0 0 10px rgba(0,0,0,.2);
  flex: 0 0 auto;
}
#clockFace::before{
  content:""; position:absolute; inset:0; border-radius:999px;
  background:
    repeating-conic-gradient(from 0deg, rgba(255,255,255,.18) 0 2deg, transparent 2deg 6deg);
  mask: radial-gradient(circle at 50% 50%, transparent 0 34%, #000 34% 100%);
  -webkit-mask: radial-gradient(circle at 50% 50%, transparent 0 34%, #000 34% 100%);
  opacity:.55;
}
#secondHand{
  position:absolute; left:50%; top:50%;
  width: 2px; height: 18px; background: color-mix(in oklab, var(--primary,#8b7ff2) 88%, #fff);
  transform-origin: 50% 100%; translate: -50% -100%; border-radius: 2px;
  box-shadow: 0 0 6px color-mix(in oklab, var(--primary,#8b7ff2) 50%, transparent);
}
#centerDot{
  position:absolute; left:50%; top:50%; width:6px; height:6px;
  translate:-50% -50%; border-radius:999px;
  background: color-mix(in oklab, var(--accent,#22d3ee) 80%, #fff);
  box-shadow: 0 0 8px color-mix(in oklab, var(--accent,#22d3ee) 40%, transparent);
}
#clockTime{ font-family: "Space Grotesk", Inter, system-ui; font-weight: 800; letter-spacing: .5px; }
#clockTime .colon{ opacity:.8; animation: blink 1s steps(1,end) infinite; }
@keyframes blink { 50% { opacity:.2; } }
#sessionView{ font-variant-numeric: tabular-nums; opacity:.85; font-weight: 600; }
</style>


<style id="cp-cleanup-css">
/* ========== 24CP Clean Mode ========== */
#afFilters{ border:1px solid var(--border, rgba(255,255,255,.14)); border-radius:12px; padding:0 10px; background: color-mix(in oklab, var(--surface,#0f172a) 92%, transparent); }
#afFilters > summary{ padding:10px 6px; cursor:pointer; list-style:none; font-weight:600; }
#afFilters[open]{ box-shadow: 0 6px 18px rgba(0,0,0,.18); }
#afFiltersGrid{ display:grid; gap:8px; padding: 0 0 10px 0; }
@media (min-width: 960px){ #afFiltersGrid{ grid-template-columns: 1fr 1fr 1fr; } }
.af-hide{ display:none !important; }
</style>


<style id="mobile-fix-v1">
/* ===== MOBILE-FIX v1 (<=480px) ===== */
@media (max-width: 480px){
  html, body{ overflow-x:hidden; overscroll-behavior-y:none; }
  main{ padding: 0 12px !important; }
  header.appbar .appbar-inner, header .row{ padding:8px 12px !important; }
  /* Tabs → horizontal scroll */
  .tabs, [role="tablist"]{ display:flex !important; overflow-x:auto; gap:8px; padding-bottom:6px; scrollbar-width:none; }
  .tabs::-webkit-scrollbar, [role="tablist"]::-webkit-scrollbar{ display:none; }
  .tab, [role="tab"]{ flex:0 0 auto; }
  /* Single-column grid */
  .grid{ display:grid; grid-template-columns:1fr !important; }
  .col-12, .col-6, .col-4{ grid-column: 1 / -1 !important; }
  /* Cards & spacing */
  .card, .panel, .kpanel, .p1-card, .p2-wrap, .af-card, section.view{
    padding:12px !important; border-radius:12px !important;
  }
  .row{ gap:8px !important; }
  /* Flexible columns in P2 */
  .p2-row{ flex-direction:column !important; }
  .p2-col, .p2-col-2, .p2-col-3{ min-width:0 !important; flex:1 1 100% !important; width:100% !important; }
  /* Inputs: prevent iOS zoom */
  input[type="text"], input[type="number"], input[type="search"], input[type="date"],
  textarea, select, .p2-input, .p2-textarea, .p2-select{ font-size:16px !important; }
  /* Dialogs & modals */
  .modal .dialog, .dialog{ width:96vw !important; max-width:96vw !important; padding:12px !important; }
  /* Charts a bit shorter on phones */
  .chart-wrap canvas{ height:200px !important; }
  /* Tables: scroll instead of overflow */
  table{ display:block; max-width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
}
/* ===== MOBILE-FIX v2 (<=360px) tighten a bit more ===== */
@media (max-width: 360px){
  h1{ font-size:18px !important; }
  h2{ font-size:16px !important; }
  .btn, button{ height:36px !important; padding:0 10px !important; }
}
</style>

</head>
<body><a class="skip-link" href="#main">Bỏ qua đến nội dung chính</a>
<script id="CP_DATA" type="application/json">
{
  "generated_at": "2025-08-11",
  "skills": [
    {
      "k": "K1",
      "name": "Tiếng Anh chiến lược",
      "criticalPoints": [
        "Chuẩn bị 3–5 cụm từ chủ lực theo ngữ cảnh trước cuộc thoại/viết",
        "Giảm 5–10% tốc độ nói ở đoạn chốt ý; nhấn nhịp cuối câu",
        "Mỗi đoạn/turn có một one-liner ≤12 từ để neo thông điệp",
        "Dùng kỹ thuật bridge→message khi bị hỏi khó để quay về trục chính",
        "Kết thúc bằng call-to-action rõ ràng, kiểm tra người nghe nhắc lại đúng ý"
      ],
      "drills": [
        "Shadowing 5 phút/ngày với một mẫu thoại theo chủ đề",
        "Viết 3 one-liners/ngày cho cùng một thông điệp theo 3 tông giọng"
      ],
      "success": "≥3 cuộc thoại/tuần có CTA; ≥80% người nghe lặp lại đúng key message",
      "evidence": [
        "Ghi âm 1–3 phút cuộc thoại",
        "Bản nháp one-liner và CTA dùng thực tế"
      ],
      "antiPatterns": [
        "Dài dòng, không có câu neo; chạy theo câu hỏi mà mất trục",
        "Lạm dụng từ vựng hiếm gây nhiễu hiểu"
      ]
    },
    {
      "k": "K2",
      "name": "Tiếng Trung chiến lược",
      "criticalPoints": [
        "Chuẩn hóa thuật ngữ ngành theo 2 chiều (ZH↔VN/EN) trước buổi dịch",
        "Dịch ý trước dịch chữ; bảo toàn mục tiêu quan hệ (face-saving)",
        "Đặt buffer 1 nhịp trước phát ngôn nhạy cảm để kiểm lại dụng ý",
        "Chèn cụm đệm văn hóa để mềm hoá xung đột (礼貌/缓冲)",
        "Kết bằng công thức ‘đồng thuận tối thiểu + bước tiếp theo’"
      ],
      "drills": [
        "Dịch 2 chiều 3 đoạn ngắn/ngày theo cùng chủ đề",
        "Viết 5 cặp cụm đệm văn hoá và tình huống sử dụng"
      ],
      "success": "0 lỗi ‘mất mặt’; ≥2 lần tái diễn đạt giúp làm rõ ý trong mỗi phiên dịch dài",
      "evidence": [
        "Bản dịch đôi (song ngữ) có đánh dấu lựa chọn dịch ý",
        "Audio/clip minh họa 60–90s"
      ],
      "antiPatterns": [
        "Bám chữ bỏ ý; bỏ qua yếu tố thể diện",
        "Chuyển ngữ thô gây cứng không khí"
      ]
    },
    {
      "k": "K3",
      "name": "Kinh tế học thực chiến",
      "criticalPoints": [
        "Xác định bộ 3 chỉ báo vĩ mô cốt lõi cho bối cảnh (ví dụ: CPI, lãi suất, tăng trưởng)",
        "Tách nhiễu tin tức: chỉ lấy nguồn sơ cấp và chuỗi thời gian ≥24 tháng",
        "Lập luận bằng causal chain 3–5 mắt xích, nêu giả định rõ ràng",
        "Đưa 2 kịch bản (base/bear hoặc base/bull) và trigger chuyển pha",
        "Chốt quyết định bằng nguyên tắc position sizing và điểm vô hiệu (invalidation)"
      ],
      "drills": [
        "Viết 1 trang ‘macro snapshot’/tuần cho một nền kinh tế",
        "Backtest 1 giả thuyết bằng dữ liệu lịch sử đơn giản"
      ],
      "success": "Báo cáo 1 trang có causal chain + hai kịch bản + trigger; quyết định gắn với sizing",
      "evidence": [
        "Bảng chỉ báo 1 trang",
        "Đồ thị chuỗi thời gian kèm ghi chú giả định"
      ],
      "antiPatterns": [
        "Nhặt headline ngắn hạn; kết luận không nêu giả định",
        "Một kịch bản duy nhất, không trigger"
      ]
    },
    {
      "k": "K4",
      "name": "Tài chính – Đầu tư cá nhân",
      "criticalPoints": [
        "Ghi chép dòng tiền thực tế ≥30 ngày; phân nhóm chi tiêu theo 3 tầng (cốt lõi/đòn bẩy/xa xỉ)",
        "Thiết lập quỹ dự phòng ≥3–6 tháng chi phí thiết yếu",
        "Quy tắc phân bổ: core (index/cashflow)/satellite (alpha) có tỷ lệ rõ ràng",
        "Mỗi quyết định đầu tư phải có thesis 3 câu + tiêu chí thoát (profit/loss)",
        "Tối thiểu hoá phí và thuế; kiểm bảng phí định kỳ"
      ],
      "drills": [
        "Cập nhật sổ dòng tiền hàng ngày (5 phút)",
        "Viết 1 investment memo ngắn/tuần cho 1 ý tưởng"
      ],
      "success": "Tuân thủ ngân sách 4 tuần; portfolio có phân bổ core/satellite; mỗi vị thế có điểm thoát",
      "evidence": [
        "Bảng dòng tiền 30 ngày",
        "Investment memo 1 trang"
      ],
      "antiPatterns": [
        "Mua theo cảm xúc; không có điểm thoát",
        "Chi phí chìm/đòn bẩy ẩn không kiểm"
      ]
    },
    {
      "k": "K5",
      "name": "Luật thực chiến",
      "criticalPoints": [
        "Xác định khung pháp lý áp dụng và điều khoản trọng yếu trước giao dịch/hành động",
        "Thu thập và lưu bằng chứng có trình tự, timestamp, chain-of-custody",
        "Viết tóm tắt case ≤10 dòng: sự kiện, căn cứ, yêu cầu, rủi ro",
        "Áp dụng nguyên tắc im lặng chiến lược khi chưa đủ thông tin/đại diện",
        "Chọn chiến lược ‘ngoại giao trước – pháp lý sau’ khi có lợi cho kết quả"
      ],
      "drills": [
        "Soạn checklist bằng chứng cho 1 tình huống giả định",
        "Phân tích 1 hợp đồng, đánh dấu 5 điều khoản rủi ro"
      ],
      "success": "Hồ sơ case có log bằng chứng hoàn chỉnh; brief 10 dòng; phương án xử lý có thứ tự ưu tiên",
      "evidence": [
        "Checklist bằng chứng",
        "Brief 10 dòng + scan điều khoản"
      ],
      "antiPatterns": [
        "Phát ngôn cảm tính công khai",
        "Thu thập chứng cứ không bảo toàn tính hợp lệ"
      ]
    },
    {
      "k": "K6",
      "name": "Kinh doanh – Thị trường",
      "criticalPoints": [
        "Xác định job-to-be-done và phân khúc hẹp đủ đau",
        "Đề xuất giá trị 1 câu, kiểm bằng 5 cuộc phỏng vấn khách hàng",
        "Thiết kế funnel tối giản (awareness→activation→retention) với một metric chủ",
        "Chạy thử offer nhỏ (smoke test) trước khi build",
        "Đo NPS/qualitative feedback sau mỗi vòng lặp để chỉnh định vị"
      ],
      "drills": [
        "5 cuộc phỏng vấn khách hàng/tuần theo script",
        "Thiết kế một landing smoke test và đo chuyển đổi"
      ],
      "success": "Value prop rõ, có số liệu smoke test; funnel có metric; vòng lặp feedback→sửa định vị",
      "evidence": [
        "Biên bản phỏng vấn",
        "Số liệu chuyển đổi landing"
      ],
      "antiPatterns": [
        "Build trước hỏi sau; sản phẩm ‘cho tất cả’",
        "Chạy nhiều kênh nhưng không có metric chủ"
      ]
    },
    {
      "k": "K7",
      "name": "Tâm lý học chiến lược",
      "criticalPoints": [
        "Spot 3 vi tín hiệu cảm xúc trước khi phản hồi (mắt/giọng/tư thế)",
        "Thực hiện nhịp thở 4-2-4 để hạ phản xạ tức thì",
        "Dùng ‘label cảm xúc’ 1 câu để giải áp",
        "Không trả lời câu hỏi nhạy cảm trong 2–3 nhịp đầu; chuyển hướng mềm",
        "Đóng bằng ‘rút nhịp’ (không đóng tròn) để tránh leo thang"
      ],
      "drills": [
        "Quan sát 2 người/ngày và ghi 3 tín hiệu mỗi người",
        "Luyện 3 kịch bản label cảm xúc trong 60 giây"
      ],
      "success": "Giảm xung đột thấy rõ; đối tượng tự hạ giọng ≥50% tình huống",
      "evidence": [
        "Log quan sát",
        "Ghi âm đối thoại ngắn"
      ],
      "antiPatterns": [
        "Khuyên sớm; phản xạ tức thì",
        "Gán nhãn xúc phạm thay vì label trung tính"
      ]
    },
    {
      "k": "K8",
      "name": "AI – IT ứng dụng",
      "criticalPoints": [
        "Chuẩn hóa template prompt/workflow; lưu version kèm mục tiêu và giới hạn",
        "Thiết lập quy trình backup/snapshot định kỳ và thử restore",
        "Đặt chuẩn đặt tên file/dự án và log thay đổi",
        "Chọn công cụ theo tiêu chí ‘đáp đúng bài toán’ thay vì chạy theo trend",
        "Thiết kế cảnh báo sớm khi pipeline lỗi hoặc dữ liệu lệch"
      ],
      "drills": [
        "Tạo 1 snapshot/tuần và thử restore",
        "Viết 1 trang SOP cho một workflow AI/IT bạn dùng"
      ],
      "success": "Workflow có SOP; khôi phục trong ≤10 phút; tỉ lệ lỗi giảm và được log rõ",
      "evidence": [
        "SOP 1 trang",
        "Log snapshot/restore"
      ],
      "antiPatterns": [
        "Đổi công cụ liên tục; không có chuẩn đặt tên",
        "Không test khôi phục"
      ]
    },
    {
      "k": "K9",
      "name": "Y học – Sinh học – Thân thể",
      "criticalPoints": [
        "Theo dõi 3 chỉ báo: giấc ngủ, vận động, dinh dưỡng (hoặc nhịp tim/HRV)",
        "Áp dụng thở 4-7-8 và đi bộ sáng 20 phút",
        "Giữ cửa sổ ăn cố định; ưu tiên protein và chất xơ",
        "Log mức mệt 0–10; điều chỉnh tải công việc theo chu kỳ",
        "Tín hiệu đỏ: đau kéo dài/giấc ngủ <6h/HRV giảm nhiều → kích hoạt hồi phục"
      ],
      "drills": [
        "1 phiên thở + 20’ đi bộ/ngày",
        "Chuẩn bị suất ăn chuẩn hoá 2–3 ngày/lần"
      ],
      "success": "Mệt giảm ≥2 điểm sau 2 tuần; chỉ báo ổn định hơn; ít crash",
      "evidence": [
        "Bảng chỉ báo",
        "Ảnh/ghi chú bữa ăn & vận động"
      ],
      "antiPatterns": [
        "Bù bằng caffeine/đường; bỏ ngủ",
        "Tập nặng khi đang thiếu hồi phục"
      ]
    },
    {
      "k": "K10",
      "name": "Triết học – Logic – Phản tư",
      "criticalPoints": [
        "Vẽ sơ đồ nhân quả 5 nút cho vấn đề chính",
        "Viết định nghĩa vấn đề 1 câu (không dài hơn 20 từ)",
        "Áp dụng tam đoạn luận hoặc quy tắc phủ định để kiểm luận",
        "Tạo counter-example để phá ảo tưởng xác nhận",
        "Đặt stop rule: tiêu chí dừng phân tích để ra quyết định"
      ],
      "drills": [
        "1 sơ đồ/tuần cho một quyết định quan trọng",
        "Viết premiss-conclusion 3 ví dụ/ngày"
      ],
      "success": "Quyết định ≤24h với premiss rõ; giảm vòng lặp suy diễn",
      "evidence": [
        "Ảnh sơ đồ",
        "Note premiss/conclusion"
      ],
      "antiPatterns": [
        "Overthinking không dừng",
        "Trộn cảm xúc vào luận lý"
      ]
    },
    {
      "k": "K11",
      "name": "Chính trị – Quyền lực – Địa chính trị",
      "criticalPoints": [
        "Vẽ bản đồ tác nhân/quyền lực (stakeholder map) cho bối cảnh",
        "Xác định trục quyền, lợi ích, đòn bẩy và ranh giới đỏ",
        "Không đụng công khai khi chưa có kênh/đòn bẩy tương xứng",
        "Dùng phản chiếu để lộ mâu thuẫn nội hệ thay vì đối đầu trực diện",
        "Giữ hồ sơ liên lạc/bằng chứng cho mọi trao đổi nhạy cảm"
      ],
      "drills": [
        "Lập 1 stakeholder map/tuần cho một bối cảnh",
        "Viết 2 kịch bản can thiệp gián tiếp và điều kiện kích hoạt"
      ],
      "success": "Giảm xung đột công khai; đạt nhượng bộ qua kênh phù hợp",
      "evidence": [
        "Sơ đồ tác nhân",
        "Biên bản liên lạc có timestamp"
      ],
      "antiPatterns": [
        "Tuyên chiến công khai không lực",
        "Bỏ hồ sơ bằng chứng"
      ]
    },
    {
      "k": "K12",
      "name": "Tâm linh chiến lược – khí – nghiệp",
      "criticalPoints": [
        "Khoanh vùng nguồn nhiễu (người/đồ vật/thói quen) và đánh dấu ‘cắt’",
        "Thiết lập vệ sinh năng lượng: ngủ, ánh sáng, môi trường thông thoáng",
        "Thực hành tách-bám cảm xúc: quan sát hơi thở 2 phút trước phản ứng",
        "Đóng van: ngừng tiếp xúc/tương tác ở kênh gây rút khí trong 7 ngày",
        "Rút sạch: ritual đơn giản (dọn, tắm, ghi chép, đốt bỏ) để tái lập trục"
      ],
      "drills": [
        "7-day cleanse: loại 1 nguồn rút khí",
        "Thực hành 2 phút quan sát hơi thở trước 3 tình huống"
      ],
      "success": "Giảm nhiễu rõ rệt; không tái tiếp xúc vô thức; giấc ngủ/nhịp sống ổn",
      "evidence": [
        "Checklist nguồn nhiễu & trạng thái trước-sau",
        "Nhật ký 7 ngày"
      ],
      "antiPatterns": [
        "Ritual phức tạp không bền",
        "Cắt chưa dứt, tái nghiện kênh"
      ]
    },
    {
      "k": "K13",
      "name": "Sinh tồn – thực chiến nội tại",
      "criticalPoints": [
        "Danh mục tối thiểu sinh tồn (nước, thực phẩm, y tế, liên lạc) và vị trí",
        "Thiết lập chế độ tối thiểu: ngủ, ăn, vệ sinh, nhịp di chuyển an toàn",
        "Kịch bản mất hệ: 3 điểm hẹn, 2 kênh liên lạc, 1 người phụ trách",
        "Tập phản xạ ẩn thân: giảm phát xạ (ánh sáng/âm thanh/dấu vết)",
        "Giữ log quyết định ngắn để chống hoảng loạn"
      ],
      "drills": [
        "Diễn tập 30 phút ‘mất điện/mất mạng’ mỗi tuần",
        "Chuẩn bị túi 72h và kiểm tra hàng tháng"
      ],
      "success": "Thực hiện kịch bản trong ≤30 phút; duy trì chế độ tối thiểu 72h",
      "evidence": [
        "Checklist 72h",
        "Video/ảnh diễn tập"
      ],
      "antiPatterns": [
        "Mang thừa đồ không thiết yếu",
        "Không luyện ẩn thân mà chỉ tích đồ"
      ]
    },
    {
      "k": "K14",
      "name": "Mỹ học – nghệ thuật",
      "criticalPoints": [
        "Xác định palette 3 màu trụ và 1 điểm nhấn",
        "Chọn 2–3 pose/tư thế chốt phù hợp thân thể",
        "Ánh sáng một hướng; dọn nền nhiễu",
        "Rule bỏ bớt 10% chi tiết trước khi chụp/xuất bản",
        "Đưa 1 motif lặp để tạo nhận diện"
      ],
      "drills": [
        "1 ảnh/ngày theo palette; 1 lần soi gương 2’/pose",
        "Chụp cùng cảnh với 2 ánh sáng để học đối sánh"
      ],
      "success": "7/10 ảnh đạt tiêu chí ‘sạch/điềm’; có nhận diện motif rõ",
      "evidence": [
        "Album 10 ảnh/tuần",
        "Ghi chú pose và ánh sáng"
      ],
      "antiPatterns": [
        "Tham chi tiết/phụ kiện",
        "Nền lộn xộn gây nhiễu"
      ]
    },
    {
      "k": "K15",
      "name": "Ngôn từ – giao tiếp – phản xạ",
      "criticalPoints": [
        "Chuẩn bị 5 one-liners 12 từ cho 5 kịch bản khó",
        "Giữ nhịp ngắt 0.5–1.0s trước câu ‘đòn chốt’",
        "Không biện minh; trả lời bằng câu hỏi chốt mục tiêu",
        "Chừa cửa thoát thể diện cho đối phương để hạ nhiệt",
        "Kết bằng thông điệp hành động hoặc im lặng chiến lược"
      ],
      "drills": [
        "Viết 3 one-liners/ngày",
        "Luyện ngắt nhịp 60s trước gương/ghi âm"
      ],
      "success": "Đối phương tự dừng/chuyển chủ đề; không leo thang tranh cãi",
      "evidence": [
        "Transcript/ghi âm",
        "Bộ one-liners theo kịch bản"
      ],
      "antiPatterns": [
        "Mỉa mai/công kích; nói dài",
        "Lộ cảm xúc khi ‘đòn chốt’"
      ]
    },
    {
      "k": "K16",
      "name": "Sản xuất nội dung – thương hiệu",
      "criticalPoints": [
        "Cấu trúc ‘case → insight → khuyến nghị’ trong mỗi bài",
        "Một câu ‘điểm khác biệt’ (USP) rõ ràng",
        "Giữ giọng tỉnh/điềm; tránh cầu xin công nhận",
        "CTA cụ thể; theo dõi phản hồi và điều chỉnh",
        "Dùng 1 ảnh/biểu đồ minh họa mang thông điệp"
      ],
      "drills": [
        "Viết 1 micro-case/tuần",
        "Biên tập 1 bài cũ theo cấu trúc mới"
      ],
      "success": "≥1 phản hồi ‘giúp ích’/bài; tỉ lệ đọc >50% với tệp mục tiêu",
      "evidence": [
        "Link bài + phản hồi",
        "Ảnh/biểu đồ đính kèm"
      ],
      "antiPatterns": [
        "Kể lể; thiếu kết luận",
        "Phô trương, xin công nhận"
      ]
    },
    {
      "k": "K17",
      "name": "Làm chủ gene – phản xạ sinh học",
      "criticalPoints": [
        "Theo dõi chu kỳ dài: ngủ, năng lượng, hiệu suất 12 tuần",
        "Nhận diện lệch lặp (crash/chậm hồi) và yếu tố kích hoạt",
        "Thử 1 can thiệp/chu kỳ (ánh sáng/giấc ngủ/nhịp ăn) và đo đáp ứng",
        "Khóa thói quen rút khí ít nhất 2 tuần trước can thiệp tiếp",
        "Đặt ngưỡng cảnh báo khi lệch ra khỏi dải bình thường"
      ],
      "drills": [
        "Log 3 chỉ báo/ngày trong 12 tuần",
        "Thiết kế A/B 1 can thiệp trong 2 tuần"
      ],
      "success": "Cải thiện chỉ báo ≥10–20% sau chu kỳ; duy trì thói quen khoá",
      "evidence": [
        "Biểu đồ chu kỳ 12 tuần",
        "Plan can thiệp + kết quả"
      ],
      "antiPatterns": [
        "Đổi can thiệp liên tục",
        "Không có số liệu nền tảng"
      ]
    },
    {
      "k": "K18",
      "name": "Rewire hành vi – thay máu tiềm thức",
      "criticalPoints": [
        "Nhận diện trigger → cảm xúc → hành vi → hậu quả",
        "Thiết kế thói quen thay thế và ‘hộp cát’ luyện an toàn",
        "Làm chậm vòng lặp bằng cue/nhắc ẩn trong môi trường",
        "Tự thưởng nhỏ khi hoàn thành thay thế; phạt nhẹ khi tái phát",
        "Tổng kết tuần: giữ/loại trigger; cập nhật kế hoạch"
      ],
      "drills": [
        "Ghi 3 vòng lặp/ngày trong 7 ngày",
        "Thiết lập 1 cue môi trường và test 1 tuần"
      ],
      "success": "Giảm tần suất hành vi cũ ≥50% sau 4 tuần; có thói quen thay thế ổn",
      "evidence": [
        "Bảng vòng lặp",
        "Ảnh/cue môi trường & log tuần"
      ],
      "antiPatterns": [
        "Kỳ vọng ‘hết ngay’; tự phạt nặng gây bỏ cuộc"
      ]
    },
    {
      "k": "K19",
      "name": "Thiết kế hệ – hệ thống hoá",
      "criticalPoints": [
        "Vẽ canvas hệ 1 trang: mục tiêu, module sáng/chiều/đêm, luồng vào–ra",
        "Xác định trigger cho từng module; đặt fallback khi quá tải",
        "Đo bằng 1 metric/module; review theo tuần",
        "Tự động hoá điểm lặp (nhắc/templating)",
        "Retrospective tuần: giữ/bỏ/sửa module"
      ],
      "drills": [
        "Vẽ canvas hệ và áp dụng 1 tuần",
        "Tự động hoá 1 module lặp (nhắc/biểu mẫu)"
      ],
      "success": "Không vỡ hệ khi bận; hoàn thành 2 mục tiêu/tuần ổn định",
      "evidence": [
        "Canvas + log tuần",
        "Ảnh nhắc/biểu mẫu tự động"
      ],
      "antiPatterns": [
        "Nhồi mục tiêu; thiếu fallback",
        "Đổi hệ liên tục"
      ]
    },
    {
      "k": "K20",
      "name": "Siêu ghi nhớ – Meta-learning",
      "criticalPoints": [
        "Gắn khung học: mục tiêu, phạm vi, tiêu chí ‘đủ giỏi’",
        "Tạo bộ thẻ/biểu mẫu ‘truy xuất nhanh’ (spaced repetition/one-pager)",
        "Luyện chia nhỏ kỹ năng và deliberate practice 20–40 phút",
        "Phản hồi nhanh: kiểm thử nhỏ sau mỗi buổi học",
        "Ghép kiến thức vào bối cảnh sử dụng thực tế"
      ],
      "drills": [
        "Tạo one-pager cho một chủ đề/tuần",
        "Luyện 2 phiên deliberate practice 25’/tuần"
      ],
      "success": "Áp dụng kiến thức trong 1 tình huống thực; điểm kiểm tra nhỏ đạt chuẩn",
      "evidence": [
        "One-pager",
        "Log thực hành + kết quả kiểm thử"
      ],
      "antiPatterns": [
        "Đọc nhiều không ôn; không kiểm thử",
        "Học vô bối cảnh"
      ]
    },
    {
      "k": "K21",
      "name": "Phân tích dữ liệu – chiến lược số",
      "criticalPoints": [
        "Đặt câu hỏi tốt (decision question) trước khi kéo dữ liệu",
        "Vẽ sơ đồ dữ liệu; xác định metric 1 trang và baseline",
        "Xử lý missing/outlier theo quy tắc đã định",
        "Mỗi biểu đồ chỉ truyền 1 thông điệp; ghi chú kết luận ngay trên đồ thị",
        "Hậu kiểm quyết định sau 1–2 tuần với cùng metric"
      ],
      "drills": [
        "Làm 1 trang metric cho 1 quyết định/tuần",
        "Tạo 1 dashboard nhỏ và ghi kết luận trên chart"
      ],
      "success": "Quyết định có baseline + hậu kiểm; thông điệp chart rõ ràng",
      "evidence": [
        "Trang metric",
        "Ảnh dashboard + note"
      ],
      "antiPatterns": [
        "Chart đẹp nhưng không trả lời câu hỏi",
        "Kéo dữ liệu trước khi đặt câu hỏi"
      ]
    },
    {
      "k": "K22",
      "name": "Soft networking – kết nối tầng cao",
      "criticalPoints": [
        "Định nghĩa ‘điểm sáng’ cá nhân 1 câu (giá trị độc đáo)",
        "Chọn nhịp xuất hiện đều thay vì bùng nổ",
        "Trao giá trị cụ thể trước; follow-up trong 24–48h",
        "Không xin công nhận; giữ giọng tỉnh, tự tại",
        "Bảo trì sổ liên hệ: ghi mục tiêu/giá trị – lịch sử tương tác"
      ],
      "drills": [
        "1 kết nối/tuần với follow-up rõ",
        "Viết 3 mẫu mở đầu/giới thiệu bản thân 1 câu"
      ],
      "success": "≥1 cuộc hẹn sâu/2 tuần; kết nối tự đến theo nhịp xuất hiện",
      "evidence": [
        "Danh sách liên hệ + log follow-up",
        "Mẫu mở đầu 1 câu"
      ],
      "antiPatterns": [
        "Spam, nói quá, bám víu",
        "Xuất hiện thất thường ‘bùng rồi tắt’"
      ]
    },
    {
      "k": "K23",
      "name": "Điều phối cảm xúc – hơi thở",
      "criticalPoints": [
        "Chọn kỹ thuật thở phù hợp mục tiêu (4-7-8, box, resonance)",
        "Gắn thở với cue: trước họp, sau xung đột, trước khi chốt câu nói",
        "Kết hợp âm thanh/nhạc nền để dẫn tần cảm xúc",
        "Ghi nhận cảm giác cơ thể; không ép, chỉ dẫn nhịp",
        "Đánh dấu hiệu quả sau phiên (cảm xúc, nhịp tim nếu có)"
      ],
      "drills": [
        "2 phiên thở có cue/ngày (2–5 phút)",
        "Playlist 3 track cho 3 trạng thái mục tiêu"
      ],
      "success": "Chuyển trạng thái cảm xúc theo mục tiêu trong ≤3 phút",
      "evidence": [
        "Log phiên thở",
        "Playlist + ghi chú trạng thái"
      ],
      "antiPatterns": [
        "Thực hiện ‘gồng’/quá sức",
        "Không có cue rõ ràng"
      ]
    },
    {
      "k": "K24",
      "name": "Thời đại – địa hình – không lệch vận",
      "criticalPoints": [
        "Xác định chu kỳ lớn liên quan (công nghệ, địa chính trị, nhân khẩu)",
        "Đọc ‘địa hình’ ngành/nghề: thế đẩy, thế hút, vùng trũng",
        "Chọn trục cá nhân dài hạn (10 năm) phù hợp chu kỳ",
        "Đặt chiến lược gài lực nhỏ đều đặn (compounding moves)",
        "Tránh chiến thắng ngắn hạn làm lệch trục toàn cục"
      ],
      "drills": [
        "Viết 1 trang ‘thập niên đồ’ cá nhân",
        "Chọn 1 nước đi nhỏ nhưng đều đặn mỗi tuần"
      ],
      "success": "Hàng tuần có ‘nước đi nhỏ’ trên đúng trục; không bị cuốn theo game ngắn hạn",
      "evidence": [
        "Thập niên đồ 1 trang",
        "Log nước đi tuần"
      ],
      "antiPatterns": [
        "Đổi trục theo trend",
        "Đốt năng lượng vào trận nhỏ trái trục"
      ]
    }
  ]
}
</script>
<header class="appbar">
<style>
      .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1,1);white-space:nowrap;border:0}
    </style>
<div class="appbar-inner">
<div aria-hidden="true" class="logo"></div>
<h1 class="title">Hệ Kỹ Năng – Bản đã sửa (UI ổn định)</h1>
<span class="chip">v1.0 • Single-file</span>
<div class="spacer"></div>
<button aria-pressed="false" class="btn small" id="themeToggle" title="Chuyển giao diện" type="button">🌗 Giao diện</button>
</div>
</header>
<main id="main">
<!-- Tabs -->
<nav aria-label="Điều hướng" class="tabs" role="tablist">
<button aria-controls="skillsSec" aria-selected="true" class="tab" id="tab-skills" role="tab" tabindex="0" type="button">🧩 Kỹ năng</button>
<button aria-controls="personaSec" aria-selected="false" class="tab" id="tab-persona" role="tab" tabindex="-1" type="button">🧠 Persona</button>
<button aria-controls="auditSec" aria-selected="false" class="tab" id="tab-audit" role="tab" tabindex="-1" type="button">🧾 Audit</button>
</nav>
<!-- Dashboard -->
<!-- Skills -->
<section aria-labelledby="tab-skills" class="view active" id="skillsSec" role="tabpanel">
<div class="grid">
<div class="col-12 card">
<div class="row">
<h3>Danh sách Kỹ năng</h3>
<div class="right">
<button class="btn small" id="btnAddSkill" type="button">＋ Thêm kỹ năng</button>
<button class="btn small" id="btnExport" type="button">⬇ Xuất JSON</button>
<input accept="application/json" aria-label="fileImport" hidden="" id="fileImport" type="file"/>
<button class="btn small" id="btnImport" type="button">⬆ Nhập JSON</button>
<button class="btn small" id="btnRestore" type="button">🕑 Khôi phục</button>
<button class="btn small" id="btnFocusToday" type="button">🎯 Focus Hôm nay</button><button class="btn small" id="btnKPIManager" type="button">📈 KPI</button><button class="btn small" id="btnMergeJSON" type="button">⇄ Gộp JSON</button><input accept="application/json" hidden="" id="fileMerge" type="file"/></div>
</div>
        <!--
          The original template included a Persona filter but it wasn't visible in the 24K file.
          To restore parity with the Gốc.html version, we restructure this row so that the
          Persona dropdown, the "Lọc tương thích Persona" checkbox, and the search box
          live together in the same flex container. This ensures the Persona select is
          displayed correctly across themes.
        -->
        <div class="row" style="margin-top:.6rem">
          <div class="field" style="max-width:280px">
            <label for="personaFilter">Lọc theo Persona</label>
            <select id="personaFilter">
              <option value="">— Tất cả —</option>
            </select>
          </div>
          <div class="field" style="max-width:260px">
            <label for="onlyCompat">Lọc tương thích Persona</label>
            <div class="row" style="align-items:center;gap:.4rem">
              <input id="onlyCompat" type="checkbox"/>
              <span class="muted">Chỉ hiện kỹ năng phù hợp</span>
            </div>
          </div>
          <div class="field" style="max-width:340px">
            <label for="searchBox">Tìm kỹ năng</label>
            <input id="searchBox" placeholder="Nhập tên kỹ năng, vai trò, ghi chú..." type="text"/>
          </div>
        </div>
</div>
</div>
<div class="col-12 grid" id="skillsList"></div>
</section>
<!-- Persona -->
<section aria-labelledby="tab-persona" class="view" id="personaSec" role="tabpanel">
<div class="grid">
<div class="col-6 card">
<h3>Persona &amp; Flow đề xuất</h3>
<div class="field">
<label for="personaSelect">Chọn Persona</label>
<select id="personaSelect"></select>
</div>
<div class="field">
<label for="personaFlow">Flow hành vi gợi ý</label>
<textarea id="personaFlow" readonly=""></textarea>
</div>
</div>
<div class="col-6 card">
<h3>Gán kỹ năng cho Persona</h3>
<div class="field">
<label>Kỹ năng gợi ý</label>
<div class="row" id="personaSkillPills" style="gap:.4rem;flex-wrap:wrap"></div>
</div>
</div>
</div>
</section>
<!-- Audit -->
<section aria-labelledby="tab-audit" class="view" id="auditSec" role="tabpanel">
<div class="grid">
  <!-- Moved Anomaly Radar and Weekly Review from nav into audit section -->
  <div class="col-12 card">
    <h3>Anomaly Radar</h3>
    <div class="muted small">Cảnh báo lệch mẫu 7 ngày gần đây</div>
    <div class="klist" id="alertsList"></div>
    <div class="row" style="justify-content:flex-end; gap:.5rem; margin-top:.5rem">
      <button class="btn small" id="btnWeeklyReview" type="button">🗓️ Weekly Review</button>
    </div>
  </div>
<div class="col-12 card">
<h3>Nhật ký / Ghi chú nhanh</h3>
<div class="field">
<label for="quickLog">Ghi chú</label>
<textarea id="quickLog" placeholder="Viết nhanh…"></textarea>
</div>
<div class="row">
<button class="btn small" id="btnSaveLog" type="button">💾 Lưu</button>
<span aria-live="polite" class="muted" id="logStatus" role="status"></span>
</div>
</div>
</div>
<section class="p1-root" id="p1-live" style="gap:var(--space-5)">
<div class="p1-cards" id="p1-cards">
<div class="p1-card">
<h4>Reflex Score (7d)</h4>
<div class="big" id="p1-reflex7">–</div>
<div class="sub">30d: <span id="p1-reflex30">–</span></div>
</div>
<div class="p1-card">
<h4>Avg Energy (base)</h4>
<div class="big" id="p1-energy">–</div>
<div class="sub">Low energy flags: <span id="p1-lowenergy">0</span></div>
</div>
<div class="p1-card">
<h4>Audit Alerts</h4>
<div class="big" id="p1-alerts">0</div>
<div class="sub"><button class="p1-btn" id="p1-run-audit" type="button">Run Audit (Ctrl+L)</button></div>
</div>
<div class="p1-card">
<h4>Use Case</h4>
<div class="sub"><button class="p1-btn" id="p1-open-uc" type="button">＋ Use Case (Ctrl+U)</button></div>
</div>
</div>
<table id="p1-log">
<thead>
<tr>
<th>Ngày</th><th>Persona</th><th>Kỹ năng</th><th>KQ</th><th>ΔNăng lượng</th><th>Reflex</th><th>Flags</th>
</tr>
</thead>
<tbody id="p1-log-body"></tbody>
</table>
</section>
<section aria-labelledby="af-skill-title" class="af-card" id="skill-content-af">
<div class="af-flex" style="justify-content:space-between;align-items:center;margin-bottom:8px">
<h2 id="af-skill-title" style="margin:0">Skill Content A–F + Logs — 24CP</h2>
<span class="af-chip">Integrated • usable</span>
</div>
<p class="af-muted">Trục 24CP làm gốc. Chọn skill → xem CP/Drills → log thực hành. Dữ liệu lưu cục bộ (<code>localStorage</code>), không phụ thuộc mạng.</p>
<div class="af-row">
<!-- LEFT: FILTERS + LOG FORM -->
<div class="af-left">
<div class="af-field">
<label>Danh mục (A–F)</label>
<select class="af-select" id="afCategory"></select>
</div>
<div class="af-field">
<label>Kỹ năng</label>
<select class="af-select" id="afSkill"></select>
</div>
<div class="af-field">
<label>Tìm CP / Drill</label>
<input class="af-input" id="afSearch" placeholder="gõ từ khóa..."/>
</div>
<hr style="margin:8px 0 12px;opacity:.3"/>
<h3 class="af-section-title">Log theo 24CP</h3>
<div class="af-field">
<label>CP chọn</label>
<div class="af-flex" id="afCPChosen"></div>
<div class="af-note">Chọn CP ở panel bên phải; mục đã chọn sẽ xuất hiện ở đây.</div>
</div>
<div class="af-field">
<label>Drill (nếu có)</label>
<select class="af-select" id="afDrill"></select>
</div>
<div class="af-field">
<label>Ngày • Giờ</label>
<div class="af-flex">
<input class="af-input" id="afDate" type="date"/>
<input class="af-input" id="afTime" type="time"/>
</div>
</div>
<div class="af-field">
<label>Thời lượng (phút)</label>
<input class="af-input" id="afDuration" min="1" placeholder="ví dụ: 25" step="1" type="number"/>
</div>
<div class="af-field">
<label>Điểm (0–10)</label>
<input class="af-input" id="afScore" max="10" min="0" placeholder="đánh giá chất lượng buổi tập" step="0.5" type="number"/>
</div>
<div class="af-field">
<label>Năng lượng (1–5)</label>
<input class="af-input" id="afEnergy" max="5" min="1" placeholder="cảm nhận năng lượng" step="1" type="number"/>
</div>
<div class="af-field">
<label>Ghi chú</label>
<textarea class="af-textarea" id="afNote" placeholder="điều chỉnh, phát hiện, kế hoạch..." rows="3"></textarea>
</div>
<div class="af-flex">
<button class="af-btn" id="afSave">Lưu log</button>
<button class="af-btn secondary" id="afClearSel">Bỏ chọn CP</button>
</div>
<p class="af-note" id="afMsg" style="margin-top:8px"></p>
</div>
<!-- RIGHT: DETAILS + CP/DRILL + STATS + LOGS -->
<div class="af-right">
<h3 class="af-section-title">Chi tiết kỹ năng</h3>
<table class="af-table">
<tbody>
<tr><th>Skill</th><td id="afSkillName">—</td></tr>
<tr><th>Ưu tiên • Độ khó • Chu kỳ ôn</th><td id="afMeta">—</td></tr>
<tr><th>Định nghĩa Mastery</th><td id="afMastery">—</td></tr>
<tr><th>Mục tiêu (A)</th><td id="afGoal">—</td></tr>
</tbody>
</table>
<h3 class="af-section-title" style="margin-top:12px">Critical Points (24CP)</h3>
<div class="af-cp-list" id="afCPs"></div>
<h3 class="af-section-title" style="margin-top:12px">Drills</h3>
<div id="afDrills">—</div>
<h3 class="af-section-title" style="margin-top:12px">Resources/Evidence</h3>
<div id="afRes">—</div>
<h3 class="af-section-title" style="margin-top:12px">Scenarios / Use-cases</h3>
<div id="afScn">—</div>
<h3 class="af-section-title" style="margin-top:12px">Weekly Review</h3>
<div id="afRev">—</div>
<h3 class="af-section-title" style="margin-top:12px">Stats nhanh</h3>
<div class="af-stats" id="afStats">
<div class="af-stat"><div class="af-muted">Số CP / Skill</div><div id="afStatCP" style="font-weight:800;font-size:1.2rem">0</div></div>
<div class="af-stat"><div class="af-muted">Buổi trong 7 ngày</div><div id="afStat7" style="font-weight:800;font-size:1.2rem">0</div></div>
<div class="af-stat"><div class="af-muted">Điểm TB 7 ngày</div><div id="afStatAvg" style="font-weight:800;font-size:1.2rem">—</div></div>
</div>
<h3 class="af-section-title" style="margin-top:12px">Logs gần đây</h3>
<table class="af-table" id="afLogsTbl">
<thead><tr><th>Ngày</th><th>Giờ</th><th>CP</th><th>Phút</th><th>Điểm</th><th>Năng lượng</th><th>Drill</th><th>Ghi chú</th></tr></thead>
<tbody id="afLogsBody"></tbody>
</table>
</div>
</div>
</section></section>
<script id="AF_DATA" type="application/json">
{
  "skills": [
    {
      "SkillID": "K1",
      "SkillName": "Tiếng Anh chiến lược",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Tiếng Anh chiến lược.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Chuẩn bị 3–5 cụm từ chủ lực theo ngữ cảnh trước cuộc thoại/viết",
          "SuccessCriteria": "≥3 cuộc thoại/tuần có CTA; ≥80% người nghe lặp lại đúng key message",
          "FailSignals": "Dài dòng, không có câu neo; chạy theo câu hỏi mà mất trục; Lạm dụng từ vựng hiếm gây nhiễu hiểu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Giảm 5–10% tốc độ nói ở đoạn chốt ý; nhấn nhịp cuối câu",
          "SuccessCriteria": "≥3 cuộc thoại/tuần có CTA; ≥80% người nghe lặp lại đúng key message",
          "FailSignals": "Dài dòng, không có câu neo; chạy theo câu hỏi mà mất trục; Lạm dụng từ vựng hiếm gây nhiễu hiểu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Mỗi đoạn/turn có một one-liner ≤12 từ để neo thông điệp",
          "SuccessCriteria": "≥3 cuộc thoại/tuần có CTA; ≥80% người nghe lặp lại đúng key message",
          "FailSignals": "Dài dòng, không có câu neo; chạy theo câu hỏi mà mất trục; Lạm dụng từ vựng hiếm gây nhiễu hiểu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Dùng kỹ thuật bridge→message khi bị hỏi khó để quay về trục chính",
          "SuccessCriteria": "≥3 cuộc thoại/tuần có CTA; ≥80% người nghe lặp lại đúng key message",
          "FailSignals": "Dài dòng, không có câu neo; chạy theo câu hỏi mà mất trục; Lạm dụng từ vựng hiếm gây nhiễu hiểu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Kết thúc bằng call-to-action rõ ràng, kiểm tra người nghe nhắc lại đúng ý",
          "SuccessCriteria": "≥3 cuộc thoại/tuần có CTA; ≥80% người nghe lặp lại đúng key message",
          "FailSignals": "Dài dòng, không có câu neo; chạy theo câu hỏi mà mất trục; Lạm dụng từ vựng hiếm gây nhiễu hiểu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Ghi âm 1–3 phút cuộc thoại",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Bản nháp one-liner và CTA dùng thực tế",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Shadowing 5 phút/ngày với một mẫu thoại theo chủ đề",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Viết 3 one-liners/ngày cho cùng một thông điệp theo 3 tông giọng",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K2",
      "SkillName": "Tiếng Trung chiến lược",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Tiếng Trung chiến lược.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Chuẩn hóa thuật ngữ ngành theo 2 chiều (ZH↔VN/EN) trước buổi dịch",
          "SuccessCriteria": "0 lỗi ‘mất mặt’; ≥2 lần tái diễn đạt giúp làm rõ ý trong mỗi phiên dịch dài",
          "FailSignals": "Bám chữ bỏ ý; bỏ qua yếu tố thể diện; Chuyển ngữ thô gây cứng không khí",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Dịch ý trước dịch chữ; bảo toàn mục tiêu quan hệ (face-saving)",
          "SuccessCriteria": "0 lỗi ‘mất mặt’; ≥2 lần tái diễn đạt giúp làm rõ ý trong mỗi phiên dịch dài",
          "FailSignals": "Bám chữ bỏ ý; bỏ qua yếu tố thể diện; Chuyển ngữ thô gây cứng không khí",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Đặt buffer 1 nhịp trước phát ngôn nhạy cảm để kiểm lại dụng ý",
          "SuccessCriteria": "0 lỗi ‘mất mặt’; ≥2 lần tái diễn đạt giúp làm rõ ý trong mỗi phiên dịch dài",
          "FailSignals": "Bám chữ bỏ ý; bỏ qua yếu tố thể diện; Chuyển ngữ thô gây cứng không khí",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Chèn cụm đệm văn hóa để mềm hoá xung đột (礼貌/缓冲)",
          "SuccessCriteria": "0 lỗi ‘mất mặt’; ≥2 lần tái diễn đạt giúp làm rõ ý trong mỗi phiên dịch dài",
          "FailSignals": "Bám chữ bỏ ý; bỏ qua yếu tố thể diện; Chuyển ngữ thô gây cứng không khí",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Kết bằng công thức ‘đồng thuận tối thiểu + bước tiếp theo’",
          "SuccessCriteria": "0 lỗi ‘mất mặt’; ≥2 lần tái diễn đạt giúp làm rõ ý trong mỗi phiên dịch dài",
          "FailSignals": "Bám chữ bỏ ý; bỏ qua yếu tố thể diện; Chuyển ngữ thô gây cứng không khí",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Bản dịch đôi (song ngữ) có đánh dấu lựa chọn dịch ý",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Audio/clip minh họa 60–90s",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Dịch 2 chiều 3 đoạn ngắn/ngày theo cùng chủ đề",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Viết 5 cặp cụm đệm văn hoá và tình huống sử dụng",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K3",
      "SkillName": "Kinh tế học thực chiến",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Kinh tế học thực chiến.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Xác định bộ 3 chỉ báo vĩ mô cốt lõi cho bối cảnh (ví dụ: CPI, lãi suất, tăng trưởng)",
          "SuccessCriteria": "Báo cáo 1 trang có causal chain + hai kịch bản + trigger; quyết định gắn với sizing",
          "FailSignals": "Nhặt headline ngắn hạn; kết luận không nêu giả định; Một kịch bản duy nhất, không trigger",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Tách nhiễu tin tức: chỉ lấy nguồn sơ cấp và chuỗi thời gian ≥24 tháng",
          "SuccessCriteria": "Báo cáo 1 trang có causal chain + hai kịch bản + trigger; quyết định gắn với sizing",
          "FailSignals": "Nhặt headline ngắn hạn; kết luận không nêu giả định; Một kịch bản duy nhất, không trigger",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Lập luận bằng causal chain 3–5 mắt xích, nêu giả định rõ ràng",
          "SuccessCriteria": "Báo cáo 1 trang có causal chain + hai kịch bản + trigger; quyết định gắn với sizing",
          "FailSignals": "Nhặt headline ngắn hạn; kết luận không nêu giả định; Một kịch bản duy nhất, không trigger",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Đưa 2 kịch bản (base/bear hoặc base/bull) và trigger chuyển pha",
          "SuccessCriteria": "Báo cáo 1 trang có causal chain + hai kịch bản + trigger; quyết định gắn với sizing",
          "FailSignals": "Nhặt headline ngắn hạn; kết luận không nêu giả định; Một kịch bản duy nhất, không trigger",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Chốt quyết định bằng nguyên tắc position sizing và điểm vô hiệu (invalidation)",
          "SuccessCriteria": "Báo cáo 1 trang có causal chain + hai kịch bản + trigger; quyết định gắn với sizing",
          "FailSignals": "Nhặt headline ngắn hạn; kết luận không nêu giả định; Một kịch bản duy nhất, không trigger",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Bảng chỉ báo 1 trang",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Đồ thị chuỗi thời gian kèm ghi chú giả định",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Viết 1 trang ‘macro snapshot’/tuần cho một nền kinh tế",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Backtest 1 giả thuyết bằng dữ liệu lịch sử đơn giản",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K4",
      "SkillName": "Tài chính – Đầu tư cá nhân",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Tài chính – Đầu tư cá nhân.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Ghi chép dòng tiền thực tế ≥30 ngày; phân nhóm chi tiêu theo 3 tầng (cốt lõi/đòn bẩy/xa xỉ)",
          "SuccessCriteria": "Tuân thủ ngân sách 4 tuần; portfolio có phân bổ core/satellite; mỗi vị thế có điểm thoát",
          "FailSignals": "Mua theo cảm xúc; không có điểm thoát; Chi phí chìm/đòn bẩy ẩn không kiểm",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Thiết lập quỹ dự phòng ≥3–6 tháng chi phí thiết yếu",
          "SuccessCriteria": "Tuân thủ ngân sách 4 tuần; portfolio có phân bổ core/satellite; mỗi vị thế có điểm thoát",
          "FailSignals": "Mua theo cảm xúc; không có điểm thoát; Chi phí chìm/đòn bẩy ẩn không kiểm",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Quy tắc phân bổ: core (index/cashflow)/satellite (alpha) có tỷ lệ rõ ràng",
          "SuccessCriteria": "Tuân thủ ngân sách 4 tuần; portfolio có phân bổ core/satellite; mỗi vị thế có điểm thoát",
          "FailSignals": "Mua theo cảm xúc; không có điểm thoát; Chi phí chìm/đòn bẩy ẩn không kiểm",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Mỗi quyết định đầu tư phải có thesis 3 câu + tiêu chí thoát (profit/loss)",
          "SuccessCriteria": "Tuân thủ ngân sách 4 tuần; portfolio có phân bổ core/satellite; mỗi vị thế có điểm thoát",
          "FailSignals": "Mua theo cảm xúc; không có điểm thoát; Chi phí chìm/đòn bẩy ẩn không kiểm",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Tối thiểu hoá phí và thuế; kiểm bảng phí định kỳ",
          "SuccessCriteria": "Tuân thủ ngân sách 4 tuần; portfolio có phân bổ core/satellite; mỗi vị thế có điểm thoát",
          "FailSignals": "Mua theo cảm xúc; không có điểm thoát; Chi phí chìm/đòn bẩy ẩn không kiểm",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Bảng dòng tiền 30 ngày",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Investment memo 1 trang",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Cập nhật sổ dòng tiền hàng ngày (5 phút)",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Viết 1 investment memo ngắn/tuần cho 1 ý tưởng",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K5",
      "SkillName": "Luật thực chiến",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Luật thực chiến.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Xác định khung pháp lý áp dụng và điều khoản trọng yếu trước giao dịch/hành động",
          "SuccessCriteria": "Hồ sơ case có log bằng chứng hoàn chỉnh; brief 10 dòng; phương án xử lý có thứ tự ưu tiên",
          "FailSignals": "Phát ngôn cảm tính công khai; Thu thập chứng cứ không bảo toàn tính hợp lệ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Thu thập và lưu bằng chứng có trình tự, timestamp, chain-of-custody",
          "SuccessCriteria": "Hồ sơ case có log bằng chứng hoàn chỉnh; brief 10 dòng; phương án xử lý có thứ tự ưu tiên",
          "FailSignals": "Phát ngôn cảm tính công khai; Thu thập chứng cứ không bảo toàn tính hợp lệ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Viết tóm tắt case ≤10 dòng: sự kiện, căn cứ, yêu cầu, rủi ro",
          "SuccessCriteria": "Hồ sơ case có log bằng chứng hoàn chỉnh; brief 10 dòng; phương án xử lý có thứ tự ưu tiên",
          "FailSignals": "Phát ngôn cảm tính công khai; Thu thập chứng cứ không bảo toàn tính hợp lệ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Áp dụng nguyên tắc im lặng chiến lược khi chưa đủ thông tin/đại diện",
          "SuccessCriteria": "Hồ sơ case có log bằng chứng hoàn chỉnh; brief 10 dòng; phương án xử lý có thứ tự ưu tiên",
          "FailSignals": "Phát ngôn cảm tính công khai; Thu thập chứng cứ không bảo toàn tính hợp lệ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Chọn chiến lược ‘ngoại giao trước – pháp lý sau’ khi có lợi cho kết quả",
          "SuccessCriteria": "Hồ sơ case có log bằng chứng hoàn chỉnh; brief 10 dòng; phương án xử lý có thứ tự ưu tiên",
          "FailSignals": "Phát ngôn cảm tính công khai; Thu thập chứng cứ không bảo toàn tính hợp lệ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Checklist bằng chứng",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Brief 10 dòng + scan điều khoản",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Soạn checklist bằng chứng cho 1 tình huống giả định",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Phân tích 1 hợp đồng, đánh dấu 5 điều khoản rủi ro",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K6",
      "SkillName": "Kinh doanh – Thị trường",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Kinh doanh – Thị trường.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Xác định job-to-be-done và phân khúc hẹp đủ đau",
          "SuccessCriteria": "Value prop rõ, có số liệu smoke test; funnel có metric; vòng lặp feedback→sửa định vị",
          "FailSignals": "Build trước hỏi sau; sản phẩm ‘cho tất cả’; Chạy nhiều kênh nhưng không có metric chủ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Đề xuất giá trị 1 câu, kiểm bằng 5 cuộc phỏng vấn khách hàng",
          "SuccessCriteria": "Value prop rõ, có số liệu smoke test; funnel có metric; vòng lặp feedback→sửa định vị",
          "FailSignals": "Build trước hỏi sau; sản phẩm ‘cho tất cả’; Chạy nhiều kênh nhưng không có metric chủ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Thiết kế funnel tối giản (awareness→activation→retention) với một metric chủ",
          "SuccessCriteria": "Value prop rõ, có số liệu smoke test; funnel có metric; vòng lặp feedback→sửa định vị",
          "FailSignals": "Build trước hỏi sau; sản phẩm ‘cho tất cả’; Chạy nhiều kênh nhưng không có metric chủ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Chạy thử offer nhỏ (smoke test) trước khi build",
          "SuccessCriteria": "Value prop rõ, có số liệu smoke test; funnel có metric; vòng lặp feedback→sửa định vị",
          "FailSignals": "Build trước hỏi sau; sản phẩm ‘cho tất cả’; Chạy nhiều kênh nhưng không có metric chủ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Đo NPS/qualitative feedback sau mỗi vòng lặp để chỉnh định vị",
          "SuccessCriteria": "Value prop rõ, có số liệu smoke test; funnel có metric; vòng lặp feedback→sửa định vị",
          "FailSignals": "Build trước hỏi sau; sản phẩm ‘cho tất cả’; Chạy nhiều kênh nhưng không có metric chủ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Biên bản phỏng vấn",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Số liệu chuyển đổi landing",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "5 cuộc phỏng vấn khách hàng/tuần theo script",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Thiết kế một landing smoke test và đo chuyển đổi",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K7",
      "SkillName": "Tâm lý học chiến lược",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Tâm lý học chiến lược.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Spot 3 vi tín hiệu cảm xúc trước khi phản hồi (mắt/giọng/tư thế)",
          "SuccessCriteria": "Giảm xung đột thấy rõ; đối tượng tự hạ giọng ≥50% tình huống",
          "FailSignals": "Khuyên sớm; phản xạ tức thì; Gán nhãn xúc phạm thay vì label trung tính",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Thực hiện nhịp thở 4-2-4 để hạ phản xạ tức thì",
          "SuccessCriteria": "Giảm xung đột thấy rõ; đối tượng tự hạ giọng ≥50% tình huống",
          "FailSignals": "Khuyên sớm; phản xạ tức thì; Gán nhãn xúc phạm thay vì label trung tính",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Dùng ‘label cảm xúc’ 1 câu để giải áp",
          "SuccessCriteria": "Giảm xung đột thấy rõ; đối tượng tự hạ giọng ≥50% tình huống",
          "FailSignals": "Khuyên sớm; phản xạ tức thì; Gán nhãn xúc phạm thay vì label trung tính",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Không trả lời câu hỏi nhạy cảm trong 2–3 nhịp đầu; chuyển hướng mềm",
          "SuccessCriteria": "Giảm xung đột thấy rõ; đối tượng tự hạ giọng ≥50% tình huống",
          "FailSignals": "Khuyên sớm; phản xạ tức thì; Gán nhãn xúc phạm thay vì label trung tính",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Đóng bằng ‘rút nhịp’ (không đóng tròn) để tránh leo thang",
          "SuccessCriteria": "Giảm xung đột thấy rõ; đối tượng tự hạ giọng ≥50% tình huống",
          "FailSignals": "Khuyên sớm; phản xạ tức thì; Gán nhãn xúc phạm thay vì label trung tính",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Log quan sát",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Ghi âm đối thoại ngắn",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Quan sát 2 người/ngày và ghi 3 tín hiệu mỗi người",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Luyện 3 kịch bản label cảm xúc trong 60 giây",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K8",
      "SkillName": "AI – IT ứng dụng",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: AI – IT ứng dụng.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Chuẩn hóa template prompt/workflow; lưu version kèm mục tiêu và giới hạn",
          "SuccessCriteria": "Workflow có SOP; khôi phục trong ≤10 phút; tỉ lệ lỗi giảm và được log rõ",
          "FailSignals": "Đổi công cụ liên tục; không có chuẩn đặt tên; Không test khôi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Thiết lập quy trình backup/snapshot định kỳ và thử restore",
          "SuccessCriteria": "Workflow có SOP; khôi phục trong ≤10 phút; tỉ lệ lỗi giảm và được log rõ",
          "FailSignals": "Đổi công cụ liên tục; không có chuẩn đặt tên; Không test khôi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Đặt chuẩn đặt tên file/dự án và log thay đổi",
          "SuccessCriteria": "Workflow có SOP; khôi phục trong ≤10 phút; tỉ lệ lỗi giảm và được log rõ",
          "FailSignals": "Đổi công cụ liên tục; không có chuẩn đặt tên; Không test khôi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Chọn công cụ theo tiêu chí ‘đáp đúng bài toán’ thay vì chạy theo trend",
          "SuccessCriteria": "Workflow có SOP; khôi phục trong ≤10 phút; tỉ lệ lỗi giảm và được log rõ",
          "FailSignals": "Đổi công cụ liên tục; không có chuẩn đặt tên; Không test khôi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Thiết kế cảnh báo sớm khi pipeline lỗi hoặc dữ liệu lệch",
          "SuccessCriteria": "Workflow có SOP; khôi phục trong ≤10 phút; tỉ lệ lỗi giảm và được log rõ",
          "FailSignals": "Đổi công cụ liên tục; không có chuẩn đặt tên; Không test khôi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "SOP 1 trang",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Log snapshot/restore",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Tạo 1 snapshot/tuần và thử restore",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Viết 1 trang SOP cho một workflow AI/IT bạn dùng",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K9",
      "SkillName": "Y học – Sinh học – Thân thể",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Y học – Sinh học – Thân thể.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Theo dõi 3 chỉ báo: giấc ngủ, vận động, dinh dưỡng (hoặc nhịp tim/HRV)",
          "SuccessCriteria": "Mệt giảm ≥2 điểm sau 2 tuần; chỉ báo ổn định hơn; ít crash",
          "FailSignals": "Bù bằng caffeine/đường; bỏ ngủ; Tập nặng khi đang thiếu hồi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Áp dụng thở 4-7-8 và đi bộ sáng 20 phút",
          "SuccessCriteria": "Mệt giảm ≥2 điểm sau 2 tuần; chỉ báo ổn định hơn; ít crash",
          "FailSignals": "Bù bằng caffeine/đường; bỏ ngủ; Tập nặng khi đang thiếu hồi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Giữ cửa sổ ăn cố định; ưu tiên protein và chất xơ",
          "SuccessCriteria": "Mệt giảm ≥2 điểm sau 2 tuần; chỉ báo ổn định hơn; ít crash",
          "FailSignals": "Bù bằng caffeine/đường; bỏ ngủ; Tập nặng khi đang thiếu hồi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Log mức mệt 0–10; điều chỉnh tải công việc theo chu kỳ",
          "SuccessCriteria": "Mệt giảm ≥2 điểm sau 2 tuần; chỉ báo ổn định hơn; ít crash",
          "FailSignals": "Bù bằng caffeine/đường; bỏ ngủ; Tập nặng khi đang thiếu hồi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Tín hiệu đỏ: đau kéo dài/giấc ngủ <6h/HRV giảm nhiều → kích hoạt hồi phục",
          "SuccessCriteria": "Mệt giảm ≥2 điểm sau 2 tuần; chỉ báo ổn định hơn; ít crash",
          "FailSignals": "Bù bằng caffeine/đường; bỏ ngủ; Tập nặng khi đang thiếu hồi phục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Bảng chỉ báo",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Ảnh/ghi chú bữa ăn & vận động",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "1 phiên thở + 20’ đi bộ/ngày",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Chuẩn bị suất ăn chuẩn hoá 2–3 ngày/lần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K10",
      "SkillName": "Triết học – Logic – Phản tư",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Triết học – Logic – Phản tư.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Vẽ sơ đồ nhân quả 5 nút cho vấn đề chính",
          "SuccessCriteria": "Quyết định ≤24h với premiss rõ; giảm vòng lặp suy diễn",
          "FailSignals": "Overthinking không dừng; Trộn cảm xúc vào luận lý",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Viết định nghĩa vấn đề 1 câu (không dài hơn 20 từ)",
          "SuccessCriteria": "Quyết định ≤24h với premiss rõ; giảm vòng lặp suy diễn",
          "FailSignals": "Overthinking không dừng; Trộn cảm xúc vào luận lý",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Áp dụng tam đoạn luận hoặc quy tắc phủ định để kiểm luận",
          "SuccessCriteria": "Quyết định ≤24h với premiss rõ; giảm vòng lặp suy diễn",
          "FailSignals": "Overthinking không dừng; Trộn cảm xúc vào luận lý",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Tạo counter-example để phá ảo tưởng xác nhận",
          "SuccessCriteria": "Quyết định ≤24h với premiss rõ; giảm vòng lặp suy diễn",
          "FailSignals": "Overthinking không dừng; Trộn cảm xúc vào luận lý",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Đặt stop rule: tiêu chí dừng phân tích để ra quyết định",
          "SuccessCriteria": "Quyết định ≤24h với premiss rõ; giảm vòng lặp suy diễn",
          "FailSignals": "Overthinking không dừng; Trộn cảm xúc vào luận lý",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Ảnh sơ đồ",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Note premiss/conclusion",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "1 sơ đồ/tuần cho một quyết định quan trọng",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Viết premiss-conclusion 3 ví dụ/ngày",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K11",
      "SkillName": "Chính trị – Quyền lực – Địa chính trị",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Chính trị – Quyền lực – Địa chính trị.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Vẽ bản đồ tác nhân/quyền lực (stakeholder map) cho bối cảnh",
          "SuccessCriteria": "Giảm xung đột công khai; đạt nhượng bộ qua kênh phù hợp",
          "FailSignals": "Tuyên chiến công khai không lực; Bỏ hồ sơ bằng chứng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Xác định trục quyền, lợi ích, đòn bẩy và ranh giới đỏ",
          "SuccessCriteria": "Giảm xung đột công khai; đạt nhượng bộ qua kênh phù hợp",
          "FailSignals": "Tuyên chiến công khai không lực; Bỏ hồ sơ bằng chứng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Không đụng công khai khi chưa có kênh/đòn bẩy tương xứng",
          "SuccessCriteria": "Giảm xung đột công khai; đạt nhượng bộ qua kênh phù hợp",
          "FailSignals": "Tuyên chiến công khai không lực; Bỏ hồ sơ bằng chứng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Dùng phản chiếu để lộ mâu thuẫn nội hệ thay vì đối đầu trực diện",
          "SuccessCriteria": "Giảm xung đột công khai; đạt nhượng bộ qua kênh phù hợp",
          "FailSignals": "Tuyên chiến công khai không lực; Bỏ hồ sơ bằng chứng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Giữ hồ sơ liên lạc/bằng chứng cho mọi trao đổi nhạy cảm",
          "SuccessCriteria": "Giảm xung đột công khai; đạt nhượng bộ qua kênh phù hợp",
          "FailSignals": "Tuyên chiến công khai không lực; Bỏ hồ sơ bằng chứng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Sơ đồ tác nhân",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Biên bản liên lạc có timestamp",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Lập 1 stakeholder map/tuần cho một bối cảnh",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Viết 2 kịch bản can thiệp gián tiếp và điều kiện kích hoạt",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K12",
      "SkillName": "Tâm linh chiến lược – khí – nghiệp",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Tâm linh chiến lược – khí – nghiệp.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Khoanh vùng nguồn nhiễu (người/đồ vật/thói quen) và đánh dấu ‘cắt’",
          "SuccessCriteria": "Giảm nhiễu rõ rệt; không tái tiếp xúc vô thức; giấc ngủ/nhịp sống ổn",
          "FailSignals": "Ritual phức tạp không bền; Cắt chưa dứt, tái nghiện kênh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Thiết lập vệ sinh năng lượng: ngủ, ánh sáng, môi trường thông thoáng",
          "SuccessCriteria": "Giảm nhiễu rõ rệt; không tái tiếp xúc vô thức; giấc ngủ/nhịp sống ổn",
          "FailSignals": "Ritual phức tạp không bền; Cắt chưa dứt, tái nghiện kênh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Thực hành tách-bám cảm xúc: quan sát hơi thở 2 phút trước phản ứng",
          "SuccessCriteria": "Giảm nhiễu rõ rệt; không tái tiếp xúc vô thức; giấc ngủ/nhịp sống ổn",
          "FailSignals": "Ritual phức tạp không bền; Cắt chưa dứt, tái nghiện kênh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Đóng van: ngừng tiếp xúc/tương tác ở kênh gây rút khí trong 7 ngày",
          "SuccessCriteria": "Giảm nhiễu rõ rệt; không tái tiếp xúc vô thức; giấc ngủ/nhịp sống ổn",
          "FailSignals": "Ritual phức tạp không bền; Cắt chưa dứt, tái nghiện kênh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Rút sạch: ritual đơn giản (dọn, tắm, ghi chép, đốt bỏ) để tái lập trục",
          "SuccessCriteria": "Giảm nhiễu rõ rệt; không tái tiếp xúc vô thức; giấc ngủ/nhịp sống ổn",
          "FailSignals": "Ritual phức tạp không bền; Cắt chưa dứt, tái nghiện kênh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Checklist nguồn nhiễu & trạng thái trước-sau",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Nhật ký 7 ngày",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "7-day cleanse: loại 1 nguồn rút khí",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Thực hành 2 phút quan sát hơi thở trước 3 tình huống",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K13",
      "SkillName": "Sinh tồn – thực chiến nội tại",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Sinh tồn – thực chiến nội tại.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Danh mục tối thiểu sinh tồn (nước, thực phẩm, y tế, liên lạc) và vị trí",
          "SuccessCriteria": "Thực hiện kịch bản trong ≤30 phút; duy trì chế độ tối thiểu 72h",
          "FailSignals": "Mang thừa đồ không thiết yếu; Không luyện ẩn thân mà chỉ tích đồ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Thiết lập chế độ tối thiểu: ngủ, ăn, vệ sinh, nhịp di chuyển an toàn",
          "SuccessCriteria": "Thực hiện kịch bản trong ≤30 phút; duy trì chế độ tối thiểu 72h",
          "FailSignals": "Mang thừa đồ không thiết yếu; Không luyện ẩn thân mà chỉ tích đồ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Kịch bản mất hệ: 3 điểm hẹn, 2 kênh liên lạc, 1 người phụ trách",
          "SuccessCriteria": "Thực hiện kịch bản trong ≤30 phút; duy trì chế độ tối thiểu 72h",
          "FailSignals": "Mang thừa đồ không thiết yếu; Không luyện ẩn thân mà chỉ tích đồ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Tập phản xạ ẩn thân: giảm phát xạ (ánh sáng/âm thanh/dấu vết)",
          "SuccessCriteria": "Thực hiện kịch bản trong ≤30 phút; duy trì chế độ tối thiểu 72h",
          "FailSignals": "Mang thừa đồ không thiết yếu; Không luyện ẩn thân mà chỉ tích đồ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Giữ log quyết định ngắn để chống hoảng loạn",
          "SuccessCriteria": "Thực hiện kịch bản trong ≤30 phút; duy trì chế độ tối thiểu 72h",
          "FailSignals": "Mang thừa đồ không thiết yếu; Không luyện ẩn thân mà chỉ tích đồ",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Checklist 72h",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Video/ảnh diễn tập",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Diễn tập 30 phút ‘mất điện/mất mạng’ mỗi tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Chuẩn bị túi 72h và kiểm tra hàng tháng",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K14",
      "SkillName": "Mỹ học – nghệ thuật",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Mỹ học – nghệ thuật.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Xác định palette 3 màu trụ và 1 điểm nhấn",
          "SuccessCriteria": "7/10 ảnh đạt tiêu chí ‘sạch/điềm’; có nhận diện motif rõ",
          "FailSignals": "Tham chi tiết/phụ kiện; Nền lộn xộn gây nhiễu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Chọn 2–3 pose/tư thế chốt phù hợp thân thể",
          "SuccessCriteria": "7/10 ảnh đạt tiêu chí ‘sạch/điềm’; có nhận diện motif rõ",
          "FailSignals": "Tham chi tiết/phụ kiện; Nền lộn xộn gây nhiễu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Ánh sáng một hướng; dọn nền nhiễu",
          "SuccessCriteria": "7/10 ảnh đạt tiêu chí ‘sạch/điềm’; có nhận diện motif rõ",
          "FailSignals": "Tham chi tiết/phụ kiện; Nền lộn xộn gây nhiễu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Rule bỏ bớt 10% chi tiết trước khi chụp/xuất bản",
          "SuccessCriteria": "7/10 ảnh đạt tiêu chí ‘sạch/điềm’; có nhận diện motif rõ",
          "FailSignals": "Tham chi tiết/phụ kiện; Nền lộn xộn gây nhiễu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Đưa 1 motif lặp để tạo nhận diện",
          "SuccessCriteria": "7/10 ảnh đạt tiêu chí ‘sạch/điềm’; có nhận diện motif rõ",
          "FailSignals": "Tham chi tiết/phụ kiện; Nền lộn xộn gây nhiễu",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Album 10 ảnh/tuần",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Ghi chú pose và ánh sáng",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "1 ảnh/ngày theo palette; 1 lần soi gương 2’/pose",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Chụp cùng cảnh với 2 ánh sáng để học đối sánh",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K15",
      "SkillName": "Ngôn từ – giao tiếp – phản xạ",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Ngôn từ – giao tiếp – phản xạ.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Chuẩn bị 5 one-liners 12 từ cho 5 kịch bản khó",
          "SuccessCriteria": "Đối phương tự dừng/chuyển chủ đề; không leo thang tranh cãi",
          "FailSignals": "Mỉa mai/công kích; nói dài; Lộ cảm xúc khi ‘đòn chốt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Giữ nhịp ngắt 0.5–1.0s trước câu ‘đòn chốt’",
          "SuccessCriteria": "Đối phương tự dừng/chuyển chủ đề; không leo thang tranh cãi",
          "FailSignals": "Mỉa mai/công kích; nói dài; Lộ cảm xúc khi ‘đòn chốt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Không biện minh; trả lời bằng câu hỏi chốt mục tiêu",
          "SuccessCriteria": "Đối phương tự dừng/chuyển chủ đề; không leo thang tranh cãi",
          "FailSignals": "Mỉa mai/công kích; nói dài; Lộ cảm xúc khi ‘đòn chốt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Chừa cửa thoát thể diện cho đối phương để hạ nhiệt",
          "SuccessCriteria": "Đối phương tự dừng/chuyển chủ đề; không leo thang tranh cãi",
          "FailSignals": "Mỉa mai/công kích; nói dài; Lộ cảm xúc khi ‘đòn chốt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Kết bằng thông điệp hành động hoặc im lặng chiến lược",
          "SuccessCriteria": "Đối phương tự dừng/chuyển chủ đề; không leo thang tranh cãi",
          "FailSignals": "Mỉa mai/công kích; nói dài; Lộ cảm xúc khi ‘đòn chốt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Transcript/ghi âm",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Bộ one-liners theo kịch bản",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Viết 3 one-liners/ngày",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Luyện ngắt nhịp 60s trước gương/ghi âm",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K16",
      "SkillName": "Sản xuất nội dung – thương hiệu",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Sản xuất nội dung – thương hiệu.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Cấu trúc ‘case → insight → khuyến nghị’ trong mỗi bài",
          "SuccessCriteria": "≥1 phản hồi ‘giúp ích’/bài; tỉ lệ đọc >50% với tệp mục tiêu",
          "FailSignals": "Kể lể; thiếu kết luận; Phô trương, xin công nhận",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Một câu ‘điểm khác biệt’ (USP) rõ ràng",
          "SuccessCriteria": "≥1 phản hồi ‘giúp ích’/bài; tỉ lệ đọc >50% với tệp mục tiêu",
          "FailSignals": "Kể lể; thiếu kết luận; Phô trương, xin công nhận",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Giữ giọng tỉnh/điềm; tránh cầu xin công nhận",
          "SuccessCriteria": "≥1 phản hồi ‘giúp ích’/bài; tỉ lệ đọc >50% với tệp mục tiêu",
          "FailSignals": "Kể lể; thiếu kết luận; Phô trương, xin công nhận",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "CTA cụ thể; theo dõi phản hồi và điều chỉnh",
          "SuccessCriteria": "≥1 phản hồi ‘giúp ích’/bài; tỉ lệ đọc >50% với tệp mục tiêu",
          "FailSignals": "Kể lể; thiếu kết luận; Phô trương, xin công nhận",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Dùng 1 ảnh/biểu đồ minh họa mang thông điệp",
          "SuccessCriteria": "≥1 phản hồi ‘giúp ích’/bài; tỉ lệ đọc >50% với tệp mục tiêu",
          "FailSignals": "Kể lể; thiếu kết luận; Phô trương, xin công nhận",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Link bài + phản hồi",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Ảnh/biểu đồ đính kèm",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Viết 1 micro-case/tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Biên tập 1 bài cũ theo cấu trúc mới",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K17",
      "SkillName": "Làm chủ gene – phản xạ sinh học",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Làm chủ gene – phản xạ sinh học.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Theo dõi chu kỳ dài: ngủ, năng lượng, hiệu suất 12 tuần",
          "SuccessCriteria": "Cải thiện chỉ báo ≥10–20% sau chu kỳ; duy trì thói quen khoá",
          "FailSignals": "Đổi can thiệp liên tục; Không có số liệu nền tảng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Nhận diện lệch lặp (crash/chậm hồi) và yếu tố kích hoạt",
          "SuccessCriteria": "Cải thiện chỉ báo ≥10–20% sau chu kỳ; duy trì thói quen khoá",
          "FailSignals": "Đổi can thiệp liên tục; Không có số liệu nền tảng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Thử 1 can thiệp/chu kỳ (ánh sáng/giấc ngủ/nhịp ăn) và đo đáp ứng",
          "SuccessCriteria": "Cải thiện chỉ báo ≥10–20% sau chu kỳ; duy trì thói quen khoá",
          "FailSignals": "Đổi can thiệp liên tục; Không có số liệu nền tảng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Khóa thói quen rút khí ít nhất 2 tuần trước can thiệp tiếp",
          "SuccessCriteria": "Cải thiện chỉ báo ≥10–20% sau chu kỳ; duy trì thói quen khoá",
          "FailSignals": "Đổi can thiệp liên tục; Không có số liệu nền tảng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Đặt ngưỡng cảnh báo khi lệch ra khỏi dải bình thường",
          "SuccessCriteria": "Cải thiện chỉ báo ≥10–20% sau chu kỳ; duy trì thói quen khoá",
          "FailSignals": "Đổi can thiệp liên tục; Không có số liệu nền tảng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Biểu đồ chu kỳ 12 tuần",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Plan can thiệp + kết quả",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Log 3 chỉ báo/ngày trong 12 tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Thiết kế A/B 1 can thiệp trong 2 tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K18",
      "SkillName": "Rewire hành vi – thay máu tiềm thức",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Rewire hành vi – thay máu tiềm thức.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Nhận diện trigger → cảm xúc → hành vi → hậu quả",
          "SuccessCriteria": "Giảm tần suất hành vi cũ ≥50% sau 4 tuần; có thói quen thay thế ổn",
          "FailSignals": "Kỳ vọng ‘hết ngay’; tự phạt nặng gây bỏ cuộc",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Thiết kế thói quen thay thế và ‘hộp cát’ luyện an toàn",
          "SuccessCriteria": "Giảm tần suất hành vi cũ ≥50% sau 4 tuần; có thói quen thay thế ổn",
          "FailSignals": "Kỳ vọng ‘hết ngay’; tự phạt nặng gây bỏ cuộc",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Làm chậm vòng lặp bằng cue/nhắc ẩn trong môi trường",
          "SuccessCriteria": "Giảm tần suất hành vi cũ ≥50% sau 4 tuần; có thói quen thay thế ổn",
          "FailSignals": "Kỳ vọng ‘hết ngay’; tự phạt nặng gây bỏ cuộc",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Tự thưởng nhỏ khi hoàn thành thay thế; phạt nhẹ khi tái phát",
          "SuccessCriteria": "Giảm tần suất hành vi cũ ≥50% sau 4 tuần; có thói quen thay thế ổn",
          "FailSignals": "Kỳ vọng ‘hết ngay’; tự phạt nặng gây bỏ cuộc",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Tổng kết tuần: giữ/loại trigger; cập nhật kế hoạch",
          "SuccessCriteria": "Giảm tần suất hành vi cũ ≥50% sau 4 tuần; có thói quen thay thế ổn",
          "FailSignals": "Kỳ vọng ‘hết ngay’; tự phạt nặng gây bỏ cuộc",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Bảng vòng lặp",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Ảnh/cue môi trường & log tuần",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Ghi 3 vòng lặp/ngày trong 7 ngày",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Thiết lập 1 cue môi trường và test 1 tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K19",
      "SkillName": "Thiết kế hệ – hệ thống hoá",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Thiết kế hệ – hệ thống hoá.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Vẽ canvas hệ 1 trang: mục tiêu, module sáng/chiều/đêm, luồng vào–ra",
          "SuccessCriteria": "Không vỡ hệ khi bận; hoàn thành 2 mục tiêu/tuần ổn định",
          "FailSignals": "Nhồi mục tiêu; thiếu fallback; Đổi hệ liên tục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Xác định trigger cho từng module; đặt fallback khi quá tải",
          "SuccessCriteria": "Không vỡ hệ khi bận; hoàn thành 2 mục tiêu/tuần ổn định",
          "FailSignals": "Nhồi mục tiêu; thiếu fallback; Đổi hệ liên tục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Đo bằng 1 metric/module; review theo tuần",
          "SuccessCriteria": "Không vỡ hệ khi bận; hoàn thành 2 mục tiêu/tuần ổn định",
          "FailSignals": "Nhồi mục tiêu; thiếu fallback; Đổi hệ liên tục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Tự động hoá điểm lặp (nhắc/templating)",
          "SuccessCriteria": "Không vỡ hệ khi bận; hoàn thành 2 mục tiêu/tuần ổn định",
          "FailSignals": "Nhồi mục tiêu; thiếu fallback; Đổi hệ liên tục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Retrospective tuần: giữ/bỏ/sửa module",
          "SuccessCriteria": "Không vỡ hệ khi bận; hoàn thành 2 mục tiêu/tuần ổn định",
          "FailSignals": "Nhồi mục tiêu; thiếu fallback; Đổi hệ liên tục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Canvas + log tuần",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Ảnh nhắc/biểu mẫu tự động",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Vẽ canvas hệ và áp dụng 1 tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Tự động hoá 1 module lặp (nhắc/biểu mẫu)",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K20",
      "SkillName": "Siêu ghi nhớ – Meta-learning",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Siêu ghi nhớ – Meta-learning.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Gắn khung học: mục tiêu, phạm vi, tiêu chí ‘đủ giỏi’",
          "SuccessCriteria": "Áp dụng kiến thức trong 1 tình huống thực; điểm kiểm tra nhỏ đạt chuẩn",
          "FailSignals": "Đọc nhiều không ôn; không kiểm thử; Học vô bối cảnh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Tạo bộ thẻ/biểu mẫu ‘truy xuất nhanh’ (spaced repetition/one-pager)",
          "SuccessCriteria": "Áp dụng kiến thức trong 1 tình huống thực; điểm kiểm tra nhỏ đạt chuẩn",
          "FailSignals": "Đọc nhiều không ôn; không kiểm thử; Học vô bối cảnh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Luyện chia nhỏ kỹ năng và deliberate practice 20–40 phút",
          "SuccessCriteria": "Áp dụng kiến thức trong 1 tình huống thực; điểm kiểm tra nhỏ đạt chuẩn",
          "FailSignals": "Đọc nhiều không ôn; không kiểm thử; Học vô bối cảnh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Phản hồi nhanh: kiểm thử nhỏ sau mỗi buổi học",
          "SuccessCriteria": "Áp dụng kiến thức trong 1 tình huống thực; điểm kiểm tra nhỏ đạt chuẩn",
          "FailSignals": "Đọc nhiều không ôn; không kiểm thử; Học vô bối cảnh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Ghép kiến thức vào bối cảnh sử dụng thực tế",
          "SuccessCriteria": "Áp dụng kiến thức trong 1 tình huống thực; điểm kiểm tra nhỏ đạt chuẩn",
          "FailSignals": "Đọc nhiều không ôn; không kiểm thử; Học vô bối cảnh",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "One-pager",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Log thực hành + kết quả kiểm thử",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Tạo one-pager cho một chủ đề/tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Luyện 2 phiên deliberate practice 25’/tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K21",
      "SkillName": "Phân tích dữ liệu – chiến lược số",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Phân tích dữ liệu – chiến lược số.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Đặt câu hỏi tốt (decision question) trước khi kéo dữ liệu",
          "SuccessCriteria": "Quyết định có baseline + hậu kiểm; thông điệp chart rõ ràng",
          "FailSignals": "Chart đẹp nhưng không trả lời câu hỏi; Kéo dữ liệu trước khi đặt câu hỏi",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Vẽ sơ đồ dữ liệu; xác định metric 1 trang và baseline",
          "SuccessCriteria": "Quyết định có baseline + hậu kiểm; thông điệp chart rõ ràng",
          "FailSignals": "Chart đẹp nhưng không trả lời câu hỏi; Kéo dữ liệu trước khi đặt câu hỏi",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Xử lý missing/outlier theo quy tắc đã định",
          "SuccessCriteria": "Quyết định có baseline + hậu kiểm; thông điệp chart rõ ràng",
          "FailSignals": "Chart đẹp nhưng không trả lời câu hỏi; Kéo dữ liệu trước khi đặt câu hỏi",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Mỗi biểu đồ chỉ truyền 1 thông điệp; ghi chú kết luận ngay trên đồ thị",
          "SuccessCriteria": "Quyết định có baseline + hậu kiểm; thông điệp chart rõ ràng",
          "FailSignals": "Chart đẹp nhưng không trả lời câu hỏi; Kéo dữ liệu trước khi đặt câu hỏi",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Hậu kiểm quyết định sau 1–2 tuần với cùng metric",
          "SuccessCriteria": "Quyết định có baseline + hậu kiểm; thông điệp chart rõ ràng",
          "FailSignals": "Chart đẹp nhưng không trả lời câu hỏi; Kéo dữ liệu trước khi đặt câu hỏi",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Trang metric",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Ảnh dashboard + note",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Làm 1 trang metric cho 1 quyết định/tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Tạo 1 dashboard nhỏ và ghi kết luận trên chart",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K22",
      "SkillName": "Soft networking – kết nối tầng cao",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Soft networking – kết nối tầng cao.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Định nghĩa ‘điểm sáng’ cá nhân 1 câu (giá trị độc đáo)",
          "SuccessCriteria": "≥1 cuộc hẹn sâu/2 tuần; kết nối tự đến theo nhịp xuất hiện",
          "FailSignals": "Spam, nói quá, bám víu; Xuất hiện thất thường ‘bùng rồi tắt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Chọn nhịp xuất hiện đều thay vì bùng nổ",
          "SuccessCriteria": "≥1 cuộc hẹn sâu/2 tuần; kết nối tự đến theo nhịp xuất hiện",
          "FailSignals": "Spam, nói quá, bám víu; Xuất hiện thất thường ‘bùng rồi tắt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Trao giá trị cụ thể trước; follow-up trong 24–48h",
          "SuccessCriteria": "≥1 cuộc hẹn sâu/2 tuần; kết nối tự đến theo nhịp xuất hiện",
          "FailSignals": "Spam, nói quá, bám víu; Xuất hiện thất thường ‘bùng rồi tắt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Không xin công nhận; giữ giọng tỉnh, tự tại",
          "SuccessCriteria": "≥1 cuộc hẹn sâu/2 tuần; kết nối tự đến theo nhịp xuất hiện",
          "FailSignals": "Spam, nói quá, bám víu; Xuất hiện thất thường ‘bùng rồi tắt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Bảo trì sổ liên hệ: ghi mục tiêu/giá trị – lịch sử tương tác",
          "SuccessCriteria": "≥1 cuộc hẹn sâu/2 tuần; kết nối tự đến theo nhịp xuất hiện",
          "FailSignals": "Spam, nói quá, bám víu; Xuất hiện thất thường ‘bùng rồi tắt’",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Danh sách liên hệ + log follow-up",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Mẫu mở đầu 1 câu",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "1 kết nối/tuần với follow-up rõ",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Viết 3 mẫu mở đầu/giới thiệu bản thân 1 câu",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K23",
      "SkillName": "Điều phối cảm xúc – hơi thở",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Điều phối cảm xúc – hơi thở.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Chọn kỹ thuật thở phù hợp mục tiêu (4-7-8, box, resonance)",
          "SuccessCriteria": "Chuyển trạng thái cảm xúc theo mục tiêu trong ≤3 phút",
          "FailSignals": "Thực hiện ‘gồng’/quá sức; Không có cue rõ ràng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Gắn thở với cue: trước họp, sau xung đột, trước khi chốt câu nói",
          "SuccessCriteria": "Chuyển trạng thái cảm xúc theo mục tiêu trong ≤3 phút",
          "FailSignals": "Thực hiện ‘gồng’/quá sức; Không có cue rõ ràng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Kết hợp âm thanh/nhạc nền để dẫn tần cảm xúc",
          "SuccessCriteria": "Chuyển trạng thái cảm xúc theo mục tiêu trong ≤3 phút",
          "FailSignals": "Thực hiện ‘gồng’/quá sức; Không có cue rõ ràng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Ghi nhận cảm giác cơ thể; không ép, chỉ dẫn nhịp",
          "SuccessCriteria": "Chuyển trạng thái cảm xúc theo mục tiêu trong ≤3 phút",
          "FailSignals": "Thực hiện ‘gồng’/quá sức; Không có cue rõ ràng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Đánh dấu hiệu quả sau phiên (cảm xúc, nhịp tim nếu có)",
          "SuccessCriteria": "Chuyển trạng thái cảm xúc theo mục tiêu trong ≤3 phút",
          "FailSignals": "Thực hiện ‘gồng’/quá sức; Không có cue rõ ràng",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Log phiên thở",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Playlist + ghi chú trạng thái",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "2 phiên thở có cue/ngày (2–5 phút)",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Playlist 3 track cho 3 trạng thái mục tiêu",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    },
    {
      "SkillID": "K24",
      "SkillName": "Thời đại – địa hình – không lệch vận",
      "Category": "Core-24K",
      "Priority": 3,
      "Difficulty": 3,
      "Status": "Learning",
      "GoalStatement": "Vận dụng bộ 24K cho lĩnh vực: Thời đại – địa hình – không lệch vận.",
      "MasteryDefinition": "Thể hiện ≥60% CP đạt chuẩn trong 14 ngày gần nhất.",
      "ReviewCycleDays": 7,
      "CP": [
        {
          "CPID": "CP01",
          "CPTitle": "Xác định chu kỳ lớn liên quan (công nghệ, địa chính trị, nhân khẩu)",
          "SuccessCriteria": "Hàng tuần có ‘nước đi nhỏ’ trên đúng trục; không bị cuốn theo game ngắn hạn",
          "FailSignals": "Đổi trục theo trend; Đốt năng lượng vào trận nhỏ trái trục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP02",
          "CPTitle": "Đọc ‘địa hình’ ngành/nghề: thế đẩy, thế hút, vùng trũng",
          "SuccessCriteria": "Hàng tuần có ‘nước đi nhỏ’ trên đúng trục; không bị cuốn theo game ngắn hạn",
          "FailSignals": "Đổi trục theo trend; Đốt năng lượng vào trận nhỏ trái trục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP03",
          "CPTitle": "Chọn trục cá nhân dài hạn (10 năm) phù hợp chu kỳ",
          "SuccessCriteria": "Hàng tuần có ‘nước đi nhỏ’ trên đúng trục; không bị cuốn theo game ngắn hạn",
          "FailSignals": "Đổi trục theo trend; Đốt năng lượng vào trận nhỏ trái trục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP04",
          "CPTitle": "Đặt chiến lược gài lực nhỏ đều đặn (compounding moves)",
          "SuccessCriteria": "Hàng tuần có ‘nước đi nhỏ’ trên đúng trục; không bị cuốn theo game ngắn hạn",
          "FailSignals": "Đổi trục theo trend; Đốt năng lượng vào trận nhỏ trái trục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        },
        {
          "CPID": "CP05",
          "CPTitle": "Tránh chiến thắng ngắn hạn làm lệch trục toàn cục",
          "SuccessCriteria": "Hàng tuần có ‘nước đi nhỏ’ trên đúng trục; không bị cuốn theo game ngắn hạn",
          "FailSignals": "Đổi trục theo trend; Đốt năng lượng vào trận nhỏ trái trục",
          "Weight": 3,
          "LinkedDrills": [
            "D01",
            "D02"
          ]
        }
      ],
      "Resources": [
        {
          "SourceType": "Evidence",
          "Title": "Thập niên đồ 1 trang",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        },
        {
          "SourceType": "Evidence",
          "Title": "Log nước đi tuần",
          "Ref": "",
          "CPMap": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Notes": ""
        }
      ],
      "Drills": [
        {
          "DrillID": "D01",
          "DrillName": "Viết 1 trang ‘thập niên đồ’ cá nhân",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        },
        {
          "DrillID": "D02",
          "DrillName": "Chọn 1 nước đi nhỏ nhưng đều đặn mỗi tuần",
          "CPFocus": [
            "CP01",
            "CP02",
            "CP03",
            "CP04",
            "CP05"
          ],
          "Protocol": "",
          "Baseline": 0,
          "Target": 3,
          "RecommendedFreq": "2x/tuần"
        }
      ],
      "Scenarios": [],
      "Review": {
        "ReviewDate": "",
        "NextReview": "",
        "Blockers": "",
        "FixPlan": "",
        "UpgradeIdeas": ""
      }
    }
  ]
}
</script><script id="af-audit-bridge">
(function(){
  function $(id){return document.getElementById(id);}
  function getJSON(id){ try{ var el=$(id); return el?JSON.parse(el.textContent||'{}'):null; }catch(e){ return null; } }
  function getLS(k, d){ try{ var x = JSON.parse(localStorage.getItem(k)||'null'); return (x==null?d:x); }catch(e){ return d; } }
  function setLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  var AF = getJSON('AF_DATA') || {skills:[]};
  if(!AF.skills||!AF.skills.length) return;
  // prefer not to overwrite existing dashboard dataset if already has phase info
  var cur = getLS('skills', null);
  var hasPhase = Array.isArray(cur) && cur.some(function(s){ return typeof s.phase === 'number' && s.phase >= 1 && s.phase <= 3; });
  function phaseFromCategory(cat){
    cat = (cat||'').toString().trim().toUpperCase();
    if(cat==='A' || cat==='B') return 1;
    if(cat==='C' || cat==='D') return 2;
    if(cat==='E' || cat==='F') return 3;
    return 1; // default to foundation
  }
  if(!hasPhase){
    var lsSkills = (AF.skills||[]).map(function(s){
      return {
        id: String(s.SkillID||s.SkillName||''),
        name: s.SkillName||'',
        category: s.Category||'',
        phase: phaseFromCategory(s.Category),
        status: s.Status||'',
        archetypes: [],
        note: s.MasteryDefinition||''
      };
    });
    setLS('skills', lsSkills);
  } else {
    // If exists but some entries missing phase, fill them
    cur.forEach(function(s){
      if(typeof s.phase !== 'number'){ s.phase = phaseFromCategory(s.category||''); }
    });
    setLS('skills', cur);
  }
  // Expose AF for other modules
  try{ window.AF_24CP = AF; }catch(_e){}
  // Trigger dashboard refresh if function present
  try{ if(typeof updateDashboard==='function'){ updateDashboard(); } }catch(_e){}

  try{
    var btn = document.getElementById('dash-refresh');
    if(!btn){
      // fallback: pick button with text 'Làm mới'
      var all = document.querySelectorAll('button');
      all.forEach(function(b){
        if(!btn && b.textContent && b.textContent.trim().toLowerCase().indexOf('làm mới')!==-1) btn=b;
      });
    }
    if(btn){
      btn.addEventListener('click', function(){
        setLS('skills', lsSkills);
        if(typeof updateDashboard==='function'){ updateDashboard(); }
      }, {capture:true});
    }
  }catch(_e){}

})();</script>
<script id="af-skill-js">
(function(){
  // ---- Helpers ----
  function $(id){return document.getElementById(id);}
  function safe(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function getJSON(id){ try{ var el=$(id); return el?JSON.parse(el.textContent||'{}'):null; }catch(e){ return null; } }
  function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function nowHM(){ const d=new Date(); return d.toTimeString().slice(0,5); }
  function loadLogs(){ try{ return JSON.parse(localStorage.getItem('logs_v1')||'[]'); }catch(e){ return []; } }
  function saveLogs(arr){ localStorage.setItem('logs_v1', JSON.stringify(arr)); }

  const AF = getJSON('AF_DATA') || {skills:[]};
  const catSel = $('afCategory'), skillSel = $('afSkill'), searchI = $('afSearch');
  const drillSel = $('afDrill');
  const cpWrap = $('afCPs'), resWrap = $('afRes'), drillsWrap = $('afDrills');
  const chosenWrap = $('afCPChosen');
  const nameTd = $('afSkillName'), metaTd = $('afMeta'), masteryTd = $('afMastery');
  const statCP=$('afStatCP'), stat7=$('afStat7'), statAvg=$('afStatAvg');
  const logsBody=$('afLogsBody'), msg=$('afMsg');

  if(!AF.skills || !AF.skills.length){
    $('af-skill-title').innerText = 'Skill Content A–F + Logs — 24CP (Không có dữ liệu)';
    return;
  }

  // ---- Build categories (A–F) ----
  const cats = Array.from(new Set(AF.skills.map(s=>s.Category||'Other'))).sort();
  catSel.innerHTML = '<option value="">Tất cả</option>' + cats.map(c=>'<option>'+safe(c)+'</option>').join('');

  // Date/Time defaults
  $('afDate').value = todayStr();
  $('afTime').value = nowHM();

  // State
  let currentSkill = null;
  let chosenCP = new Set(); // store CPID strings
  let logs = loadLogs();

  function filterSkills(){
    const key = (searchI.value||'').toLowerCase();
    const cat = catSel.value;
    const list = AF.skills.filter(s=> (cat? (s.Category===cat):true) && (
      !key || (s.SkillName||'').toLowerCase().includes(key) ||
      (s.CP||[]).some(cp=> (cp.CPTitle||'').toLowerCase().includes(key)) ||
      (s.Drills||[]).some(d=> (d.DrillName||'').toLowerCase().includes(key))
    ));
    skillSel.innerHTML = list.map((s,i)=>'<option value="'+safe(s.SkillName)+'">'+safe(s.SkillName)+'</option>').join('');
    if(list.length){ setSkill(list[0].SkillName); }
    else { setSkill(null); }
  }

  function findSkill(name){
    return AF.skills.find(s=> (s.SkillName||'')===name);
  }

  function setSkill(name){
    currentSkill = findSkill(name);
    chosenCP.clear();
    chosenWrap.innerHTML='';
    renderSkill();
    renderDrillSelect();
    renderLogs();
  }

  function renderSkill(){
    if(!currentSkill){
      nameTd.textContent='—'; metaTd.textContent='—'; masteryTd.textContent='—';
      cpWrap.innerHTML=''; drillsWrap.innerHTML='—'; resWrap.innerHTML='—';
      statCP.textContent='0'; stat7.textContent='0'; statAvg.textContent='—';
      return;
    }
    nameTd.textContent = currentSkill.SkillName || '—';
    metaTd.textContent = 'Ưu tiên: '+(currentSkill.Priority ?? '—')+' • Độ khó: '+(currentSkill.Difficulty ?? '—')+' • Chu kỳ ôn: '+(currentSkill.ReviewCycleDays ?? '—')+' ngày';
    masteryTd.textContent = currentSkill.MasteryDefinition || '—';
var goalEl = document.getElementById('afGoal'); if(goalEl){ goalEl.textContent = currentSkill.GoalStatement || '—'; }

    // CPs
    const cps = currentSkill.CP || [];
    cpWrap.innerHTML = cps.map(cp=>{
      const id = (cp.CPID || cp.CPTitle || '').toString();
      const checked = chosenCP.has(id) ? 'checked' : '';
      return '<label class="af-cp"><div class="af-flex"><input type="checkbox" class="af-cp-cb" data-cpid="'+safe(id)+'" '+checked+'> <strong>'+safe(cp.CPID || '')+'</strong> — '+safe(cp.CPTitle||'')+'</div>'
        + (cp.SuccessCriteria?('<div class="af-note">✓ '+safe(cp.SuccessCriteria)+'</div>'):'')
        + (cp.FailSignals?('<div class="af-note">⚠ '+safe(cp.FailSignals)+'</div>'):'')
        + '</label>';
    }).join('');
    // CP select handlers
    cpWrap.querySelectorAll('.af-cp-cb').forEach(cb=>{
      cb.addEventListener('change', function(){
        const id = this.getAttribute('data-cpid');
        if(this.checked) chosenCP.add(id); else chosenCP.delete(id);
        renderChosenCP();
      });
    });

    // Drills (read-only list on the right)
    const drills = currentSkill.Drills || [];
    drillsWrap.innerHTML = drills.length ? ('<ul style="margin:.2rem 0 0 1rem">'+drills.map(d=>'<li><strong>'+safe(d.DrillID||'')+':</strong> '+safe(d.DrillName||'') + (d.RecommendedFreq?(' <span class="af-chip">'+safe(d.RecommendedFreq)+'</span>'):'') +'</li>').join('')+'</ul>') : '—';

    // Resources
    const res = currentSkill.Resources || [];
    resWrap.innerHTML = res.length ? ('<ul style="margin:.2rem 0 0 1rem">'+res.map(r=>'<li><strong>'+safe(r.SourceType||'')+':</strong> '+safe(r.Title||'')+'</li>').join('')+'</ul>') : '—';

    // Stats
    statCP.textContent = cps.length.toString();
    computeStats7();
  }

  function renderChosenCP(){
    chosenWrap.innerHTML = Array.from(chosenCP).map(id=>'<span class="af-chip">'+safe(id)+'</span>').join(' ');
  }

  function renderDrillSelect(){
    const drills = (currentSkill && currentSkill.Drills)||[];
    drillSel.innerHTML = '<option value="">—</option>' + drills.map(d=>'<option value="'+safe(d.DrillID||'')+'">'+safe(d.DrillName||d.DrillID||'')+'</option>').join('');
  }

  function computeStats7(){
    if(!currentSkill){ stat7.textContent='0'; statAvg.textContent='—'; return; }
    const now = new Date();
    const start = new Date(now.getTime() - 6*24*3600*1000);
    const rows = logs.filter(l=> l.skill===currentSkill.SkillName && new Date(l.date) >= start);
    stat7.textContent = rows.length.toString();
    if(!rows.length){ statAvg.textContent = '—'; return; }
    const avg = (rows.reduce((a,b)=>a+(Number(b.score)||0),0)/rows.length).toFixed(1);
    statAvg.textContent = avg;
  }

  function renderLogs(){
    if(!currentSkill){ logsBody.innerHTML=''; return; }
    const rows = logs.filter(l=> l.skill===currentSkill.SkillName).slice(-100).reverse();
    logsBody.innerHTML = rows.map(l=>'<tr><td>'+safe(l.date||'')+'</td><td>'+safe(l.time||'')+'</td><td>'+safe((l.cp||[]).join(", "))+'</td><td>'+safe(l.duration||'')+'</td><td>'+safe(l.score||'')+'</td><td>'+safe(l.energy||'')+'</td><td>'+safe(l.drill||'')+'</td><td>'+safe(l.note||'')+'</td></tr>').join('');
  }

  // ---- Events ----
  catSel.addEventListener('change', filterSkills);
  searchI.addEventListener('input', filterSkills);
  skillSel.addEventListener('change', function(){ setSkill(this.value); });

  $('afClearSel').addEventListener('click', function(){
    chosenCP.clear();
    renderChosenCP();
    cpWrap.querySelectorAll('.af-cp-cb').forEach(cb=> cb.checked=false);
  });

  $('afSave').addEventListener('click', function(){
    msg.textContent='';
    if(!currentSkill){ msg.textContent='Chưa chọn kỹ năng.'; return; }
    const cp = Array.from(chosenCP);
    if(!cp.length){ msg.textContent='Chọn ít nhất 1 CP.'; return; }
    const date = $('afDate').value || todayStr();
    const time = $('afTime').value || nowHM();
    const duration = Number($('afDuration').value||0);
    const score = Number($('afScore').value||0);
    const energy = Number($('afEnergy').value||0);
    const drill = $('afDrill').value || '';
    const note = $('afNote').value || '';

    if(duration<=0){ msg.textContent='Thời lượng phải > 0.'; return; }
    if(score<0 || score>10){ msg.textContent='Điểm nằm trong [0,10].'; return; }
    if(energy && (energy<1 || energy>5)){ msg.textContent='Năng lượng trong [1,5].'; return; }

    const row = { date, time, skill: currentSkill.SkillName, cp, duration, score, energy, drill, note };
    logs.push(row);
    saveLogs(logs);
    renderLogs();
    computeStats7();
    msg.textContent='Đã lưu.';
    // giữ lựa chọn CP để log tiếp; có thể xóa nếu muốn
  });

  // ---- Init ----
  filterSkills();
  // Listen external log updates (from Audit micro-log)
  try{
    window.addEventListener('af-logs-updated', function(e){
      logs = loadLogs();
      renderLogs();
      computeStats7();
    });
  }catch(_e){}

  // Export/Import logs_v1
  (function(){
    try{
      var tbl = document.getElementById('afLogsTbl');
      if(tbl){
        var wrap = document.createElement('div');
        wrap.style.marginTop = '8px';
        var b1 = document.createElement('button'); b1.id='afExport'; b1.className='af-btn secondary'; b1.textContent='Export logs';
        var b2 = document.createElement('button'); b2.id='afImport'; b2.className='af-btn secondary'; b2.textContent='Import logs';
        var fi = document.createElement('input'); fi.type='file'; fi.accept='.json,application/json'; fi.style.display='none'; fi.id='afImportFile';
        wrap.appendChild(b1); wrap.appendChild(document.createTextNode(' ')); wrap.appendChild(b2); wrap.appendChild(fi);
        tbl.parentNode.insertBefore(wrap, tbl.nextSibling);

        b1.addEventListener('click', function(){
          var data = JSON.stringify(loadLogs(), null, 2);
          var blob = new Blob([data], {type:'application/json'});
          var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = 'logs_v1.json'; a.click();
          setTimeout(function(){ URL.revokeObjectURL(a.href); }, 1000);
        });
        b2.addEventListener('click', function(){ fi.click(); });
        fi.addEventListener('change', function(e){
          var file = e.target.files && e.target.files[0];
          if(!file) return;
          var rd = new FileReader();
          rd.onload = function(){
            try{
              var arr = JSON.parse(rd.result||'[]');
              if(Array.isArray(arr)){
                var cur = loadLogs();
                var merged = cur.concat(arr);
                localStorage.setItem('logs_v1', JSON.stringify(merged));
                logs = merged; renderLogs(); computeStats7();
                msg.textContent = 'Đã import '+arr.length+' log.';
              }else{ msg.textContent = 'File không hợp lệ.'; }
            }catch(err){ msg.textContent = 'Import lỗi: '+err; }
          };
          rd.readAsText(file);
        });
      }
    }catch(_e){}
  })();

})();
</script>
</main>
<!-- Modal Edit -->
<div aria-hidden="true" aria-labelledby="editTitle" aria-modal="true" class="modal" id="editModal" role="dialog">
<div class="dialog">
<div class="row">
<h3 id="editTitle">Chỉnh sửa kỹ năng</h3>
<div class="right">
<button class="btn small" id="btnCloseModal" type="button">✕ Đóng</button>
</div>
</div>
<div class="grid" style="margin-top:.5rem"><div class="col-12 section-title">Thông tin cơ bản</div>
<div class="col-6 field">
<label for="editName">Tên</label>
<input id="editName" type="text"/>
</div>
<div class="col-6 field">
<label for="editPhase">Phase</label>
<select id="editPhase">
<option value="1">1 • Tự lực</option>
<option value="2">2 • Gây ảnh hưởng</option>
<option value="3">3 • Điều phối</option>
</select>
</div>
<div class="col-12 section-title">Vai trò &amp; Cấu trúc</div>
<div class="col-6 field">
<label for="editRole">Vai trò (Role)</label>
<input id="editRole" placeholder="Quan sát / Gài mồi / Phản chiếu / Dẫn dụ / Kết liễu / Ẩn thân" type="text"/>
</div>
<div class="col-6 field">
<label for="editCore">Năng lực lõi (Core)</label>
<input id="editCore" placeholder="Mục tiêu/năng lực chính của kỹ năng" type="text"/>
</div>
<div class="col-12 field">
<label>Nhóm trụ kỹ năng (K1..K24)</label>
<div class="kpanel card" style="background:var(--surface);">
<div class="row" style="gap:.5rem;align-items:center">
<input aria-label="Tìm K hoặc tên..." id="clusterSearch" placeholder="Tìm K hoặc tên..." style="flex:1 1 240px;padding:.5rem;border:1px solid var(--outline);background:var(--surface-2);color:var(--text);border-radius:.6rem" type="text"/>
<button class="btn small" id="clusterSelectAll" type="button">Chọn hết</button>
<button class="btn small" id="clusterClearAll" type="button">Bỏ hết</button>
</div>
<div class="klist" id="klist" style="margin-top:.6rem; max-height: 240px; overflow:auto; border:1px solid var(--outline); border-radius:.6rem; padding:.35rem;">
<!-- items injected -->
</div>
<div class="muted" id="kfooter" style="margin-top:.45rem">Đã chọn: (chưa)</div>
</div>
</div>
<div class="col-6 field">
<label for="editGroup">Nhóm kỹ năng</label>
<select id="editGroup">
<option value="">-- Chọn nhóm --</option>
<option>Hard</option>
<option>Soft</option>
<option>Meta</option>
</select>
</div>
<div class="col-6 field">
<label for="editStatus">Trạng thái</label>
<select id="editStatus">
<option>Đang luyện</option>
<option>Tạm dừng</option>
<option>Hoàn tất nền</option>
</select>
</div>
<div class="col-12 section-title">Đo lường &amp; Ưu tiên</div>
<div class="col-6 field">
<label for="editLevel">Mức độ hiện tại</label>
<select id="editLevel">
<option value="1">1 - Beginner</option>
<option value="2">2 - Novice</option>
<option selected="" value="3">3 - Intermediate</option>
<option value="4">4 - Advanced</option>
<option value="5">5 - Expert</option>
</select>
</div>
<div class="col-6 field">
<label for="editPriority">Ưu tiên</label>
<select id="editPriority">
<option value="1">1</option>
<option value="2">2</option>
<option selected="" value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select>
</div>
<div class="col-6 field">
<label for="editEnergy">Độ hao năng lượng</label>
<select id="editEnergy">
<option value="1">1</option>
<option value="2">2</option>
<option selected="" value="3">3</option>
<option value="4">4</option>
<option value="5">5</option>
</select>
</div>
<div class="col-6 field">
<label for="editFreq">Tần suất mục tiêu</label>
<select id="editFreq">
<option value="daily">Hàng ngày</option>
<option selected="" value="weekly">Hàng tuần</option>
<option value="monthly">Hàng tháng</option>
</select>
</div>
<div class="col-12 section-title">Lịch &amp; Thẻ</div>
<div class="col-6 field">
<label for="editStart">Ngày bắt đầu</label>
<input id="editStart" type="date"/>
</div>
<div class="col-6 field">
<label for="editTags">Tags (phân tách bằng dấu phẩy)</label>
<input id="editTags" placeholder="speaking, negotiation" type="text"/>
</div>
<div class="col-12 field">
<label for="editNote">Ghi chú</label>
<textarea id="editNote"></textarea>
</div>
<div class="col-12 row">
<button class="btn" id="btnSaveSkill" type="button">✅ Lưu thay đổi</button>
</div>
</div>
</div>
</div>
<!-- Restore Modal -->
<div aria-hidden="true" aria-modal="true" class="modal" id="restoreModal" role="dialog">
<div class="dialog">
<div class="row">
<h3>Khôi phục dữ liệu kỹ năng</h3>
<div class="right"><button class="btn small" id="btnCloseRestore" type="button">✕ Đóng</button></div>
</div>
<div class="field">
<label>Chọn snapshot</label>
<select aria-label="restoreSelect" id="restoreSelect"></select>
</div>
<div class="row"><button class="btn" id="btnDoRestore" type="button">⟲ Khôi phục snapshot</button></div>
<div class="muted" style="margin-top:.5rem">Mỗi lần lưu thay đổi, hệ thống tự snapshot và giữ tối đa 10 bản gần nhất.</div>
</div>
</div>
<!-- Modal Quick Log -->
<div aria-hidden="true" aria-labelledby="logTitle" aria-modal="true" class="modal" id="logModal" role="dialog">
<div class="dialog">
<div class="row">
<h3 id="logTitle">Thêm ghi chú</h3>
<div class="right">
<button class="btn small" id="btnCloseLog" type="button">✕ Đóng</button>
</div>
</div>
<div class="field">
<label for="logInput">Nội dung</label>
<textarea id="logInput" placeholder="Ghi chú…"></textarea>
</div>
<div class="field"><label for="eviInput">Evidence (URL / mã)</label><input id="eviInput" placeholder="https://... hoặc mã tham chiếu" type="text"/></div><div class="row">
<button class="btn" id="btnSaveLogModal" type="button">💾 Lưu</button>
</div>
</div>
</div>
<footer>
    Bản đã <strong>loại trùng ID</strong>, <strong>hợp nhất render</strong>, <strong>sửa cú pháp</strong>, thêm <strong>toggle theme</strong> và <strong>a11y cho tab</strong>.
  </footer>
<script>
(() => {
  // Safe stub so first render works even if CP module loads later
  window.renderCPHTML = window.renderCPHTML || function(){ return ''; };
/* === K Map (24 trụ) === */
const K_MAP = {
  K1:"Tiếng Anh chiến lược", K2:"Tiếng Trung chiến lược", K3:"Kinh tế học thực chiến", K4:"Tài chính – Đầu tư cá nhân",
  K5:"Luật thực chiến", K6:"Kinh doanh – Thị trường", K7:"Tâm lý học chiến lược", K8:"AI – IT ứng dụng",
  K9:"Y học – Sinh học – Thân thể", K10:"Triết học – Logic – Phản tư", K11:"Chính trị – Quyền lực – Địa chính trị", K12:"Tâm linh chiến lược – khí – nghiệp",
  K13:"Sinh tồn – thực chiến nội tại", K14:"Mỹ học – nghệ thuật", K15:"Ngôn từ – giao tiếp – phản xạ", K16:"Sản xuất nội dung – thương hiệu",
  K17:"Làm chủ gene – phản xạ sinh học", K18:"Rewire hành vi – thay máu tiềm thức", K19:"Thiết kế hệ – hệ thống hoá", K20:"Siêu ghi nhớ – Meta-learning",
  K21:"Phân tích dữ liệu – chiến lược số", K22:"Soft networking – kết nối tầng cao", K23:"Điều phối cảm xúc – hơi thở", K24:"Thời đại – địa hình – không lệch vận"
};

const ARCH = ["Sirene","Void Jester","Strategic Shadow","Strategic Ghost","Omni Mind","Dark Sirene","Core Operator"];
const P_MAP = {
  "K1": {
    "name": "Chiến lược ngôn ngữ (EN)",
    "primary": "Sirene",
    "secondary": [
      "Strategic Shadow"
    ],
    "mechanism": "Dẫn dụ → Định vị → Cắt nhịp",
    "note": "Ngôn ngữ mềm, gài logic, không dùng để “tranh cãi”"
  },
  "K2": {
    "name": "Thông dịch & quan hệ TQ",
    "primary": "Strategic Ghost",
    "secondary": [
      "Void Jester"
    ],
    "mechanism": "Ẩn mình → Gài mồi → Thử hệ",
    "note": "Dịch = cài thông điệp, không chỉ truyền đạt"
  },
  "K3": {
    "name": "Định vị kinh tế vĩ mô",
    "primary": "Strategic Shadow",
    "secondary": [
      "Omni Mind"
    ],
    "mechanism": "Quan sát → Tách nhiễu → Định vị",
    "note": "Dùng khi cần đọc logic hệ thống không theo tin tức"
  },
  "K4": {
    "name": "Tự chủ tài chính cá nhân",
    "primary": "Core Operator",
    "secondary": [
      "Strategic Shadow"
    ],
    "mechanism": "Ghi dữ liệu → Phân tách → Điều chỉnh",
    "note": "Nhận diện rò rỉ nội lực qua dòng tiền sống"
  },
  "K5": {
    "name": "Tự vệ pháp lý & phản đòn",
    "primary": "Void Jester",
    "secondary": [
      "Dark Sirene"
    ],
    "mechanism": "Im lặng → Gài logic → Kết liễu",
    "note": "Không dùng công khai – phải đúng timing để phản đòn hợp pháp"
  },
  "K6": {
    "name": "Chiến lược sản phẩm & thị trường",
    "primary": "Strategic Shadow",
    "secondary": [
      "Sirene"
    ],
    "mechanism": "Quan sát → Thiết kế → Dẫn dụ",
    "note": "Không đẩy sale – dẫn bằng định vị sâu"
  },
  "K7": {
    "name": "Đọc – điều phối tâm lý người",
    "primary": "Sirene",
    "secondary": [
      "Void Jester"
    ],
    "mechanism": "Dò tầng → Phản ứng → Cấy phản xạ",
    "note": "Chỉ dùng khi kiểm soát ổn"
  },
  "K8": {
    "name": "Tự động hóa – sao lưu bản thể",
    "primary": "Strategic Ghost",
    "secondary": [
      "Core Operator"
    ],
    "mechanism": "Tách vai → Dựng phản xạ → Ẩn thân",
    "note": "Vận hành nền khi không hiện diện vật lý"
  },
  "K9": {
    "name": "Hồi phục sinh học – dưỡng thân",
    "primary": "Omni Mind",
    "secondary": [
      "Core Operator"
    ],
    "mechanism": "Ghi chu kỳ → Bắt trục lệch → Điều chỉnh",
    "note": "Hồi phục là chuyển mode nuôi khí"
  },
  "K10": {
    "name": "Định hình logic sống – phản tư",
    "primary": "Strategic Shadow",
    "secondary": [
      "Core Operator"
    ],
    "mechanism": "Xoay góc nhìn → Tái định nghĩa → Giữ trụ",
    "note": "Không làm lúc nhiễu cảm xúc – dễ lệch"
  },
  "K11": {
    "name": "Giải mã quyền lực & bối cảnh",
    "primary": "Void Jester",
    "secondary": [
      "Strategic Shadow"
    ],
    "mechanism": "Đọc trục quyền → Phản chiếu → Tránh chạm",
    "note": "Thấy hệ thống = kiểm soát, không tấn công"
  },
  "K12": {
    "name": "Bảo vệ khí – xử lý nhiễu tầng",
    "primary": "Dark Sirene",
    "secondary": [
      "Void Jester"
    ],
    "mechanism": "Khoanh vùng → Dứt điểm → Rút sạch",
    "note": "Chỉ dùng khi chắc chắn"
  },
  "K13": {
    "name": "Sinh tồn khi bị cô lập",
    "primary": "Strategic Ghost",
    "secondary": [
      "Core Operator"
    ],
    "mechanism": "Cắt neo → Bật tối thiểu → Giữ trụ",
    "note": "Dành cho phase mất hệ – sống ngầm"
  },
  "K14": {
    "name": "Mỹ cảm chiến lược – tạo khí chất",
    "primary": "Sirene",
    "secondary": [
      "Omni Mind"
    ],
    "mechanism": "Nạp đẹp → Định vị khí → Gài bản thể",
    "note": "Giữ từ trường, không phô diễn"
  },
  "K15": {
    "name": "Ngôn từ sát thương cao",
    "primary": "Void Jester",
    "secondary": [
      "Strategic Shadow"
    ],
    "mechanism": "Tịnh khẩu → Bắn điểm → Gãy phản xạ",
    "note": "Không dùng cảm tính – dùng sai phản tác dụng"
  },
  "K16": {
    "name": "Biến trải nghiệm thành ảnh hưởng",
    "primary": "Sirene",
    "secondary": [
      "Strategic Shadow"
    ],
    "mechanism": "Biến nội lực → Định vị → Tạo tin tưởng",
    "note": "Chọn mảnh giá trị cao để truyền"
  },
  "K17": {
    "name": "Điều chỉnh gene – phản xạ sinh học",
    "primary": "Core Operator",
    "secondary": [
      "Omni Mind"
    ],
    "mechanism": "Dò lệch → Chốt cơ chế → Phục hồi",
    "note": "Cho lệch chu kỳ dài – phải tracking"
  },
  "K18": {
    "name": "Cắt chu kỳ tổn thương",
    "primary": "Void Jester",
    "secondary": [
      "Strategic Ghost"
    ],
    "mechanism": "Nhận diện → Tháo móc → Reset hệ",
    "note": "Khi phát hiện tự phá – cách ly triệt để"
  },
  "K19": {
    "name": "Thiết kế hệ sống cá nhân",
    "primary": "Strategic Shadow",
    "secondary": [
      "Core Operator"
    ],
    "mechanism": "Dựng module → Rút công suất → Vận hành",
    "note": "Tạo hệ phản xạ chủ động – không cưỡng ép"
  },
  "K20": {
    "name": "Siêu học – Meta-learning",
    "primary": "Omni Mind",
    "secondary": [
      "Strategic Ghost"
    ],
    "mechanism": "Gắn khung → Nhận pattern → Tạo phản xạ",
    "note": "Học nhẹ – gài tầng truy xuất mới"
  },
  "K21": {
    "name": "Chiến lược dữ liệu & phân tích",
    "primary": "Strategic Shadow",
    "secondary": [
      "Omni Mind"
    ],
    "mechanism": "Tách cảm xúc → Kết nối logic → Quyết định",
    "note": "Cho chiến trường – tránh tầng cảm tính"
  },
  "K22": {
    "name": "Kết nối chiến lược – không gồng",
    "primary": "Sirene",
    "secondary": [
      "Omni Mind"
    ],
    "mechanism": "Nhận khí đúng tầng → Gắn điểm sáng → Không phản ứng quá mức",
    "note": "Không đi tìm người – người sẽ đến"
  },
  "K23": {
    "name": "Điều phối cảm xúc bằng âm thanh",
    "primary": "Sirene",
    "secondary": [
      "Void Jester"
    ],
    "mechanism": "Chuyển tần → Giải cảm → Điều khiển hành vi",
    "note": "Làm sạch bản thân trước"
  },
  "K24": {
    "name": "Chiến lược định hình thế kỷ",
    "primary": "Strategic Shadow",
    "secondary": [
      "Omni Mind"
    ],
    "mechanism": "Nhìn chu kỳ → Gài lực → Ảnh hưởng thời đại",
    "note": "Không để thắng trận nhỏ – giữ trục toàn cục"
  }
};

function parseClusters(str){
  if(!str) return [];
  const m = String(str).match(/K\d{1,2}/g) || [];
  return m.filter(k => K_MAP[k]);
}

function cleanNote(txt){
  if(!txt) return "";
  let t = String(txt);
  // Remove Role/Core/Clusters segments and common separators
  t = t.replace(/\bRole:\s*[^|\n•]+/gi, "");
  t = t.replace(/\bCore:\s*[^|\n•]+/gi, "");
  t = t.replace(/\bCluste(?:r|rs):\s*[^|\n•]+/gi, "");
  // Remove leftover separators like pipes, bullets, extra spaces
  t = t.replace(/[|•]+/g, " ");
  t = t.replace(/\s{2,}/g, " ");
  t = t.replace(/^[\s,;:-]+|[\s,;:-]+$/g, "");
  return t.trim();
}

  /* ============== State & Storage ============== */
  const storage = {
    get(key, fallback) {
      try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
      catch { return fallback; }
    },
    set(key, value) {
      try {
        if (key === "skills") {
          const prev = localStorage.getItem("skills");
          if (prev) {
            const backups = storage.get("skills_backups", []);
            backups.unshift({ at: new Date().toISOString(), data: JSON.parse(prev) });
            if (backups.length > 10) backups.pop();
            localStorage.setItem("skills_backups", JSON.stringify(backups));
          }
        }
      } catch (e) { /* ignore backup errors */ }
      localStorage.setItem(key, JSON.stringify(value));
    }
  };

  const el = (sel, root=document) => root.querySelector(sel);
  const els = (sel, root=document) => [...root.querySelectorAll(sel)];

  // Default dataset (used only if no local data)
  const defaultSkills = [
  {
    "id": "58d3e1ae-3fd6-48cb-b0ca-4df450b5a589",
    "name": "Chiến lược ngôn ngữ (EN)",
    "phase": 1,
    "note": "Role: Dẫn dụ | Core: Thao túng ngôn từ để chiếm quyền lực giao tiếp chiến lược | Cluster: K1"
  },
  {
    "id": "7f8b087d-dc18-4e0d-82b2-be82a66790ab",
    "name": "Thông dịch & quan hệ TQ",
    "phase": 2,
    "note": "Role: Gài mồi | Core: Cài thông tin chính trị – thương mại qua ngôn ngữ mềm | Cluster: K2"
  },
  {
    "id": "1e24e124-78c7-4254-a808-fc3ee14f0f67",
    "name": "Định vị kinh tế vĩ mô",
    "phase": 2,
    "note": "Role: Quan sát | Core: Đọc được dòng tiền – dự đoán vận động quốc gia | Cluster: K3"
  },
  {
    "id": "6b892e0b-cad5-4ec4-ae26-84a6be9c9f80",
    "name": "Tự chủ tài chính cá nhân",
    "phase": 1,
    "note": "Role: Phản chiếu | Core: Nhận diện sai lầm tài chính – điều chỉnh dòng tiền sống | Cluster: K4"
  },
  {
    "id": "b69efaa3-2eed-4a70-abbb-04be11f7dc0d",
    "name": "Tự vệ pháp lý & phản đòn",
    "phase": 1,
    "note": "Role: Kết liễu | Core: Kích hoạt cơ chế bảo vệ và tấn công đúng luật chơi | Cluster: K5"
  },
  {
    "id": "40d7bf3a-2195-4113-913b-5a654b72291c",
    "name": "Chiến lược sản phẩm & thị trường",
    "phase": 2,
    "note": "Role: Dẫn dụ | Core: Thiết kế hệ giá trị hút khách & chốt sale bằng insight | Cluster: K6"
  },
  {
    "id": "9e95cbe7-58ef-4d11-a61b-6d9835107166",
    "name": "Đọc – điều phối tâm lý người",
    "phase": 2,
    "note": "Role: Gài mồi | Core: Dò tâm trạng – cấy phản ứng – điều phối hành vi vi mô | Cluster: K7"
  },
  {
    "id": "79b776ac-b7ce-4eec-9f71-0d91dc1ce6a0",
    "name": "Tự động hóa – sao lưu bản thể",
    "phase": 1,
    "note": "Role: Ẩn thân | Core: Dựng hệ phản xạ kỹ thuật số để tồn tại không cần xuất hiện | Cluster: K8"
  },
  {
    "id": "54611f9f-70ff-48f4-9372-58339e449b5a",
    "name": "Hồi phục sinh học – dưỡng thân",
    "phase": 1,
    "note": "Role: Phản chiếu | Core: Theo dõi chu kỳ – tự điều chỉnh trước khi gãy trục sinh học | Cluster: K9"
  },
  {
    "id": "84063162-5761-4072-a776-a684f5f57314",
    "name": "Định hình logic sống – phản tư",
    "phase": 1,
    "note": "Role: Quan sát | Core: Xoay lại trục sống bằng phản tư – tránh lệch hệ | Cluster: K10"
  },
  {
    "id": "642a9d07-0c44-4c87-bb26-91a3b72f4201",
    "name": "Giải mã quyền lực & bối cảnh",
    "phase": 2,
    "note": "Role: Phản chiếu | Core: Thấy được trục vận hành hệ thống và vai trò bản thân | Cluster: K11"
  },
  {
    "id": "1d721d9c-ce83-4326-8b3f-6d6fc01a4e86",
    "name": "Bảo vệ khí – xử lý nhiễu tầng",
    "phase": 3,
    "note": "Role: Kết liễu | Core: Dứt điểm các nguồn rút khí – giữ sạch trường sống | Cluster: K12"
  },
  {
    "id": "3d54ad63-c98f-4644-b64c-be378c752a44",
    "name": "Sinh tồn & phản ứng khi bị cô lập",
    "phase": 1,
    "note": "Role: Ẩn thân | Core: Giữ trụ bản thể trong môi trường không ai cứu viện | Cluster: K13"
  },
  {
    "id": "b3e66f4e-e1d2-4305-a097-51a0e926f2f1",
    "name": "Mỹ cảm chiến lược – tạo khí chất",
    "phase": 2,
    "note": "Role: Dẫn dụ | Core: Kích hoạt trường khí quyến rũ bằng tầng thẩm mỹ sâu | Cluster: K14"
  },
  {
    "id": "2809a948-b74a-48a7-a891-8a26f25bc8e8",
    "name": "Ngôn từ sát thương cao",
    "phase": 2,
    "note": "Role: Phản chiếu | Core: Phóng ra ngôn từ làm lệch trục người khác mà không động tay | Cluster: K15"
  },
  {
    "id": "64254137-ad3e-4ba0-8107-35dd42ecdba9",
    "name": "Biến trải nghiệm thành ảnh hưởng",
    "phase": 2,
    "note": "Role: Gài mồi | Core: Gói trải nghiệm sống thành tài sản gây tín nhiệm tầng cao | Cluster: K16"
  },
  {
    "id": "954c953c-fe9d-4a45-b1e1-528e35d94a3d",
    "name": "Điều chỉnh gene – phản xạ sinh học",
    "phase": 1,
    "note": "Role: Quan sát | Core: Nhận diện lệch phản xạ – điều chỉnh lại phản ứng vật lý | Cluster: K17"
  },
  {
    "id": "8455f0be-5b97-4078-af02-706c4fc978ef",
    "name": "Tái lập hành vi – cắt chu kỳ tổn thương",
    "phase": 1,
    "note": "Role: Kết liễu | Core: Phá bỏ phản xạ cũ – thiết lập cơ chế phản ứng mới | Cluster: K18"
  },
  {
    "id": "0869541c-84a1-472a-aa2b-b0d40f9333ac",
    "name": "Thiết kế hệ sống cá nhân",
    "phase": 3,
    "note": "Role: Dẫn dụ | Core: Xây được mô hình sống – hệ thống vận hành mà không phải chạy tay | Cluster: K19"
  },
  {
    "id": "edd0520d-6256-4acc-938d-c8daf6ec5f94",
    "name": "Siêu học – Meta-learning",
    "phase": 1,
    "note": "Role: Gài mồi | Core: Cấy mô hình học tự động – ghi nhớ & truy xuất không lệch tầng | Cluster: K20"
  },
  {
    "id": "b402467c-a778-4125-bf59-23d352996f61",
    "name": "Chiến lược dữ liệu & phân tích",
    "phase": 2,
    "note": "Role: Quan sát | Core: Ra quyết định từ dữ liệu – không dính nhiễu cảm xúc | Cluster: K21"
  },
  {
    "id": "c2521052-55b3-486b-a033-63e1173e1941",
    "name": "Kết nối chiến lược – không gồng",
    "phase": 2,
    "note": "Role: Dẫn dụ | Core: Gặp người đúng tầng mà không cần tìm – tự tạo hấp dẫn tầng cao | Cluster: K22"
  },
  {
    "id": "0761185c-97ae-432c-a4d9-cb6ad8fd2e1d",
    "name": "Điều phối cảm xúc bằng âm thanh",
    "phase": 3,
    "note": "Role: Phản chiếu | Core: Chuyển hóa cảm xúc và luân xa thành vũ khí điều hướng tình huống | Cluster: K23"
  },
  {
    "id": "2ab1273b-c869-4e42-9588-494fe214cdff",
    "name": "Chiến lược định hình thế kỷ",
    "phase": 3,
    "note": "Role: Quan sát | Core: Nhận diện vận động thời đại – can thiệp đúng chu kỳ chuyển hóa | Cluster: K24"
  }
];

  let skills = storage.get("skills", defaultSkills);

  const personaData = [
  {
    "name": "Sirene",
    "flow": [
      "Giữ trục tỉnh → không nhìn đối phương ngay",
      "Thả tín hiệu nhẹ (khí – giọng – ánh mắt không đối đầu)",
      "Lặng rút – kết lại bằng khoảng trống",
      "Điều hòa nhịp thở – chỉnh tư thế",
      "Kéo giọng xuống thấp – giảm tiết lộ",
      "Nhìn chệch – phản xạ mềm, để người khác tự ngắt",
      "Đặt tín hiệu đầu tiên (giọng, khí, ánh mắt)",
      "Dẫn cảm xúc đối phương chạy theo",
      "Rút về giữa chừng – không đóng tròn → tạo nhu cầu tiếp cận"
    ],
    "skills": [
      "Lướt qua không để lại dấu",
      "Bật khí lạnh",
      "Rút lui có chủ đích",
      "Điều khí nền",
      "Giữ nhiệt độ sống",
      "Neo ánh mắt chệch hướng",
      "Neo cảm xúc tầng thấp",
      "Đặt giọng dẫn nhịp",
      "Tạo cảnh chưa kết"
    ]
  },
  {
    "name": "Strategic Shadow",
    "flow": [
      "Tắt năng lượng hiển thị",
      "Giảm phản ứng – thu tần số giọng",
      "Cắt mắt khỏi trung tâm không gian",
      "Bật chế độ phân tích thầm",
      "Ghi lại các sai số vi mô",
      "Neo trạng thái lạnh, không phản xạ",
      "Cấy tín hiệu lỗi nhỏ vào hành vi người khác",
      "Quan sát phản xạ – ghi dữ liệu",
      "Tái lập cấu trúc ngầm dựa trên nhịp lệch"
    ],
    "skills": [
      "Tắt khí tầng hiển",
      "Rút khỏi vùng radar",
      "Giảm tần sóng não ngoài",
      "Quét sai số tầng ngầm",
      "Neo phân tích nền",
      "Giữ trạng thái không ảnh",
      "Cấy lệch cảm xúc",
      "Dựng vòng phản xạ ngược",
      "Điều hướng bằng lỗi ẩn"
    ]
  },
  {
    "name": "Void Jester",
    "flow": [
      "Cười lệch – châm biếm tình huống",
      "Đặt câu hỏi ngược – làm lộ khe hở hệ thống",
      "Chặn logic bằng phản đề",
      "Đổi giọng – làm lệch nhịp giao tiếp",
      "Tạo cảm giác bất ổn cho đối phương",
      "Ép hệ thống tự lòi bug",
      "Dẫn dụ vào logic sai của chính đối phương",
      "Châm biếm – bóp méo – ép hệ tự mâu thuẫn",
      "Kết thúc bằng đòn phản đề trúng huyệt"
    ],
    "skills": [
      "Phản đề cười lạnh",
      "Bóc mặt nạ logic",
      "Gài đối thoại gãy sóng",
      "Đảo tầng biểu cảm",
      "Tạo sóng lệch",
      "Làm nhiễu logic xã hội",
      "Gương phản logic",
      "Đòn đảo tầng xã hội",
      "Hủy diệt bằng ngôn từ"
    ]
  },
  {
    "name": "Strategic Ghost",
    "flow": [
      "Giả thuận – mềm hóa biểu cảm",
      "Ghi nhớ vị trí quyền lực / các nút chuyển hệ",
      "Neo vào cấu trúc bị bỏ trống",
      "Gợi ý qua mặt nạ vai phụ",
      "Bẻ hướng từ hậu cảnh (qua các nút cảm xúc hoặc hệ niềm tin)",
      "Neo định hướng ngầm qua thói quen hệ thống",
      "Phân tích chuỗi logic vỡ hoặc rỗng",
      "Xây hệ thống ngầm dự phòng",
      "Dẫn hệ thống chuyển trục mà tưởng là tự nhiên"
    ],
    "skills": [
      "Ngụy ổn định",
      "Quét nút logic",
      "Chiếm slot tâm lý mềm",
      "Gợi hướng ẩn",
      "Bẻ trục niềm tin",
      "Neo phản xạ nền",
      "Cấy phản xạ nền",
      "Xây bóng hệ thống",
      "Chuyển trục không dấu vết"
    ]
  },
  {
    "name": "Omni Mind",
    "flow": [
      "Lập bản đồ yếu tố tồn tại",
      "Khoanh vùng điểm neo",
      "Dựng trục tạm thời để ổn định",
      "Cắt mù logic – dựng sơ đồ nhân quả",
      "Xác định trọng tâm hệ sống",
      "Chọn hướng dựa trên tổng hệ phản xạ",
      "Mô phỏng chuỗi 3–5 bước tới",
      "Phân tích feedback từng hệ",
      "Chốt trục chiến lược và lùi về tầng điều phối"
    ],
    "skills": [
      "Dựng hệ khí khẩn cấp",
      "Trục sống giả lập",
      "Cân bằng bất ổn",
      "Sơ đồ nhân quả",
      "Trục ưu tiên",
      "Điểm hoá giải tầng sâu",
      "Giả lập tương lai",
      "Phản xạ hệ chéo",
      "Thiết lập trục định mệnh"
    ]
  },
  {
    "name": "Dark Sirene",
    "flow": [
      "Kích hoạt aura độc lập – tách năng lượng",
      "Dẫn khí vào khu vực phản xạ đối phương (ánh mắt – giọng nói – ngôn ngữ hình thể)",
      "Gài lệch cảm xúc – rút lùi giữ trục",
      "Xác định điểm yếu cảm xúc đối phương",
      "Gài điểm gợi cảm – dẫn dụ soft response",
      "Neo lại bằng logic – cắt mềm liên kết cảm xúc",
      "Thiết lập hình ảnh – khí – giọng làm mồi chủ lực",
      "Đưa hành vi vào vùng “gợi cảm xúc + phản ứng” của đối phương",
      "Lật logic – tạo định nghĩa mới về bản thân trong não đối phương"
    ],
    "skills": [
      "Tách tầng cảm giác",
      "Khí cảm phản đòn",
      "Gài lệch – đóng van",
      "Định vị cảm xúc yếu",
      "Neo gợi – dẫn dụ",
      "Cắt cảm xúc đúng nhịp",
      "Thiết lập avatar khí",
      "Cấy phản xạ mềm",
      "Thay đổi định nghĩa đối tượng"
    ]
  },
  {
    "name": "Core Operator",
    "flow": [
      "Dò lệch (sinh học – thần kinh – khí)",
      "Kích hoạt chuỗi “cứu hệ”: nghỉ – hồi phục – dưỡng sinh",
      "Ghi log – khóa phản xạ lặp",
      "Lọc chuỗi hành vi – phát hiện trùng/đối kháng",
      "Ưu tiên theo khí – mục tiêu – chu kỳ năng lượng",
      "Tái thiết hành vi – cập nhật định nghĩa sống",
      "Tổng hợp dữ liệu hành vi – khí – tình huống",
      "Tái mã hóa định mệnh cá nhân (Destiny Re-Coding)",
      "Lập chuỗi phản xạ mục tiêu – chiến thuật hóa vòng đời"
    ],
    "skills": [
      "Phát hiện lệch sống",
      "Kích hoạt bản năng bảo trì",
      "Khóa lặp phản tổn",
      "Tái tổ hợp dòng hành vi",
      "Lập thứ tự ưu tiên sống",
      "Cập nhật phản xạ theo chu kỳ năng lượng",
      "Ghi dữ liệu hành vi sống",
      "Tái mã hóa định mệnh",
      "Chiến thuật hóa vòng sống cá nhân"
    ]
  }
];

  /* ============== Theme ============== */
  const themeToggle = el("#themeToggle");
  function applyTheme(t) {
    document.documentElement.setAttribute("data-theme", t);
    themeToggle.setAttribute("aria-pressed", String(t === "dark"));
  }
  const savedTheme = storage.get("theme", null);
  const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  applyTheme(savedTheme ?? (prefersDark ? "dark" : "light"));
  themeToggle.addEventListener("click", () => {
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    const next = cur === "dark" ? "light" : "dark";
    applyTheme(next);
    storage.set("theme", next);
  });

  /* ============== Tabs with A11y + Persist ============== */
  const tabButtons = els(".tab");
  const views = els("section.view");
  function showTab(id) {
    for (const b of tabButtons) {
      const selected = b.getAttribute("aria-controls") === id;
      b.setAttribute("aria-selected", String(selected));
    }
    for (const v of views) v.classList.toggle("active", v.id === id);
    storage.set("activeTab", id);
  }
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => showTab(btn.getAttribute("aria-controls")));
    btn.addEventListener("keydown", (e) => {
      const idx = tabButtons.indexOf(btn);
      if (e.key === "ArrowRight") tabButtons[(idx + 1) % tabButtons.length].focus();
      if (e.key === "ArrowLeft") tabButtons[(idx - 1 + tabButtons.length) % tabButtons.length].focus();
      if (e.key === "Enter" || e.key === " ") showTab(btn.getAttribute("aria-controls"));
    });
  });
  // Default to skills tab on first load since dashboard was removed
  const initialTab = storage.get("activeTab", "skillsSec");
  showTab(initialTab);

  /* ============== Skills Rendering (single source of truth) ============== */
  const skillsList = el("#skillsList");
  const personaFilter = el('#personaFilter');
  const onlyCompat = el('#onlyCompat');
  const phaseFilter = el("#phaseFilter");
  const searchBox = el("#searchBox");
  const btnAddSkill = el("#btnAddSkill");
  const btnExport = el("#btnExport");
  const btnImport = el("#btnImport");
  const fileImport = el("#fileImport");

  function renderSkills() {
    const personaSel = personaFilter ? personaFilter.value : '';
    const onlyOK = onlyCompat ? !!onlyCompat.checked : false;
    const q = (searchBox.value || "").toLowerCase().trim();
    const pf = (typeof phaseFilter!=='undefined' && phaseFilter) ? phaseFilter.value : '';
    const filtered = skills.filter(s => {
      const hit = !q || (s.name?.toLowerCase().includes(q) || s.note?.toLowerCase().includes(q));
      const phaseOk = !pf || String(s.phase) === pf;
      return hit && phaseOk;
    });

    // grid layout: 3 columns on desktop
    skillsList.innerHTML = "";
    filtered.forEach(s => {
      const isCompat = !personaSel || (s.archetypes||[]).includes(personaSel);
      if(onlyOK && !isCompat) return;
      const col = document.createElement("div");
      col.className = "col-4 card";
      
col.innerHTML = `
  <div class="skill-card" data-id="${s.id}">
    <div class="skill-head">
      <div class="title-row">
        <h3>${escapeHtml(s.name || "Chưa đặt tên")}</h3>
        <span class="tag ${phaseClass(s.phase)} phase-pill">${phaseLabel(s.phase)}</span>
      </div>
      <div class="skill-actions">
        <button class="btn small act-edit">✎ Sửa</button>
        <button class="btn small act-log">🧾 Log</button>
      </div>
    </div>

    ${(s.status || s.level || s.priority) ? `
      <div class="meta-row">
        ${s.status?`<span class="tag sm">${escapeHtml(s.status)}</span>`:""}
        ${s.level?`<span class="tag sm">L${s.level}</span>`:""}
        ${s.priority?`<span class="tag sm">P${s.priority}</span>`:""}
      </div>` : ""}

    <div class="muted">${s.role ? `<strong>Role:</strong> ${escapeHtml(s.role)} • ` : ""}${s.core ? `<strong>Core:</strong> ${escapeHtml(s.core)} ` : ""}</div>
    ${(s.archetypes&&s.archetypes.length)?`<div class="row" style="margin-top:.35rem;gap:.35rem;flex-wrap:wrap;">${s.archetypes.map(a=>`<span class="tag sm">${escapeHtml(a)}</span>`).join("")}</div>`:""}
    ${personaSel? ( (s.archetypes||[]).includes(personaSel) ? `<span class="badge-ok">✓ Phù hợp ${personaSel}</span>` : `<span class="badge-warn">🚫 Không hợp ${personaSel}</span>`): ""}
    ${(s.clusters && s.clusters.length) ? `<div class="row" style="margin-top:.5rem;gap:.4rem;flex-wrap:wrap;">${s.clusters.map(k=>`<span class="chip sm" title="${K_MAP[k]||""}">${k}</span>`).join("")}</div>` : ""}
    ${s.tags && s.tags.length ? `<div class="row" style="margin-top:.3rem;gap:.35rem;flex-wrap:wrap;">${s.tags.map(t=>`<span class="tag sm">${escapeHtml(t)}</span>`).join("")}</div>` : ""}
    ${s.note ? `<div class="muted" style="margin-top:.4rem">${escapeHtml(s.note)}</div>` : ""}
  ${renderCPHTML(s)}
  </div>
`;

      skillsList.appendChild(col);
    });
  }

  function phaseLabel(p) { return p==1?"Tự lực": p==2?"Gây ảnh hưởng": p==3?"Điều phối":"-"; }
  function phaseClass(p) {
    if (p == 1) return "phase-1";
    if (p == 2) return "phase-2";
    if (p == 3) return "phase-3";
    return "";
  }
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // Event delegation for single binding
  skillsList.addEventListener("click", (e) => {
    const card = e.target.closest(".skill-card");
    if (!card) return;
    const id = card.getAttribute("data-id");
    const skill = skills.find(x => x.id === id);
    if (!skill) return;

    if (e.target.closest(".act-edit")) {
      openEdit(skill);
    } else if (e.target.closest(".act-log")) {
      openQuickLog(skill);
    }
  });

  // Filters
  [searchBox].forEach(elm => elm.addEventListener("input", debounce(()=>{ renderSkills(); updateDashboard(); }, 220)));

  // Add / Export / Import
  btnAddSkill.addEventListener("click", () => {
    editingId = null;
    editName.value = "";
    editPhase.value = "1";
    editNote.value = "";
    editRole.value = "";
    editCore.value = "";
    setSelectedClusters([]);
    editGroup.value = "";
    editStatus.value = "Đang luyện";
    editLevel.value = "3";
    editPriority.value = "3";
    editEnergy.value = "3";
    editFreq.value = "weekly";
    editStart.value = "";
    editTags.value = "";
    editModal.classList.add("open");
    editModal.setAttribute("aria-hidden", "false");
    setTimeout(()=> editName && editName.focus(), 0);
    trapFocus(editModal);
  });

  btnExport.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(skills, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "skills-export.json"; a.click();
    URL.revokeObjectURL(url);
  });
  btnImport.addEventListener("click", () => fileImport.click());
  fileImport.addEventListener("change", async () => {
    const file = fileImport.files?.[0]; if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (!Array.isArray(data)) throw new Error("Data không phải mảng");
      // normalize
      skills = data.map(s => ({ id: s.id || crypto.randomUUID(), name: s.name || "", phase: Number(s.phase) || 1, note: s.note || "" }));
      storage.set("skills", skills);
      renderSkills(); updateDashboard();
    } catch (err) {
      toast("Lỗi import: " + err.message);
    } finally {
      fileImport.value = "";
    }
  });

  /* ============== Restore Modal ============== */
  const restoreModal = el('#restoreModal');
  const btnRestore = el('#btnRestore');
  const btnCloseRestore = el('#btnCloseRestore');
  const btnDoRestore = el('#btnDoRestore');
  const restoreSelect = el('#restoreSelect');
  function openRestore(){
    const backups = storage.get('skills_backups', []);
    restoreSelect.innerHTML = '';
    backups.forEach((b, i)=>{
      const opt = document.createElement('option');
      opt.value = String(i);
      const count = Array.isArray(b.data) ? b.data.length : 0;
      opt.textContent = `${new Date(b.at).toLocaleString()} — ${count} kỹ năng`;
      restoreSelect.appendChild(opt);
    });
    if(!backups.length){ const opt = document.createElement('option'); opt.textContent = 'Không có snapshot'; restoreSelect.appendChild(opt); }
    restoreModal.classList.add('open');
    restoreModal.setAttribute('aria-hidden','false');
    setTimeout(()=> restoreSelect && restoreSelect.focus(), 0);
    trapFocus(restoreModal);
  }
  btnRestore && btnRestore.addEventListener('click', openRestore);
  btnCloseRestore && btnCloseRestore.addEventListener('click', ()=>{ restoreModal.classList.remove('open'); restoreModal.setAttribute('aria-hidden','true'); untrapFocus(restoreModal); });
  btnDoRestore && btnDoRestore.addEventListener('click', ()=>{
    const backups = storage.get('skills_backups', []);
    const idx = Number(restoreSelect.value||0);
    if(!backups[idx] || !Array.isArray(backups[idx].data)) { toast('Không có dữ liệu'); return; }
    skills = backups[idx].data.map(normalizeSkill);
    storage.set('skills', skills); // this will also create a new snapshot of previous state
    renderSkills(); updateDashboard();
    restoreModal.classList.remove('open'); restoreModal.setAttribute('aria-hidden','true');
  });

  /* ============== Edit Modal ============== */
  /* Pre-populate clusters list */
  const klist = el('#klist');
  const kfooter = el('#kfooter');
  function fillClusterOptions(){
    if(!klist) return;
    klist.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'kgrid';
    for(const k in K_MAP){
      const row = document.createElement('label');
      row.className = 'kitem';
      row.innerHTML = `<input type="checkbox" value="${k}"> <span class="kcode">${k}</span> <span class="kname">${K_MAP[k]}</span>`;
      const col = document.createElement('div');
      col.className = 'col'; col.appendChild(row); grid.appendChild(col);
    }
    klist.appendChild(grid);
  }
  function setSelectedClusters(values){
    const set = new Set(values||[]);
    klist && klist.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = set.has(cb.value));
    updateKFooter();
  }
  function getSelectedClusters(){
    return klist ? [...klist.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>cb.value) : [];
  }
  function updateKFooter(){
    const arr = getSelectedClusters();
    kfooter && (kfooter.textContent = 'Đã chọn: ' + (arr.length? arr.join(', ') : '(chưa)'));
  }
  const clusterSearch = el('#clusterSearch');
  const clusterSelectAll = el('#clusterSelectAll');
  const clusterClearAll = el('#clusterClearAll');
  clusterSearch && clusterSearch.addEventListener('input', () => {
    const q = clusterSearch.value.toLowerCase().trim();
    klist.querySelectorAll('.kitem').forEach(item => {
      const txt = (item.textContent||'').toLowerCase();
      item.parentElement.hidden = q && !txt.includes(q);
    });
  });
  clusterSelectAll && clusterSelectAll.addEventListener('click', () => {
    klist.querySelectorAll('.kitem input[type="checkbox"]').forEach(cb=>{ if(!cb.closest('.col').hidden) cb.checked = true; });
    updateKFooter();
  });
  clusterClearAll && clusterClearAll.addEventListener('click', () => {
    klist.querySelectorAll('.kitem input[type="checkbox"]').forEach(cb=> cb.checked = false);
    updateKFooter();
  });
  klist && klist.addEventListener('change', (e)=>{ if(e.target.matches('input[type="checkbox"]')) updateKFooter(); });

  function normalizeSkill(s){
    // Derive fields from note if missing
    if(!s.role && s.note){
      const m = s.note.match(/Role:\s*([^|]+)/i);
      if(m) s.role = m[1].trim();
    }
    if(!s.core && s.note){
      const m = s.note.match(/Core:\s*([^|]+)/i);
      if(m) s.core = m[1].trim();
    }
    if(!s.clusters){
      // Support both 'Cluster:' and 'Clusters:'
      let m = s.note && s.note.match(/Cluste(?:r|rs):\s*([^\n]+)/i);
      if(m){ s.clusters = parseClusters(m[1]); }
    }
    if(!Array.isArray(s.clusters)) s.clusters = [];
    s.groupType = s.groupType || s.group || "";
    s.status = s.status || "Đang luyện";
    s.level = Number(s.level || 3);
    s.priority = Number(s.priority || 3);
    s.energy = Number(s.energy || 3);
    s.freq = s.freq || "weekly";
    s.startDate = s.startDate || "";
    if(typeof s.tags === 'string') s.tags = s.tags.split(',').map(t=>t.trim()).filter(Boolean);
    if(!Array.isArray(s.tags)) s.tags = [];
    const archSet = new Set();
    (s.clusters||[]).forEach(k => { const m = P_MAP[k]; if(m){ archSet.add(m.primary); (m.secondary||[]).forEach(z=>archSet.add(z)); } });
    s.archetypes = Array.from(archSet);
    s.note = cleanNote(s.note);
    return s;
  }

  const editModal = el("#editModal");
  const btnCloseModal = el("#btnCloseModal");
  const btnSaveSkill = el("#btnSaveSkill");
  const editName = el("#editName");
  const editPhase = el("#editPhase");
  const editNote = el("#editNote");

  let editingId = null;
  fillClusterOptions();

  function openEdit(skill) {
    skill = normalizeSkill({...skill});
    editingId = skill.id;
    editName.value = skill.name || "";
    editPhase.value = String(skill.phase || 1);
    editNote.value = skill.note || "";
    editRole.value = skill.role || "";
    editCore.value = skill.core || "";
    setSelectedClusters(skill.clusters || []);
    editGroup.value = skill.groupType || "";
    editStatus.value = skill.status || "Đang luyện";
    editLevel.value = String(skill.level || 3);
    editPriority.value = String(skill.priority || 3);
    editEnergy.value = String(skill.energy || 3);
    editFreq.value = skill.freq || "weekly";
    editStart.value = skill.startDate || "";
    editTags.value = (skill.tags||[]).join(', ');
    editModal.classList.add("open");
    editModal.setAttribute("aria-hidden", "false");
    setTimeout(()=> editName && editName.focus(), 0);
    trapFocus(editModal);
  }
  
  /* ===== Quick Log Modal ===== */
  let currentLogSkillId = null;
  const logModal = el('#logModal');
  const btnCloseLog = el('#btnCloseLog');
  const btnSaveLogModal = el('#btnSaveLogModal');
  const logInput = el('#logInput');

  function openQuickLog(skill){
    currentLogSkillId = skill?.id || null;
    logInput.value = '';
    logInput.placeholder = `Ghi chú cho: ${skill?.name || ''}`;
    logModal.classList.add('open');
    logModal.setAttribute('aria-hidden','false');
    setTimeout(()=> logInput && logInput.focus(), 0);
    trapFocus(logModal);
  }
  function closeQuickLog(){
    logModal.classList.remove('open');
    logModal.setAttribute('aria-hidden','true');
    untrapFocus(logModal);
  }
  btnCloseLog && btnCloseLog.addEventListener('click', closeQuickLog);
  logModal && logModal.addEventListener('click', (e)=>{ if(e.target===logModal) closeQuickLog(); });
  btnSaveLogModal && btnSaveLogModal.addEventListener('click', ()=>{
    const text = (logInput.value||'').trim();
    if(!text){ toast('Chưa có nội dung.'); return; }
    const logs = storage.get("skill_logs", {});
    const arr = logs[currentLogSkillId] || [];
    arr.push({ stamp: new Date().toISOString(), text });
    logs[currentLogSkillId] = arr;
    storage.set("skill_logs", logs);
    toast('Đã lưu log.');
    closeQuickLog();
  });
function closeEdit() {
    editModal.classList.remove("open");
    editModal.setAttribute("aria-hidden", "true");
    untrapFocus(editModal);
  }

  btnCloseModal.addEventListener("click", closeEdit);
  editModal.addEventListener("click", (e) => {
    if (e.target === editModal) closeEdit();
  });
  btnSaveSkill.addEventListener("click", () => {
    const payload = {
      name: editName.value.trim(),
      phase: Number(editPhase.value) || 1,
      note: editNote.value.trim(),
      role: editRole.value.trim(),
      core: editCore.value.trim(),
      clusters: getSelectedClusters(),
      groupType: editGroup.value,
      status: editStatus.value,
      level: Number(editLevel.value||3),
      priority: Number(editPriority.value||3),
      energy: Number(editEnergy.value||3),
      freq: editFreq.value,
      startDate: editStart.value,
      tags: editTags.value.split(',').map(t=>t.trim()).filter(Boolean)
    };
    if(!payload.name){ toast('Nhập tên kỹ năng'); return; }

    if (!editingId) {
      // Add new
      skills.unshift({ id: crypto.randomUUID(), ...payload });
    } else {
      const idx = skills.findIndex(s => s.id === editingId);
      if (idx >= 0) skills[idx] = normalizeSkill({ ...skills[idx], ...payload });
    }
    storage.set("skills", skills);
    renderSkills(); updateDashboard(); closeEdit();
  });

  /* ============== Persona ============== */
  const personaSelect = el("#personaSelect");
  const personaFlow = el("#personaFlow");
  const personaSkillPills = el("#personaSkillPills");

  // populate persona list (avoid Object.keys on arrays)
  personaData.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.name; opt.textContent = p.name;
    personaSelect.appendChild(opt);
  });
  function updatePersona() {
    const p = personaData.find(x => x.name === personaSelect.value) || personaData[0];
    personaFlow.value = (p.flow || []).join("\n");
    personaSkillPills.innerHTML = "";
    let list = (p.skills || []).slice(0, 50);
    list.forEach(name => {
      const span = document.createElement("span");
      span.className = "chip sm";
      span.textContent = name;
      personaSkillPills.appendChild(span);
    });
  }
  personaSelect.addEventListener("change", updatePersona);

  /* ============== Dashboard ============== */
  let chartPhase = null;
  let chartStatus = null;
  const dashPersona = el('#dashPersona');
  if(dashPersona && dashPersona.childElementCount<=1){ ARCH.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; dashPersona.appendChild(o); }); dashPersona.addEventListener('change', updateDashboard); }

  function updateDashboard() {
    const counts = {1:0,2:0,3:0};
    const psel = dashPersona ? dashPersona.value : '';
    const source = psel ? skills.filter(s => (s.archetypes||[]).includes(psel)) : skills;
    for (const s of source) { if (counts[s.phase] !== undefined) counts[s.phase]++; }
    const statusCounts = {};
    for (const s of source){ const st = s.status||'Khác'; statusCounts[st]=(statusCounts[st]||0)+1; }

    return; // dashboard removed
const ctx = null;
    if(!ctx || (ctx.tagName&&ctx.tagName!=='CANVAS')) return;
    if (chartPhase) { chartPhase.destroy(); chartPhase = null; }
    chartPhase = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Phase 1", "Phase 2", "Phase 3"],
        datasets: [{
          label: "Số kỹ năng",
          data: [counts[1], counts[2], counts[3]]
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false, devicePixelRatio: (window.devicePixelRatio||1),
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });
  
  if (typeof updateStatusChart === 'function') { updateStatusChart(statusCounts); }
}
  // Only bind refresh dashboard button if it exists (dashboard removed in this version)
  const btnRefreshDashEl = el("#btnRefreshDash");
  if (btnRefreshDashEl) btnRefreshDashEl.addEventListener("click", updateDashboard);
  
function updateStatusChart(statusCounts){
const ctx2 = null;
  if(!ctx2 || (ctx2.tagName&&ctx2.tagName!=='CANVAS')) return;
  if(chartStatus){ chartStatus.destroy(); chartStatus=null; }
  const labels2 = Object.keys(statusCounts);
  chartStatus = new Chart(ctx2, { type:'bar', data:{ labels:labels2, datasets:[{ label:'Theo trạng thái', data: labels2.map(k=>statusCounts[k]||0)}]}, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{beginAtZero:true, ticks:{precision:0}} } }});

  
}
/* moved status chart into updateStatusChart() */
/* ============== Audit ============== */
  const quickLog = el("#quickLog");
  const btnSaveLog = el("#btnSaveLog");
  const logStatus = el("#logStatus");
  btnSaveLog.addEventListener("click", () => {
    const text = quickLog.value.trim();
    if (!text) { logStatus.textContent = "Chưa có nội dung."; return; }
    const logs = storage.get("audit_logs", []);
    logs.push({ at: new Date().toISOString(), text });
    storage.set("audit_logs", logs);
    quickLog.value = "";
    logStatus.textContent = "Đã lưu.";
    setTimeout(() => logStatus.textContent = "", 1500);
  });

  /* ============== Persona Filter Init ============== */
  if(personaFilter){ ARCH.forEach(p => { const opt = document.createElement('option'); opt.value=p; opt.textContent=p; personaFilter.appendChild(opt); }); }
  personaFilter && personaFilter.addEventListener('change', ()=>{ renderSkills(); updateDashboard(); });

  /* ============== Init ============== */
  // Normalize legacy notes → fields (role/core/clusters) – không ghi đè storage
  skills = skills.map(normalizeSkill);
  renderSkills();
  updateDashboard();
  updatePersona();
})();

  /* ===== Toast + Focus Trap Utils ===== */
  function toast(msg, timeout=1600){
    const wrap = document.getElementById('toastContainer');
    if (!wrap) { try { alert(String(msg||'')); } catch(_){} return; }
    const node = document.createElement('div');
    node.className = 'toast';
    node.textContent = String(msg || '');
    wrap.appendChild(node);
    setTimeout(()=>{ node.style.opacity='0'; node.style.transform='translateY(6px)'; }, Math.max(800, timeout-300));
    setTimeout(()=>{ node.remove(); }, timeout);
  }

  function trapFocus(modal){
    const fsel = 'button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])';
    const focusables = Array.from(modal.querySelectorAll(fsel)).filter(el=>!el.disabled && el.offsetParent!==null);
    const first = focusables[0] || modal, last = focusables[focusables.length-1] || modal;
    function loop(e){
      if(e.key !== 'Tab') return;
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    modal.__trapLoop = loop;
    modal.addEventListener('keydown', loop);
  }
  function untrapFocus(modal){
    if(modal && modal.__trapLoop){ modal.removeEventListener('keydown', modal.__trapLoop); delete modal.__trapLoop; }
  }


  function debounce(fn, ms=220){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

</script>
<div aria-atomic="true" aria-live="polite" class="toast-container" id="toastContainer"></div>
<div aria-labelledby="useCaseTitle" aria-modal="true" id="useCaseModal" role="dialog">
<div class="dialog">
<div class="row" style="justify-content:space-between;align-items:center">
<h3 id="useCaseTitle" style="margin:0">Thêm Use Case</h3>
<button class="p1-btn" id="p1-close-uc" type="button">Đóng</button>
</div>
<div class="row">
<div style="flex:1">
<label>Ngày</label>
<input aria-label="ucDate" id="ucDate" type="date"/>
</div>
<div style="flex:1">
<label>Persona</label>
<input aria-label="ví dụ: T-04.6" id="ucPersona" placeholder="ví dụ: T-04.6" type="text"/>
</div>
<div style="flex:2">
<label>Context</label>
<input aria-label="mô tả ngắn tình huống" id="ucContext" placeholder="mô tả ngắn tình huống" type="text"/>
</div>
</div>
<div class="row">
<div style="flex:2">
<label>Skills dùng (id/tên; ngăn cách bởi dấu phẩy)</label>
<input aria-label="SK-001, SK-017 hoặc tên kỹ năng" id="ucSkills" placeholder="SK-001, SK-017 hoặc tên kỹ năng" type="text"/>
</div>
<div style="flex:1">
<label>Kết quả</label>
<select aria-label="ucOutcome" id="ucOutcome">
<option value="win">win</option>
<option value="neutral">neutral</option>
<option value="loss">loss</option>
</select>
</div>
<div style="flex:1">
<label>Δ Năng lượng (âm nếu tiêu hao)</label>
<input aria-label="ucDelta" id="ucDelta" type="number" value="-5"/>
</div>
</div>
<div class="row">
<div style="flex:1">
<label>Ghi chú</label>
<textarea aria-label="ghi chú ngắn" id="ucNotes" placeholder="ghi chú ngắn"></textarea>
</div>
</div>
<div class="row" style="justify-content:flex-end">
<button class="p1-btn" id="p1-save-uc" type="button">Lưu Use Case</button>
</div>
</div>
</div>
<script>
(function(){
  function byId(id){ return document.getElementById(id); }
  function nowISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
  function clamp(v,min,max){ return v<min?min:(v>max?max:v); }
  function getLS(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)||JSON.stringify(fallback)); }catch(e){ return fallback; } }
  function setLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  function toArraySkills(input){ if (!input) return []; return String(input).split(',').map(s=>s.trim()).filter(Boolean); }

  function getSkills(){ return getLS('skills', []); }
  function getUseCases(){ return getLS('useCases', []); }
  function setUseCases(list){ setLS('useCases', list); }
  function getPersonaRules(){ return getLS('personaRules', []); }
  function setPersonaRules(list){ setLS('personaRules', list); }

  function ensurePersonaRule(code){
    var rules = getPersonaRules();
    var found = rules.find(r => r.code === code);
    if (!found){
      found = { code: code, expectedClusters:["Perception","Soft-Control","Audit"], mustTags:["mirror"], avoidTags:["over-expose"], targetReflex:80 };
      rules.push(found); setPersonaRules(rules);
    }
    return found;
  }
  function findSkillByToken(token){
    var s = getSkills(); var t = String(token).trim().toLowerCase();
    return s.find(x => String(x.id||'').toLowerCase()===t || String(x.name||'').toLowerCase()===t);
  }

  function scoreReflex(personaCode, skillsUsed, outcome, energyDelta){
    var rule = ensurePersonaRule(personaCode||'GEN'); var pts = 0;
    var allTags = [];
    skillsUsed.forEach(tok => { var sk = findSkillByToken(tok); if (sk && Array.isArray(sk.tags)) allTags = allTags.concat(sk.tags); });
    var hasMust = (rule.mustTags||[]).length ? (rule.mustTags.some(t => allTags.includes(t))) : false;
    if (hasMust) pts += 20; else if ((rule.mustTags||[]).length) pts -= 30;
    var clusters = skillsUsed.map(tok => { var sk=findSkillByToken(tok); return sk ? (sk.cluster||sk.clusters||sk.core||'NA') : 'NA'; });
    var expected = rule.expectedClusters || []; var inExpected = clusters.filter(c => expected.includes(c)).length;
    var ratio = skillsUsed.length ? (inExpected / skillsUsed.length) : 0;
    if (ratio >= 0.6) pts += 15; else if (ratio < 0.4) pts -= 15;
    if (outcome === 'win') pts += 10; else if (outcome === 'loss') pts -= 10;
    var d = Number(energyDelta||0);
    if (isFinite(d)){ if (d < 0) pts += Math.max(-10, d/2); else if (d > 0) pts += Math.min(10, d/3); }
    var base = 60 + pts; return Math.round(clamp(base, 0, 100));
  }

  function applyEnergy(skillsUsed, delta){
    var s = getSkills(); var anyLow = 0;
    skillsUsed.forEach(tok => {
      var sk = findSkillByToken(tok); if (!sk) return;
      var base = Number(sk.energyBase||60); var cost = Number(sk.energyCost||5);
      var newVal = clamp(base + Number(delta||(-cost)), 0, 100);
      sk.energyBase = newVal; sk.lastUsed = nowISO(); if (newVal < 30) anyLow++;
    });
    setLS('skills', s); return anyLow;
  }

  function addUseCase(uc){
    var list = getUseCases();
    var date = uc.date || nowISO();
    var persona = (uc.persona||'GEN').trim();
    var skills = Array.isArray(uc.skillsUsed) ? uc.skillsUsed : toArraySkills(uc.skillsUsed);
    var outcome = (uc.outcome||'neutral').trim();
    var delta = Number(uc.energyDelta||0);
    var score = scoreReflex(persona, skills, outcome, delta);
    var flags = [];
    var rule = ensurePersonaRule(persona); var target = Number(rule.targetReflex||80);
    if (score < (target - 15)) { flags.push('PERSONA_DRIFT'); }
    var lowCount = applyEnergy(skills, delta); if (lowCount > 0) flags.push('LOW_ENERGY');
    var id = 'UC-' + date + '-' + String(list.length+1).padStart(3,'0');
    var row = { id, date, persona, context:uc.context||'', skillsUsed:skills, outcome, energyDelta:delta, reflexScore:score, flags, notes:uc.notes||'' };
    list.push(row); setUseCases(list); renderUseCases(); updateCards(); if (typeof toast==='function') toast('Đã lưu Use Case #' + id); return row;
  }

  function runAudit(){
    var list = getUseCases().slice(-50); var alerts = [];
    var lowSeq = 0;
    for (var i=0;i<list.length;i++){
      var hasLow = (list[i].flags||[]).includes('LOW_ENERGY'); lowSeq = hasLow ? (lowSeq+1) : 0;
      if (lowSeq >= 3){ alerts.push({sev:'warn',code:'LOW_ENERGY_CHAIN',msg:'Năng lượng thấp ≥3 ca liên tiếp',fix:'Phục hồi 24–48h; giảm combo tiêu hao'}); break; }
    }
    var last5 = list.slice(-5);
    if (last5.length>=5){
      var avg = Math.round(last5.reduce((a,b)=>a+(b.reflexScore||0),0)/last5.length);
      var persona = last5[last5.length-1] ? last5[last5.length-1].persona : 'GEN';
      var rule = ensurePersonaRule(persona);
      if (avg < (Number(rule.targetReflex||80)-15)){
        alerts.push({sev:'info',code:'PERSONA_DRIFT',msg:'Reflex TB 5 ca gần < ngưỡng',fix:'Ôn combo nền của persona; loại tag trái hướng'});
      }
    }
    setLS('alerts', alerts); updateCards(); if (typeof toast==='function') toast('Audit xong: '+alerts.length+' cảnh báo'); return alerts;
  }

  function renderUseCases(){
    var body = byId('p1-log-body'); if (!body) return;
    var list = getUseCases().slice(-30).reverse();
    body.innerHTML = '';
    list.forEach(row => {
      var tr = document.createElement('tr');
      function td(t){ var x=document.createElement('td'); x.textContent=t; return x; }
      tr.appendChild(td(row.date||''));
      tr.appendChild(td(row.persona||''));
      tr.appendChild(td((row.skillsUsed||[]).join(' • ')));
      tr.appendChild(td(row.outcome||''));
      tr.appendChild(td(String(row.energyDelta||0)));
      tr.appendChild(td(String(row.reflexScore||'')));
      tr.appendChild(td((row.flags||[]).join(',')));
      body.appendChild(tr);
    });
  }
  function avgReflex(days){
    var list = getUseCases(); var since = Date.now() - days*24*3600*1000;
    var sel = list.filter(r => (new Date(r.date).getTime() || 0) >= since);
    if (!sel.length) return '–';
    var avg = Math.round(sel.reduce((a,b)=>a+(b.reflexScore||0),0)/sel.length);
    return String(avg);
  }
  function updateCards(){
    var r7 = byId('p1-reflex7'), r30 = byId('p1-reflex30');
    var en = byId('p1-energy'), le = byId('p1-lowenergy');
    var al = byId('p1-alerts');
    if (r7) r7.textContent = avgReflex(7);
    if (r30) r30.textContent = avgReflex(30);
    var s = getSkills();
    if (s.length){
      var avgE = Math.round(s.reduce((a,b)=>a+Number(b.energyBase||60),0)/s.length);
      if (en) en.textContent = String(avgE);
      var low = s.filter(x=>Number(x.energyBase||60)<30).length;
      if (le) le.textContent = String(low);
    } else {
      if (en) en.textContent = '–';
      if (le) le.textContent = '0';
    }
    var alerts = getLS('alerts', []);
    if (al) al.textContent = String(alerts.length||0);
  }
  function openUseCase(){ var m = byId('useCaseModal'); if (!m) return; m.classList.add('open'); m.style.display='flex'; var d=byId('ucDate'); if (d) d.value = nowISO(); }
  function closeUseCase(){ var m = byId('useCaseModal'); if (!m) return; m.classList.remove('open'); m.style.display='none'; }
  function saveUseCase(){
    var uc = {
      date: (byId('ucDate') && byId('ucDate').value) || nowISO(),
      persona: (byId('ucPersona') && byId('ucPersona').value) || 'GEN',
      context: (byId('ucContext') && byId('ucContext').value) || '',
      skillsUsed: (byId('ucSkills') && byId('ucSkills').value) || '',
      outcome: (byId('ucOutcome') && byId('ucOutcome').value) || 'neutral',
      energyDelta: Number((byId('ucDelta') && byId('ucDelta').value) || 0),
      notes: (byId('ucNotes') && byId('ucNotes').value) || ''
    };
    addUseCase(uc); closeUseCase();
  }
  function bindUI(){
    var btnOpen = byId('p1-open-uc'); if (btnOpen) btnOpen.addEventListener('click', openUseCase);
    var btnClose = byId('p1-close-uc'); if (btnClose) btnClose.addEventListener('click', closeUseCase);
    var btnSave = byId('p1-save-uc'); if (btnSave) btnSave.addEventListener('click', saveUseCase);
    var btnAudit = byId('p1-run-audit'); if (btnAudit) btnAudit.addEventListener('click', runAudit);
    document.addEventListener('keydown', function(e){
      if (e.ctrlKey && (e.key==='u' || e.key==='U')){ e.preventDefault(); openUseCase(); }
      if (e.ctrlKey && (e.key==='l' || e.key==='L')){ e.preventDefault(); runAudit(); }
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    var anchor = document.getElementById('auditSec') || null;
    var p1 = document.getElementById('p1-live');
    if (anchor && p1){ try{ anchor.prepend(p1); }catch(e){} } else { if (p1) { p1.style.display='none'; } }
    renderUseCases(); updateCards(); bindUI();
  });
  window.P1 = { addUseCase, runAudit, scoreReflex };
})();
</script>
<script>
/* ===== Critical Points (24K) Integration ===== */
(function(){
  function getLS(k, fb){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(fb)); }catch(e){ return fb; } }
  function setLS(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  function toastSafe(m){ try{ (typeof toast==='function'?toast:console.log)(m); }catch(_){ } }

  let CP_INDEX = { byK:{}, byName:{} };

  function normalizeK(k){
    if(!k) return null;
    let s = String(k).trim().toUpperCase();
    const m = s.match(/K\s*0*(\d{1,2})/);
    if(m) return "K"+Number(m[1]);
    return s.startsWith("K") ? s : null;
  }
  function deaccent(str){
    try{
      return String(str).normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/[đĐ]/g, m => m==='đ'?'d':'D')
        .toLowerCase()
        .replace(/\s+/g,' ')
        .trim();
    }catch(_){ return String(str||'').toLowerCase().trim(); }
  }
  function buildCPIndex(arr){
    const byK = {}, byName = {};
    (arr||[]).forEach(it => {
      const k = normalizeK(it.k || it.skillId || it.id);
      const name = (it.name || it.skillName || '').trim();
      const obj = {
        k: k || null,
        name: name || null,
        criticalPoints: Array.isArray(it.criticalPoints) ? it.criticalPoints.slice() : (it.criticalPoints ? [it.criticalPoints] : []),
        drills: Array.isArray(it.drills) ? it.drills.slice() : (it.drills ? [it.drills] : []),
        success: Array.isArray(it.success) ? it.success.slice() : (it.success ? [it.success] : []),
        evidence: Array.isArray(it.evidence) ? it.evidence.slice() : (it.evidence ? [it.evidence] : []),
        antiPatterns: Array.isArray(it.antiPatterns) ? it.antiPatterns.slice() : (it.antiPatterns ? [it.antiPatterns] : [])
      };
      if (k) byK[k] = obj;
      if (name) byName[deaccent(name)] = obj;
    });
    CP_INDEX = { byK, byName };
  }

  async function loadCriticalPoints(){
    // Inline-first (single-file mode)
    try{
      const inline = document.getElementById('CP_DATA');
      if(inline){
        const data = JSON.parse(inline.textContent||'{}');
        const arr = Array.isArray(data) ? data : (Array.isArray(data.skills) ? data.skills : []);
        if(arr && arr.length){ buildCPIndex(arr); return; }
      }
    }catch(e){ console.warn('[CP] inline parse failed', e); }
    // Fallback: try external JSON placed next to the HTML
    const candidates = ['24K_critical_points.json','./24K_critical_points.json'];
    for (const url of candidates){
      try{
        const res = await fetch(url, { cache:'no-cache' });
        if(!res.ok) continue;
        const data = await res.json();
        const arr = Array.isArray(data) ? data : (Array.isArray(data.skills) ? data.skills : []);
        if(arr && arr.length){ buildCPIndex(arr); return; }
      }catch(e){ /* ignore */ }
    }
  }

  function findCPForSkill(s){
    if(!s) return null;
    const k1 = normalizeK(s.k || s.skillId || s.kcode);
    if (k1 && CP_INDEX.byK[k1]) return CP_INDEX.byK[k1];
    const clusters = s.clusters || (typeof parseClusters==='function' ? parseClusters(s.note) : []);
    for (const k of (clusters||[])){
      const kk = normalizeK(k);
      if (kk && CP_INDEX.byK[kk]) return CP_INDEX.byK[kk];
    }
    const nm = s.name ? deaccent(s.name) : null;
    if (nm && CP_INDEX.byName[nm]) return CP_INDEX.byName[nm];
    return null;
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function listHtml(items){
    const arr = (items||[]).filter(Boolean);
    if (!arr.length) return '';
    return '<ul>' + arr.map(x => '<li>'+escapeHtml(String(x))+'</li>').join('') + '</ul>';
  }
  function baseRenderCPHTML(s){
    const cp = findCPForSkill(s);
    if(!cp) return '<details class="cp-block" open><summary></summary><div class="cp-sec" style="opacity:.7">Chưa liên kết dữ liệu CP. Gán K-code (K1..K24) hoặc chỉnh tên skill khớp JSON.</div></details>';
    const has = (cp.criticalPoints && cp.criticalPoints.length) || (cp.drills && cp.drills.length) || (cp.success && cp.success.length) || (cp.evidence && cp.evidence.length) || (cp.antiPatterns && cp.antiPatterns.length);
    if(!has) return '';
    return [
      '<details class="cp-block" open>',
        '<summary></summary>',
        '<div class="cp-sec"><h4>Critical Points</h4>', listHtml(cp.criticalPoints), '</div>',
        (cp.drills && cp.drills.length ? '<div class="cp-sec"><h4>Drills</h4>'+listHtml(cp.drills)+'</div>' : ''),
        (cp.success && cp.success.length ? '<div class="cp-sec"><h4>Success Criteria</h4>'+listHtml(cp.success)+'</div>' : ''),
        (cp.evidence && cp.evidence.length ? '<div class="cp-sec"><h4>Evidence</h4>'+listHtml(cp.evidence)+'</div>' : ''),
        (cp.antiPatterns && cp.antiPatterns.length ? '<div class="cp-sec"><h4>Anti-patterns</h4>'+listHtml(cp.antiPatterns)+'</div>' : ''),
      '</details>'
    ].join('');
  }
  window.renderCPHTML = window.renderCPHTML || baseRenderCPHTML;

  // Mini mapping UI
  function CP_optionsK(selected){
    let out = '<option value="">-- chọn K-code --</option>';
    for (let i=1;i<=24;i++){ const v='K'+i; out += '<option value="'+v+'"'+(selected===v?' selected':'')+'>'+v+'</option>'; }
    return out;
  }
  function escAttr(s){ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function CP_mappingRow(s){
    const sid = (s && (s.id||s.name||'')) || '';
    const sel = CP_optionsK(s.k || s.kcode || s.skillId || '');
    const nm  = escAttr((s && s.name) ? s.name : '');
    return ['<div class="cp-map">','<label>Gắn CP (K1–K24):</label>','<select class="cp-k" data-id="'+escAttr(sid)+'" data-name="'+nm+'">'+sel+'</select>','<button class="cp-apply" data-id="'+escAttr(sid)+'" data-name="'+nm+'">Gắn</button>','</div>'].join('');
  }
  function CP_attachKByIdOrName(sid, sname, kcode){
    if (!kcode) { toastSafe('Chưa chọn K-code'); return false; }
    const skills = getLS('skills', []);
    let changed = false;
    for (let i=0;i<skills.length;i++){
      const sk = skills[i];
      if (String(sk.id||'')===String(sid) || String(sk.name||'')===String(sname)){
        sk.k = kcode; sk.kcode = kcode;
        if (Array.isArray(sk.clusters)){
          if (!sk.clusters.includes(kcode)) sk.clusters.push(kcode);
        }
        skills[i] = sk; changed = true; break;
      }
    }
    if (changed){ setLS('skills', skills); toastSafe('Đã gắn '+kcode+' cho skill'); try{ renderSkills && renderSkills(); }catch(_){ } }
    else { toastSafe('Không tìm thấy skill để gắn'); }
    return changed;
  }
  function CP_bindMappingEvents(){
    document.querySelectorAll('.cp-map .cp-apply').forEach(btn => {
      if (btn._cpBound) return;
      btn._cpBound = true;
      btn.addEventListener('click', function(){
        const sid = btn.getAttribute('data-id')||'';
        const sname = btn.getAttribute('data-name')||'';
        const select = btn.parentElement.querySelector('.cp-k');
        const kcode = select ? select.value : '';
        CP_attachKByIdOrName(sid, sname, kcode);
      });
    });
  }
  if (!window.renderCPHTML._cpWrap){
    const _orig = window.renderCPHTML;
    window.renderCPHTML = function(s){
      let html = _orig(s) || '';
      const row = CP_mappingRow(s);
      if (html && html.indexOf('</details>')>=0){
        html = html.replace('</details>', row + '</details>');
      } else {
        html = '<details class="cp-block" open><summary></summary>' +
               '<div class="cp-sec" style="opacity:.7">Chưa liên kết dữ liệu CP. Gán K-code (K1..K24) hoặc chỉnh tên skill khớp JSON.</div>' +
               row +
               '</details>';
      }
      return html;
    };
    window.renderCPHTML._cpWrap = true;
  }
  if (typeof window.renderSkills === 'function' && !window.renderSkills._cpWrap){
    const _rs = window.renderSkills;
    window.renderSkills = function(){
      const r = _rs.apply(this, arguments);
      try{ CP_bindMappingEvents(); }catch(_){ }
      return r;
    };
    window.renderSkills._cpWrap = true;
  }

  document.addEventListener('DOMContentLoaded', async function(){
    try { await loadCriticalPoints(); } catch(_){ }
    try { CP_bindMappingEvents(); } catch(_){ }
  });
})();
/* ===== End CP Integration ===== */
</script>
<script>
(function(){
  function getLS(k, fb){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(fb)); }catch(e){ return fb; } }
  function setLS(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  function toastSafe(msg){ if (typeof toast==='function') toast(msg); else try{ console.log(msg); }catch(e){} }

  function CP_optionsK(selected){
    let out = '<option value="">-- chọn K-code --</option>';
    for (let i=1;i<=24;i++){
      const v = 'K'+i;
      out += `<option value="${v}" ${selected===v?'selected':''}>${v}</option>`;
    }
    return out;
  }

  function CP_mappingRow(s){
    const sid = (s && (s.id||s.name||'')) || '';
    const sel = CP_optionsK(s.k || s.kcode || s.skillId || '');
    return `
      <div class="cp-map">
        <label>Gắn CP (K1–K24):</label>
        <select class="cp-k" data-id="${sid}" data-name="${(s && s.name) ? s.name.replace(/"/g,'&quot;') : ''}">${sel}</select>
        <button class="cp-apply" data-id="${sid}" data-name="${(s && s.name) ? s.name.replace(/"/g,'&quot;') : ''}">Gắn</button>
      </div>`;
  }

  function CP_attachKByIdOrName(sid, sname, kcode){
    if (!kcode) return false;
    const skills = getLS('skills', []);
    let changed = false;
    for (let i=0;i<skills.length;i++){
      const sk = skills[i];
      if (String(sk.id||'')===String(sid) || String(sk.name||'')===String(sname)){
        sk.k = kcode; sk.kcode = kcode; // store both keys for wider compatibility
        // optionally sync to clusters if array exists
        if (Array.isArray(sk.clusters)){
          if (!sk.clusters.includes(kcode)) sk.clusters.push(kcode);
        }
        skills[i] = sk; changed = true; break;
      }
    }
    if (changed){ setLS('skills', skills); toastSafe('Đã gắn ' + kcode + ' cho skill'); try{ renderSkills && renderSkills(); }catch(_){} }
    else { toastSafe('Không tìm thấy skill để gắn'); }
    return changed;
  }

  function CP_bindMappingEvents(){
    document.querySelectorAll('.cp-map .cp-apply').forEach(btn=>{
      if (btn._cpBound) return;
      btn._cpBound = true;
      btn.addEventListener('click', function(){
        const sid = btn.getAttribute('data-id')||'';
        const sname = btn.getAttribute('data-name')||'';
        const select = btn.parentElement.querySelector('.cp-k');
        const kcode = select ? select.value : '';
        CP_attachKByIdOrName(sid, sname, kcode);
      });
    });
  }

  // Wrap renderCPHTML to inject mapping row
  if (typeof renderCPHTML === 'function' && !renderCPHTML._cpWrap){
    const _orig = renderCPHTML;
    window.renderCPHTML = function(s){
      let html = _orig(s) || '';
      const row = CP_mappingRow(s);
      if (html && html.indexOf('</details>')>=0){
        html = html.replace('</details>', row + '</details>');
      } else {
        html = `<details class="cp-block" open><summary></summary>
                <div class="cp-sec" style="opacity:.7">Chưa liên kết dữ liệu CP. Gán K-code (K1..K24) hoặc chỉnh tên skill khớp JSON.</div>
                ${row}
                </details>`;
      }
      return html;
    };
    renderCPHTML._cpWrap = true;
  }

  // Wrap renderSkills to bind events after render
  if (typeof renderSkills === 'function' && !renderSkills._cpWrap){
    const _rs = renderSkills;
    window.renderSkills = function(){
      const r = _rs.apply(this, arguments);
      try { CP_bindMappingEvents(); } catch(e){}
      return r;
    };
    renderSkills._cpWrap = true;
  }

  document.addEventListener('DOMContentLoaded', function(){
    try{ CP_bindMappingEvents(); }catch(e){}
  });
})();
</script>
<script>
(function(){
  function getLS(k, fb){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(fb)); }catch(e){ return fb; } }
  function setLS(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  function toastSafe(msg){ if (typeof toast==='function') toast(msg); else try{ console.log(msg); }catch(e){} }
  function escAttr(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/`/g,'&#96;')
      .replace(/\$\{/g,'&#36;{');
  }
  function CP_optionsK(selected){
    let out = '<option value="">-- chọn K-code --</option>';
    for (let i=1;i<=24;i++){
      const v = 'K'+i;
      out += '<option value="'+v+'"'+(selected===v?' selected':'')+'>'+v+'</option>';
    }
    return out;
  }
  function CP_mappingRow(s){
    const sid = (s && (s.id||s.name||'')) || '';
    const sel = CP_optionsK(s.k || s.kcode || s.skillId || '');
    const nm = escAttr((s && s.name) ? s.name : '');
    return [
      '<div class="cp-map">',
      '<label>Gắn CP (K1–K24):</label>',
      '<select class="cp-k" data-id="'+escAttr(sid)+'" data-name="'+nm+'">'+sel+'</select>',
      '<button class="cp-apply" data-id="'+escAttr(sid)+'" data-name="'+nm+'">Gắn</button>',
      '</div>'
    ].join('');
  }
  function CP_attachKByIdOrName(sid, sname, kcode){
    if (!kcode) { toastSafe('Chưa chọn K-code'); return false; }
    const skills = getLS('skills', []);
    let changed = false;
    for (let i=0;i<skills.length;i++){
      const sk = skills[i];
      if (String(sk.id||'')===String(sid) || String(sk.name||'')===String(sname)){
        sk.k = kcode; sk.kcode = kcode;
        if (Array.isArray(sk.clusters)){
          if (!sk.clusters.includes(kcode)) sk.clusters.push(kcode);
        }
        skills[i] = sk; changed = true; break;
      }
    }
    if (changed){ setLS('skills', skills); toastSafe('Đã gắn ' + kcode + ' cho skill'); try{ renderSkills && renderSkills(); }catch(_){} }
    else { toastSafe('Không tìm thấy skill để gắn'); }
    return changed;
  }
  function CP_bindMappingEvents(){
    document.querySelectorAll('.cp-map .cp-apply').forEach(btn=>{
      if (btn._cpBound) return;
      btn._cpBound = true;
      btn.addEventListener('click', function(){
        const sid = btn.getAttribute('data-id')||'';
        const sname = btn.getAttribute('data-name')||'';
        const select = btn.parentElement.querySelector('.cp-k');
        const kcode = select ? select.value : '';
        CP_attachKByIdOrName(sid, sname, kcode);
      });
    });
  }
  if (typeof renderCPHTML === 'function' && !renderCPHTML._cpWrap2){
    const _orig = renderCPHTML;
    window.renderCPHTML = function(s){
      let html = _orig(s) || '';
      const row = CP_mappingRow(s);
      if (html && html.indexOf('</details>')>=0){
        html = html.replace('</details>', row + '</details>');
      } else {
        html = '<details class="cp-block" open><summary></summary>' +
               '<div class="cp-sec" style="opacity:.7">Chưa liên kết dữ liệu CP. Gán K-code (K1..K24) hoặc chỉnh tên skill khớp JSON.</div>' +
               row +
               '</details>';
      }
      return html;
    };
    renderCPHTML._cpWrap2 = true;
  }
  if (typeof renderSkills === 'function' && !renderSkills._cpWrap2){
    const _rs = renderSkills;
    window.renderSkills = function(){
      const r = _rs.apply(this, arguments);
      try { CP_bindMappingEvents(); } catch(e){}
      return r;
    };
    renderSkills._cpWrap2 = true;
  }
  document.addEventListener('DOMContentLoaded', function(){
    try{ CP_bindMappingEvents(); }catch(e){}
  });
})();
</script>
<script id="tab-kbd-nav-helper">
    (function(){try{
      var order = ["tab-dashboard", "tab-skills", "tab-persona", "tab-audit"];
      var tabsElList = document.querySelectorAll('[role="tablist"]');
      tabsElList.forEach(function(tabsEl){
        tabsEl.addEventListener('keydown', function(e){
          var active = document.activeElement && document.activeElement.id;
          var i = order.indexOf(active);
          if(e.key==='ArrowRight'){ e.preventDefault(); var t = document.getElementById(order[(i+1+order.length)%order.length]); if(t) t.focus(); }
          if(e.key==='ArrowLeft') { e.preventDefault(); var t = document.getElementById(order[(i-1+order.length)%order.length]); if(t) t.focus(); }
          if(e.key==='Home')      { e.preventDefault(); var t = document.getElementById(order[0]); if(t) t.focus(); }
          if(e.key==='End')       { e.preventDefault(); var t = document.getElementById(order[order.length-1]); if(t) t.focus(); }
        });
      });
    }catch(_e){}})();
    </script>
<script id="tab-roving-sync">
(function(){
  function syncTabIndex(container){
    var tabs = container.querySelectorAll('[role="tab"]');
    tabs.forEach(function(tab){
      var selected = tab.getAttribute('aria-selected') === 'true';
      tab.setAttribute('tabindex', selected ? '0' : '-1');
    });
  }
  document.querySelectorAll('[role="tablist"]').forEach(function(tl){
    syncTabIndex(tl);
    var mo = new MutationObserver(function(muts){
      muts.forEach(function(m){
        if(m.type==='attributes' && m.attributeName==='aria-selected'){
          syncTabIndex(tl);
        }
      });
    });
    tl.querySelectorAll('[role="tab"]').forEach(function(tab){
      mo.observe(tab, {attributes:true, attributeFilter:['aria-selected']});
    });
  });
})();
</script>
<script id="af-audit-lints">
(function(){
  function $(id){return document.getElementById(id);}
  function getJSON(id){ try{ var el=$(id); return el?JSON.parse(el.textContent||'{}'):null; }catch(e){ return null; } }
  function getLS(k, d){ try{ var x = JSON.parse(localStorage.getItem(k)||'null'); return (x==null?d:x); }catch(e){ return d; } }

  var AF = getJSON('AF_DATA') || {skills:[]};
  var btn = $('p1-run-audit'), out = $('p1-alerts');
  if(!btn || !out || !AF.skills || !AF.skills.length) return;

  function lint(){
    var issues = [];
    var seenSkill = new Set();

    // AF_DATA structural checks
    (AF.skills||[]).forEach(function(s, sIdx){
      var name = s.SkillName||('Skill#'+(sIdx+1));
      if(seenSkill.has(name)){ issues.push({type:'dup-skill', msg:'Trùng SkillName: '+name}); }
      seenSkill.add(name);

      var cps = s.CP||[];
      if(!cps.length){ issues.push({type:'no-cp', msg:'Thiếu CP cho skill '+name}); }

      var cpIDs = new Set();
      cps.forEach(function(cp, i){
        var id = String(cp.CPID||'').trim();
        if(!id){ issues.push({type:'cp-missing-id', msg:name+' → CP#'+(i+1)+' thiếu CPID'}); }
        if(id){
          if(cpIDs.has(id)){ issues.push({type:'dup-cpid', msg:name+' → Trùng CPID '+id}); }
          cpIDs.add(id);
        }
        if(!cp.CPTitle){ issues.push({type:'cp-missing-title', msg:name+' → '+(id||('CP#'+(i+1)))+' thiếu tiêu đề'}); }
        if(!cp.SuccessCriteria){ issues.push({type:'cp-missing-success', msg:name+' → '+(id||('CP#'+(i+1)))+' thiếu SuccessCriteria'}); }
        if(!cp.FailSignals){ issues.push({type:'cp-missing-fail', msg:name+' → '+(id||('CP#'+(i+1)))+' thiếu FailSignals'}); }
      });

      var drills = s.Drills||[];
      drills.forEach(function(d, i){
        if(!d.DrillName){ issues.push({type:'drill-missing-name', msg:name+' → Drill#'+(i+1)+' thiếu tên'}); }
        if(!d.RecommendedFreq){ issues.push({type:'drill-missing-freq', msg:name+' → '+(d.DrillID||('Drill#'+(i+1)))+' thiếu tần suất'}); }
      });

      var res = s.Resources||[];
      res.forEach(function(r, i){
        if(!r.Title){ issues.push({type:'res-missing-title', msg:name+' → Resource#'+(i+1)+' thiếu tiêu đề'}); }
        if(!r.SourceType){ issues.push({type:'res-missing-type', msg:name+' → Resource "'+(r.Title||('Resource#'+(i+1)))+'" thiếu SourceType'}); }
      });

      if(s.ReviewCycleDays==null || isNaN(Number(s.ReviewCycleDays))){ issues.push({type:'missing-review', msg:name+' thiếu ReviewCycleDays'}); }
      if(!s.MasteryDefinition){ issues.push({type:'missing-mastery', msg:name+' thiếu MasteryDefinition'}); }
    });

    // Logs consistency
    var logs = getLS('logs_v1', []);
    logs.forEach(function(l, i){
      var s = (AF.skills||[]).find(x => (x.SkillName||'')===l.skill);
      if(!s){ issues.push({type:'log-unknown-skill', msg:'Log#'+(i+1)+' skill không có trong 24CP: '+(l.skill||'(rỗng)')}); return; }
      var ids = new Set((s.CP||[]).map(cp => String(cp.CPID||'').trim()));
      (l.cp||[]).forEach(function(cpid){
        if(!ids.has(String(cpid).trim())){
          issues.push({type:'log-unknown-cp', msg:'Log#'+(i+1)+' tham chiếu CP không tồn tại: '+cpid+' (skill '+s.SkillName+')'});
        }
      });
    });

    return issues;
  }

  function render(issues){
    out.textContent = String(issues.length);
    var listId = 'p1-alerts-list';
    var host = $('p1-alerts');
    // Create or replace a list under alerts
    var ex = document.getElementById(listId);
    if(ex) ex.remove();
    var ul = document.createElement('ul'); ul.id = listId; ul.style.marginTop = '8px'; ul.style.maxHeight='220px'; ul.style.overflow='auto';
    issues.slice(0,120).forEach(function(it){ var li = document.createElement('li'); li.textContent = it.msg; ul.appendChild(li); });
    host.parentNode && host.parentNode.appendChild(ul);
  }

  btn.addEventListener('click', function(){ render(lint()); });
  // Ctrl+L shortcut
  window.addEventListener('keydown', function(e){
    if((e.ctrlKey||e.metaKey) && (e.key==='l' || e.key==='L')){ e.preventDefault(); render(lint()); }
  });
})();
</script><div aria-hidden="true" aria-modal="true" class="modal" id="weeklyModal" role="dialog"><div class="dialog"><div class="row"><h3>Weekly Review</h3><div class="right"><button class="btn small" id="btnCloseWeekly" type="button">✕ Đóng</button></div></div><div class="grid"><div class="col-6"><h4>Tổng hợp 7 ngày</h4><div class="klist" id="weeklySummary"></div></div><div class="col-6"><h4>Đề xuất tuần tới</h4><div class="klist" id="weeklyActions"></div><div class="row"><button class="btn primary" id="btnApplyWeekly" type="button">Áp dụng kế hoạch</button></div></div></div></div></div><div aria-hidden="true" aria-modal="true" class="modal" id="focusModal" role="dialog"><div class="dialog">
<div class="row"><h3>Focus Hôm nay</h3><div class="right"><button class="btn small" id="btnCloseFocus" type="button">✕ Đóng</button></div></div>
<div class="muted">Chọn 3 kỹ năng ưu tiên và bắt đầu timer/ghi nhanh.</div>
<div class="grid" id="focusCards" style="margin-top:.5rem"></div>
<div class="row"><button class="btn primary" id="btnSaveFocusPlan" type="button">Lưu danh sách hôm nay</button></div>
</div></div><div aria-hidden="true" aria-modal="true" class="modal" id="kpiModal" role="dialog"><div class="dialog">
<div class="row"><h3>Quản lý KPI theo Kỹ năng</h3><div class="right"><button class="btn small" id="btnCloseKPI" type="button">✕ Đóng</button></div></div>
<div class="grid">
<div class="col-6">
<div class="field"><label>Kỹ năng</label><select id="kpiSkill"></select></div>
<div class="field"><label>Key (ví dụ: CTA_ok_rate)</label><input id="kpiKey" placeholder="tên ngắn" type="text"/></div>
<div class="field"><label>Label hiển thị</label><input id="kpiLabel" placeholder="Mô tả KPI" type="text"/></div>
<div class="field"><label>Target</label><input id="kpiTarget" placeholder="70" type="number"/></div>
<div class="field"><label>Đơn vị</label><input id="kpiUnit" placeholder="% hoặc số" type="text"/></div>
<div class="row"><button class="btn primary" id="btnAddKPI" type="button">Thêm KPI</button></div>
</div>
<div class="col-6">
<h4>KPI hiện có</h4>
<div class="klist" id="kpiList"></div>
</div>
</div>
</div></div><div aria-hidden="true" aria-modal="true" class="modal" id="mergeModal" role="dialog"><div class="dialog">
<div class="row"><h3>Gộp JSON</h3><div class="right"><button class="btn small" id="btnCloseMerge" type="button">✕ Đóng</button></div></div>
<div class="klist" id="mergePreview"></div>
<div class="row">
<select id="mergePolicy">
<option value="prefer-newer">Prefer Newer (mặc định)</option>
<option value="keep-both">Keep Both (đổi ID phụ)</option>
</select>
<button class="btn primary" id="btnApplyMerge" type="button">Áp dụng gộp</button>
</div>
</div></div><script id="plus-features-js">
(function(){
  function $(id){ return document.getElementById(id); }
  function getLS(k,d){ try{ var v=localStorage.getItem(k); return v?JSON.parse(v):d; }catch(_){ return d; } }
  function setLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  function todayStr(){ var d=new Date(); return d.toISOString().slice(0,10); }
  function weekId(dt){
    var d=new Date(dt.getTime()); d.setHours(0,0,0,0);
    d.setDate(d.getDate() + 3 - (d.getDay()+6)%7);
    var week1=new Date(d.getFullYear(),0,4);
    return d.getFullYear()+"-W"+String(1+Math.round(((d.getTime()-week1.getTime())/86400000 - 3 + (week1.getDay()+6)%7)/7)).padStart(2,'0');
  }
  function toast(t){ try{ if(window.snack) snack(t); else console.log(t); }catch(_){ console.log(t); } }
  function li(t){ var div=document.createElement('div'); div.className='kitem'; var code=document.createElement('div'); code.className='kcode'; code.textContent='•'; var name=document.createElement('div'); name.className='kname'; name.textContent=t; div.appendChild(code); div.appendChild(name); return div; }

  // ===== Weekly Review =====
  var btnWR=$('btnWeeklyReview'), modalWR=$('weeklyModal');
  if(btnWR && modalWR){
    btnWR.addEventListener('click', function(){ buildWeeklyReview(); modalWR.classList.add('open'); modalWR.setAttribute('aria-hidden','false'); });
    $('btnCloseWeekly').addEventListener('click', function(){ modalWR.classList.remove('open'); modalWR.setAttribute('aria-hidden','true'); });
    $('btnApplyWeekly').addEventListener('click', function(){
      var wk=weekId(new Date()); var actions=[...document.querySelectorAll('#weeklyActions .kname')].map(x=>x.textContent);
      var skills = actions.map(a=>a.split(' — ')[0]);
      var plans=getLS('weekly_plan_v1',[]).filter(p=>p.week_id!==wk);
      plans.push({week_id:wk, actions:actions, linked_skills:[...new Set(skills)], notes:'auto'});
      setLS('weekly_plan_v1', plans); setLS('plan_tag_current','plan:'+wk);
      toast('Đã áp dụng kế hoạch tuần '+wk); modalWR.classList.remove('open'); modalWR.setAttribute('aria-hidden','true');
    });
  }
  function buildWeeklyReview(){
    var logs=getLS('logs_v1',[]); var d7=new Date(); d7.setDate(d7.getDate()-6);
    logs=logs.filter(x=> new Date(x.date||todayStr())>=d7);
    var bySkill={}, failCP={};
    logs.forEach(l=>{ var s=l.skill||'(khác)'; bySkill[s]=(bySkill[s]||0)+1; if(l.cp && l.cp.length && (l.score||0)<=5){ l.cp.forEach(id=>{ failCP[id]=(failCP[id]||0)+1; }); } });
    var sum=$('weeklySummary'); if(sum){ sum.innerHTML=''; sum.appendChild(li('Tổng số log: '+logs.length)); 
      var top=Object.entries(bySkill).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]).join(', ')||'—';
      var bot=Object.entries(bySkill).sort((a,b)=>a[1]-b[1]).slice(0,3).map(x=>x[0]).join(', ')||'—';
      sum.appendChild(li('Kỹ năng nhiều nhất: '+top)); sum.appendChild(li('Kỹ năng ít nhất: '+bot));
      var fails=Object.entries(failCP).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]).join(', ')||'—'; sum.appendChild(li('CP hay fail: '+fails)); }
    var skills = getLS('skills_full', getLS('skills', [])) || [];
    function findSkill(name){ return skills.find(s=>s.name===name || s.k===name) || null; }
    var actions=[], seen={};
    Object.entries(bySkill).sort((a,b)=>a[1]-b[1]).slice(0,3).forEach(([sk,_])=>{ var s=findSkill(sk); if(s && !seen[sk]){ var dr=(s.drills&&s.drills[0]) || 'Drill 25’'; actions.push({skill:s.name, drill:dr, freq:'3x/tuần'}); seen[sk]=1; } });
    if(actions.length<3){ (skills.slice(0,5)).forEach(s=>{ if(actions.length<3 && !seen[s.name]){ actions.push({skill:s.name, drill:(s.drills&&s.drills[0])||'Drill 25’', freq:'2x/tuần'}); seen[s.name]=1; } }); }
    var list=$('weeklyActions'); if(list){ list.innerHTML=''; actions.forEach(a=> list.appendChild(li(a.skill+' — '+a.drill+' — '+a.freq))); }
  }

  // ===== Focus Today =====
  var btnFT=$('btnFocusToday'), modalFT=$('focusModal');
  if(btnFT && modalFT){
    btnFT.addEventListener('click', function(){ buildFocusToday(); modalFT.classList.add('open'); modalFT.setAttribute('aria-hidden','false'); });
    $('btnCloseFocus').addEventListener('click', function(){ modalFT.classList.remove('open'); modalFT.setAttribute('aria-hidden','true'); });
    $('btnSaveFocusPlan').addEventListener('click', function(){ var host=$('focusCards'); var names=[...host.querySelectorAll('h4')].map(x=>x.textContent); setLS('focus_today', {date: todayStr(), skill_ids:names, timers:[], notes:''}); toast('Đã lưu danh sách hôm nay.'); });
  }
  function buildFocusToday(){
    var host=$('focusCards'); if(!host) return; host.innerHTML='';
    var wk=weekId(new Date()); var plan=(getLS('weekly_plan_v1',[]).find(x=>x.week_id===wk)||{});
    var skills = (plan.linked_skills||[]); if(skills.length<3){ var fallback=getLS('skills_full', getLS('skills', []))||[]; skills = (skills.concat(fallback.slice(0,3).map(s=>s.name))).slice(0,3); }
    skills.forEach(function(name,i){
      var card=document.createElement('div'); card.className='col-4 card';
      card.innerHTML='<h4>'+(name||('Kỹ năng '+(i+1)))+'</h4>'+
        '<div class="row">'+
        '<button class="btn small" data-min="10">Bắt đầu 10’</button>'+
        '<button class="btn small" data-min="20">Bắt đầu 20’</button>'+
        '<button class="btn small" data-min="30">Bắt đầu 30’</button>'+
        '</div>'+
        '<div class="row"><input type="number" min="0" max="10" placeholder="Điểm (0–10)" class="p2-input score" style="max-width:120px"> <input type="number" min="1" max="5" placeholder="Năng lượng (1–5)" class="p2-input energy" style="max-width:140px"> <input type="number" step="0.01" placeholder="KPI (tuỳ chọn)" class="p2-input kpiVal" style="max-width:140px"> <button class="btn small">Lưu nhanh</button></div>';
      host.appendChild(card);
      var btns=card.querySelectorAll('button.btn.small'); 
      btns[0].addEventListener('click',()=>startTimer(name,10));
      btns[1].addEventListener('click',()=>startTimer(name,20));
      btns[2].addEventListener('click',()=>startTimer(name,30));
      btns[3].addEventListener('click',()=>quickSave(card,name));
      // chip cảnh báo: >3 ngày chưa log
      var logs=getLS('logs_v1',[]).filter(l=>l.skill===name).sort((a,b)=> new Date(b.date)-new Date(a.date));
      if(!logs.length || ((new Date(todayStr()) - new Date(logs[0].date))/86400000 > 3)){ var warn=document.createElement('div'); warn.className='muted small'; warn.style.color='var(--accent,#b91c1c)'; warn.textContent='>3 ngày chưa log'; card.appendChild(warn); }
    });
  }
  function startTimer(skill, minutes){ toast('Bắt đầu '+minutes+'’ — '+skill); }
  function quickSave(card, skill){
    var score=Number((card.querySelector('input.score')||{}).value||0);
    var energy=Number((card.querySelector('input.energy')||{}).value||0);
    var kpiVal=(card.querySelector('input.kpiVal')||{}).value; if(kpiVal==='') kpiVal=null; else kpiVal=Number(kpiVal);
    var logs=getLS('logs_v1',[]); var now=new Date();
    var obj={ id: 'L'+now.getTime(), date: now.toISOString().slice(0,10), time: now.toTimeString().slice(0,5), skill: skill, cp: [], duration: null, score: score, energy: energy, drill: '', note: '[focus-today]' };
    if(kpiVal!=null){ obj.kpi_values={default:kpiVal}; }
    logs.push(obj); setLS('logs_v1', logs);
    var ft=getLS('focus_today',{}); if(!ft || ft.date!==todayStr()) ft={date:todayStr(), skill_ids:[], timers:[], notes:''};
    if(ft.skill_ids.indexOf(skill)===-1) ft.skill_ids.push(skill);
    setLS('focus_today', ft); toast('Đã lưu • '+skill+' • Điểm '+score+' • NL '+energy);
  }

  // ===== Anomaly Radar =====
  function buildAlerts(){
    var logs=getLS('logs_v1',[]); var seven=new Date(); seven.setDate(seven.getDate()-6);
    var bySkill={}, recent=logs.filter(l=> new Date(l.date||todayStr())>=seven);
    recent.forEach(l=>{ bySkill[l.skill]=(bySkill[l.skill]||0)+1; });
    var alertList=[];
    var skills=getLS('skills_full', getLS('skills', []))||[];
    skills.forEach(s=>{ var last=logs.slice().reverse().find(l=>l.skill===s.name); if(!last){ alertList.push({type:'no_log', target:s.name}); } else { var d=(new Date(todayStr())-new Date(last.date||todayStr()))/86400000; if(d>7) alertList.push({type:'no_log', target:s.name}); } });
    var byDayEnergy={}; recent.forEach(l=>{ if(typeof l.energy==='number'){ byDayEnergy[l.date]=(byDayEnergy[l.date]||[]); byDayEnergy[l.date].push(l.energy); } });
    var energyAvg=Object.entries(byDayEnergy).sort().map(([d,arr])=>({d,avg:arr.reduce((a,b)=>a+b,0)/arr.length}));
    if(energyAvg.length>=3){ var last3=energyAvg.slice(-3).map(x=>x.avg); if(last3[2]-last3[0] <= -2) alertList.push({type:'energy_drop', target:'all'}); }
    var total=recent.length; if(total>0){ var top=Object.entries(bySkill).sort((a,b)=>b[1]-a[1])[0]; if(top && (top[1]/total)>=0.6) alertList.push({type:'overfocus', target: top[0]}); }
    setLS('alerts_v1', alertList.map(a=>({...a, date:todayStr(), resolved:false})));
    renderAlerts(getLS('alerts_v1',[]));
  }
  function renderAlerts(list){
    var host=$('alertsList'); if(!host) return; host.innerHTML='';
    if(!list.length){ host.appendChild(li('Không có cảnh báo.')); return; }
    list.forEach(function(a,i){ var text=(a.type==='no_log'?'No log >7d — ':a.type==='energy_drop'?'Energy drop — ':'Overfocus — ')+(a.target||''); var row=li(text); var btn=document.createElement('button'); btn.className='btn small'; btn.textContent='Mark resolved';
      btn.addEventListener('click', function(){ var arr=getLS('alerts_v1',[]); arr[i].resolved=true; setLS('alerts_v1',arr); renderAlerts(arr.filter(x=>!x.resolved)); }); row.appendChild(btn); host.appendChild(row); });
  }

  // ===== Merge JSON =====
  var btnMerge=$('btnMergeJSON'), fileMerge=$('fileMerge'), mergeModal=$('mergeModal');
  if(btnMerge && fileMerge){
    btnMerge.addEventListener('click', ()=> fileMerge.click());
    fileMerge.addEventListener('change', async (e)=>{
      var file=e.target.files[0]; if(!file) return;
      try{
        var text=await file.text(); var data=JSON.parse(text);
        var preview = dryRunMerge(data); $('mergePreview').innerHTML=preview.html;
        mergeModal.classList.add('open'); mergeModal.setAttribute('aria-hidden','false');
        $('btnApplyMerge').onclick=function(){ applyMerge(data, $('mergePolicy').value); mergeModal.classList.remove('open'); };
      }catch(err){ console.error(err); toast('File không hợp lệ'); }
    });
    $('btnCloseMerge').addEventListener('click', ()=>{ mergeModal.classList.remove('open'); mergeModal.setAttribute('aria-hidden','true'); });
  }
  function normalizeLogs(arr){ return (arr||[]).map(x=> ({...x, id: x.id || ('H'+(x.date||todayStr())+'-'+(x.time||'00:00')+'-'+(x.skill||'').slice(0,10)+'-'+((x.note||'').length)) })); }
  function dryRunMerge(data){
    var currLogs=getLS('logs_v1',[]), currSkills=getLS('skills_full', getLS('skills', []))||getLS('skills',[]);
    var newLogs=normalizeLogs(data.logs_v1||data.logs||[]);
    var logsAdded=0, logsDup=0;
    var map=new Set(currLogs.map(l=>l.id|| (l.date+'|'+l.time+'|'+l.skill+'|'+(l.note||'') )));
    newLogs.forEach(l=>{ var key=l.id || (l.date+'|'+l.time+'|'+l.skill+'|'+(l.note||'')); if(map.has(key)) logsDup++; else logsAdded++; });
    var html='<div class="kitem"><div class="kcode">LOG</div><div class="kname">Thêm mới: '+logsAdded+' • Trùng: '+logsDup+'</div></div>';
    var skillsAdded=0, skillsDup=0;
    var names=new Set((currSkills||[]).map(s=>s.name));
    (data.skills||[]).forEach(s=>{ if(names.has(s.name)) skillsDup++; else skillsAdded++; });
    html+= '<div class="kitem"><div class="kcode">SK</div><div class="kname">Thêm mới: '+skillsAdded+' • Trùng: '+skillsDup+'</div></div>';
    return {html:html, logsAdded:logsAdded, logsDup:logsDup};
  }
  function applyMerge(data, policy){
    var logs=getLS('logs_v1',[]), skills=getLS('skills_full', getLS('skills', []))||[];
    var newLogs=normalizeLogs(data.logs_v1||data.logs||[]);
    var map=new Map(logs.map(l=>[l.id, l]));
    newLogs.forEach(l=>{
      if(!map.has(l.id)){ l.source_file='import'; l.merged_at= new Date().toISOString(); logs.push(l); map.set(l.id,l); }
      else{
        if(policy==='keep-both'){ l.id=l.id+'#'+Math.random().toString(36).slice(2,6); l.source_file='import'; l.merged_at=new Date().toISOString(); logs.push(l); }
        else{ var old=map.get(l.id); if(new Date(l.date+'T'+(l.time||'00:00')) > new Date(old.date+'T'+(old.time||'00:00'))){ map.set(l.id,l); } }
      }
    });
    // skills merge by name
    var names=new Map(skills.map(s=>[s.name, s]));
    (data.skills||[]).forEach(s=>{ if(!names.has(s.name)){ skills.push(s); names.set(s.name,s); } });
    setLS('logs_v1', logs); setLS('skills_full', skills); toast('Đã gộp xong'); window.dispatchEvent(new CustomEvent('af-logs-updated'));
  }

  // ===== Evidence Manifest =====
  var btnSaveLogModal=$('btnSaveLogModal');
  if(btnSaveLogModal){
    btnSaveLogModal.addEventListener('click', function(){
      var evid=$('eviInput')?$('eviInput').value.trim():'';
      if(evid){
        var id='E'+Date.now();
        var manifest=getLS('evidence_manifest',[]);
        manifest.push({id:id, type: (evid.startsWith('http')?'link':'note'), ref:evid, date: todayStr(), tags:[], linked_log_id: null});
        setLS('evidence_manifest', manifest);
      }
    });
  }

  // init
  try{ buildAlerts(); }catch(_){}
})();</script>
<script id="cp-tab-js">
(function(){
  try{
    var nav = document.querySelector('nav[role="tablist"]');
    var auditBtn = document.getElementById('tab-audit');
    var skillsBtn = document.getElementById('tab-skills');
    if(!nav || !auditBtn || !skillsBtn) return;

    // Build new tab button
    if(!document.getElementById('tab-24cp')){
      var cpBtn = document.createElement('button');
      cpBtn.className = 'tab';
      cpBtn.id = 'tab-24cp';
      cpBtn.type = 'button';
      cpBtn.setAttribute('role','tab');
      cpBtn.setAttribute('tabindex','-1');
      cpBtn.setAttribute('aria-controls','cpSec');
      cpBtn.setAttribute('aria-selected','false');
      cpBtn.textContent = '📚 24CP';
      // Insert before Audit for a clean flow: Skills — Persona — 24CP — Audit
      nav.insertBefore(cpBtn, auditBtn);
    }

    // Build new section for 24CP
    if(!document.getElementById('cpSec')){
      var cpSec = document.createElement('section');
      cpSec.id = 'cpSec';
      cpSec.className = 'view';
      cpSec.setAttribute('role','tabpanel');
      // Insert after skillsSec (before personaSec for stability)
      var skillsSec = document.getElementById('skillsSec');
      (skillsSec && skillsSec.parentNode).insertBefore(cpSec, skillsSec.nextSibling);
    }

    // Move the existing A–F + Logs — 24CP block into cpSec
    var cpRoot = document.getElementById('skill-content-af');
    var cpTarget = document.getElementById('cpSec');
    if(cpRoot && cpTarget && cpRoot.parentNode !== cpTarget){
      cpTarget.appendChild(cpRoot);
    }

    // === Wire tab behavior (compatible with existing logic) ===
    function selectTab(id){
      var tabs = Array.from(document.querySelectorAll('.tab'));
      var views = Array.from(document.querySelectorAll('section.view'));
      tabs.forEach(function(b){
        var selected = b.getAttribute('aria-controls') === id;
        b.setAttribute('aria-selected', String(selected));
        // tabindex management for a11y
        b.setAttribute('tabindex', selected ? '0' : '-1');
      });
      views.forEach(function(v){ v.classList.toggle('active', v.id === id); });
      try{ (window.storage || {}).set && storage.set('activeTab', id); }catch(_){}
    }

    // Hook events for our new tab (and refresh others for key nav)
    var cpBtn = document.getElementById('tab-24cp');
    if(cpBtn){
      cpBtn.addEventListener('click', function(){ selectTab('cpSec'); });
      cpBtn.addEventListener('keydown', function(e){
        var tabs = Array.from(document.querySelectorAll('.tab'));
        var idx = tabs.indexOf(cpBtn);
        if(e.key === 'ArrowRight'){ (tabs[(idx+1)%tabs.length]||cpBtn).focus(); }
        if(e.key === 'ArrowLeft'){ (tabs[(idx-1+tabs.length)%tabs.length]||cpBtn).focus(); }
        if(e.key === 'Enter' || e.key === ' '){ selectTab('cpSec'); }
      });
    }

    // Respect saved active tab if it was cpSec
    try{
      var saved = (window.storage || {}).get ? storage.get('activeTab') : null;
      if(saved === 'cpSec'){ selectTab('cpSec'); }
    }catch(_){}

  }catch(e){ /* no-op */ }
})();
</script>


<script id="operate-dock-js">
(function(){
  // Only run on 24CP tab
  const cpSec = document.getElementById('cpSec');
  if(!cpSec) return;

  // Build dock UI
  const dock = document.createElement('div');
  dock.id = 'operateDock';
  dock.innerHTML = `
    <div>
      <div class="smallnote">Đang vận hành</div>
      <div><span id="opSkill">—</span></div>
    </div>
    <div>
      <div class="smallnote">CP chọn</div>
      <select id="cpSelect" multiple size="6"></select>
    </div>
    <div>
      <div class="smallnote">Đồng hồ</div>
      <div class="timer-block">
        <div id="clockFace"><div id="secondHand"></div><div id="centerDot"></div></div>
        <div>
          <div id="clockTime">00<span class="colon">:</span>00<span class="colon">:</span>00</div>
          <div class="smallnote">Phiên <span id="sessionView">00:00</span></div>
        </div>
      </div>
    </div>
    <div id="dockBtns" style="display:flex; gap:8px; justify-content:flex-end">
      <button class="btn primary" id="btnQuickLog">✚ Log ngay (Ctrl+Enter)</button>
    </div>
  `;
  cpSec.appendChild(dock);

  // Helpers
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const storage = {
    get(k,d){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); }catch(_){ return d; } },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // Populate CP list from existing UI text (CP01..CP24)
  function refreshCPList(){
    const wrap = $('#afCPs');
    const text = (wrap && wrap.textContent) || '';
    const cps = Array.from(new Set((text.match(/CP\d{2}/g)||[])));
    const sel = $('#cpSelect');
    sel.innerHTML = cps.map(c=>`<option value="${c}">${c}</option>`).join('');
    // restore preset for current skill
    const sid = currentSkillId();
    const preset = storage.get('af_preset_'+sid, []);
    preset.forEach(v=> { const o = Array.from(sel.options).find(x=>x.value===v); o && (o.selected = true); });
  }

  // Track current selected skill from dropdown
  function currentSkillId(){
    const sel = $('#afSkill');
    return sel ? (sel.value || sel.options[sel.selectedIndex]?.value || '') : '';
  }
  function currentSkillObj(){
    try{
      const AF = window.AF || (window.getJSON && getJSON('AF_DATA')) || {skills:[]};
      const sid = currentSkillId();
      return (AF.skills||[]).find(s=>s.id===sid) || {id:sid, name: $('#afSkill')?.options[$('#afSkill').selectedIndex]?.text || ''};
    }catch(e){ return {id: currentSkillId(), name: ''}; }
  }
  function updateSkillName(){
    const obj = currentSkillObj();
    $('#opSkill').textContent = obj?.name || '—';
  }

  // Timer logic removed (always-on clock)
  // Quick log: open existing modal, prefill content with skill + CPs
  $('#btnQuickLog').addEventListener('click', ()=>{
    const skill = currentSkillObj();
    // Prefer official function if available
    if(typeof openQuickLog==='function'){ openQuickLog(skill); }
    // set current skill id for logger
    try{ window.currentLogSkillId = skill.id; }catch(_){}
    const sel = $('#cpSelect');
    const chosen = Array.from(sel?.selectedOptions||[]).map(o=>o.value);
    const text = `[${chosen.join(', ')}] Bản ghi nhanh`;
    const li = $('#logInput'); if(li){ li.value = text; li.selectionStart = li.value.length; li.selectionEnd = li.value.length; }
  });

  // Preset: save CP choices per skill when user changes selection (double-click to save)
  $('#cpSelect').addEventListener('dblclick', ()=>{
    const sid = currentSkillId();
    const vals = Array.from($('#cpSelect').selectedOptions).map(o=>o.value);
    storage.set('af_preset_'+sid, vals);
    (window.toast||console.log)('Đã lưu preset CP cho skill.');
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key === 'Enter'){ e.preventDefault(); $('#btnQuickLog').click(); }
  });

  // Initial
  updateSkillName();
  refreshCPList();

  // Watch changes
  $('#afSkill') && $('#afSkill').addEventListener('change', ()=>{ updateSkillName(); refreshCPList(); });
  // Because CPs render async when skill changes, refresh after a delay as well
  $('#afSkill') && $('#afSkill').addEventListener('change', ()=> setTimeout(refreshCPList, 120));
})();

// === Ticking clock (no start/stop) ===
(function(){
  const clockTime = document.getElementById('clockTime');
  const secHand = document.getElementById('secondHand');
  const sessionEl = document.getElementById('sessionView');
  if(!clockTime || !secHand) return;
  let sessionStart = Date.now();

  function two(n){ return (n<10?'0':'')+n; }
  function render(){
    const now = new Date();
    const h = two(now.getHours()), m = two(now.getMinutes()), s = two(now.getSeconds());
    clockTime.innerHTML = `${h}<span class="colon">:</span>${m}<span class="colon">:</span>${s}`;
    secHand.style.transform = `rotate(${now.getSeconds()*6}deg)`;
    const dur = Math.floor((Date.now() - sessionStart)/1000);
    sessionEl && (sessionEl.textContent = `${two(Math.floor(dur/60))}:${two(dur%60)}`);
  }
  setInterval(render, 1000); render();

  // Reset session when CP selection changes or when "Log ngay" is used
  const cpSel = document.getElementById('cpSelect');
  cpSel && cpSel.addEventListener('change', ()=>{ sessionStart = Date.now(); });
  const btnQuick = document.getElementById('btnQuickLog');
  btnQuick && btnQuick.addEventListener('click', ()=>{ sessionStart = Date.now(); });
  const skillSel = document.getElementById('afSkill');
  skillSel && skillSel.addEventListener('change', ()=>{ sessionStart = Date.now(); });
})();

</script>

<script id="cp-cleanup-js">
(function(){
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const textify = (el)=> (el && (el.textContent||'').trim()) || '';
  const isDash = (el)=> !el || textify(el) === '—';

  // 1) Collapse filters into <details>
  (function setupFilters(){
    const root = document.getElementById('skill-content-af');
    if(!root || document.getElementById('afFilters')) return;
    // Do not collapse the Persona filter into the advanced filter section.  By setting
    // `cat` to null we ensure the persona dropdown stays visible within the Skills tab
    // rather than being moved into the advanced filters UI (see issue in 24K version).
    const cat = null; // document.getElementById('personaFilter');
    const skill = document.getElementById('afSkill');
    const search = document.getElementById('afSearch');
    if(!cat && !skill && !search) return;

    // Create <details> shell
    const det = document.createElement('details');
    det.id = 'afFilters';
    det.innerHTML = `<summary>🔎 Bộ lọc (Advanced)</summary><div id="afFiltersGrid"></div>`;
    // Insert after the intro paragraph (first <p> in card)
    const firstP = root.querySelector('p');
    root.insertBefore(det, firstP ? firstP.nextSibling : root.firstChild);

    const grid = det.querySelector('#afFiltersGrid');
    [cat, skill, search].forEach(el=>{
      if(!el) return;
      const box = document.createElement('div');
      // try to pick the nearest field wrapper, else parentNode
      const wrap = el.closest('.field') || el.parentElement;
      if(wrap && wrap.parentElement){
        box.appendChild(wrap);
        grid.appendChild(box);
      }
    });

    // default collapsed
    det.open = false;
  })();

  // 2) Hide empty rows in "Chi tiết kỹ năng" table
  (function hideEmptyRows(){
    const table = document.querySelector('#skill-content-af table.af-table');
    if(!table) return;
    $$('tr', table).forEach(tr=>{
      const td = tr.querySelector('td');
      if(!td) return;
      if(isDash(td) || !textify(td)) tr.classList.add('af-hide');
    });
  })();

  // 3) Hide sections when empty
  (function hideEmptySections(){
    const pairs = [
      {title: $('h3.af-section-title + #afRes')?.previousElementSibling, body: $('#afRes')},
      {title: $('h3.af-section-title + #afScn')?.previousElementSibling, body: $('#afScn')},
      {title: $('h3.af-section-title + #afRev')?.previousElementSibling, body: $('#afRev')},
      {title: $('h3.af-section-title + #afStats')?.previousElementSibling, body: $('#afStats')},
    ];
    pairs.forEach(({title, body})=>{
      if(!body) return;
      const empty = isDash(body) || (body.id==='afStats' && $$('#afStats .af-stat .af-muted').length && $$('#afStats .af-stat div:last-child').every(x=>textify(x)==='0' || textify(x)==='—'));
      if(empty || body.id==='afRev'){ // luôn ẩn Weekly Review ở 24CP
        title && title.classList.add('af-hide');
        body.classList.add('af-hide');
      }
    });
  })();

  // 4) Render Logs for current skill only
  (function afLogsForSkill(){
    const table = document.getElementById('afLogsTbl');
    const body = document.getElementById('afLogsBody');
    if(!table || !body) return;

    function getLogs(){ try{ return JSON.parse(localStorage.getItem('logs_v1')||'[]'); }catch(_){ return []; } }
    function currentSkillName(){
      const sel = document.getElementById('afSkill');
      if(!sel) return '';
      const opt = sel.options[sel.selectedIndex];
      return (opt && (opt.text || '').trim()) || '';
    }
    function render(){
      const name = currentSkillName();
      const logs = getLogs().filter(x=> (x.skill||'').trim() === name);
      body.innerHTML = '';
      logs.forEach(row=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.date||''}</td><td>${row.time||''}</td><td>${row.cp||''}</td><td>${row.duration||''}</td><td>${row.score||''}</td><td>${row.energy||''}</td><td>${row.drill||''}</td><td>${row.note||''}</td>`;
        body.appendChild(tr);
      });
      table.classList.toggle('af-hide', logs.length===0);
    }
    render();
    document.getElementById('afSkill') && document.getElementById('afSkill').addEventListener('change', ()=> setTimeout(render, 80));
    // Light observer to update when external code writes logs
    window.addEventListener('storage', (e)=>{ if(e.key==='logs_v1') render(); });
  })();
})();
</script>


<script>
// /* PERSONA_SOURCE_FROM_GOC */ — Persona lấy từ Gốc.html
(function(){
  var ARCH = ["Sirene","Void Jester","Strategic Shadow","Strategic Ghost","Omni Mind","Dark Sirene","Core Operator"];
  function fillPersonaOptions(){
    var sel = document.getElementById('personaFilter');
    if(!sel) return;
    if(sel.children.length<=1){
      var frag=document.createDocumentFragment();
      ARCH.forEach(function(p){ frag.appendChild(new Option(p,p)); });
      sel.appendChild(frag);
    }
  }
  document.addEventListener('DOMContentLoaded', fillPersonaOptions);
})();
</script>


<script>
// === Focus Today: chọn thời lượng bằng đồng hồ (HH:MM) + Timer thật ===
(function(){
  function $(s, r){ r=r||document; return r.querySelector(s); }
  function $$(s, r){ r=r||document; return Array.from(r.querySelectorAll(s)); }
  function getLS(k,d){ try{ var x=JSON.parse(localStorage.getItem(k)||'null'); return (x==null?d:x);}catch(_){ return d; } }
  function setLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  function todayStr(){ var d=new Date(); return d.toISOString().slice(0,10); }
  function weekId(d){ d=d||new Date(); var y=d.getFullYear(); var onejan=new Date(y,0,1); var week=Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7); return y+'-W'+String(week).padStart(2,'0'); }
  function toMinutes(hhmm){ if(!hhmm) return 0; var p=hhmm.split(':'); return (parseInt(p[0]||0,10)*60 + parseInt(p[1]||0,10))|0; }
  function fromMinutes(mins){ mins=Math.max(0,mins|0); var h=String(Math.floor(mins/60)).padStart(2,'0'); var m=String(mins%60).padStart(2,'0'); return h+':'+m; }

  // state per card
  var timers = new Map(); // el -> {remain, id, running}

  function skillNames(){
    var skills = getLS('skills_full', getLS('skills', [])) || [];
    return (skills||[]).map(function(s){ return s.name || s.k || ''; }).filter(Boolean);
  }

  function overrideSaveHandler(){
    var btn = $('#btnSaveFocusPlan'); if(!btn) return;
    var clone = btn.cloneNode(true); btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener('click', function(){
      var host = $('#focusCards'); if(!host) return;
      var names = $$('.focus-card select.focus-skill', host).map(function(sel){ return sel.value; }).filter(Boolean);
      while (names.length<3) names.push('');
      var wk = weekId(new Date());
      var plan = (getLS('weekly_plan_v1', []).find(function(x){return x.week_id===wk;}) || {week_id:wk, actions:[], linked_skills:[]});
      plan.linked_skills = names.slice(0,3);
      var arr = getLS('weekly_plan_v1', []);
      var idx = arr.findIndex(function(x){return x.week_id===wk;});
      if (idx>=0) arr[idx]=plan; else arr.push(plan);
      setLS('weekly_plan_v1', arr);
      try{ alert('Đã lưu danh sách hôm nay.'); }catch(_){}
    });
  }

  function startTimer(card){
    var dur = toMinutes(card.querySelector('input[type=\"time\"]').value);
    if(!dur){ try{ alert('Chưa chọn thời lượng (HH:MM)'); }catch(_){ } return; }
    var key = card;
    var st = timers.get(key) || {remain: dur*60, id: null, running: false};
    if(!st.running){
      // nếu mới set dur thì reset remain
      if(st.remain<=0 || st.remain>dur*60) st.remain = dur*60;
      st.running = true;
      st.id = setInterval(function(){
        st.remain -= 1;
        updateCountdown(card, st.remain);
        if(st.remain<=0){
          clearInterval(st.id); st.id=null; st.running=false; st.remain=0;
          updateCountdown(card, 0);
          try{ alert('Hết giờ: '+(card.querySelector('select.focus-skill')?.value||'')); }catch(_){}
        }
      }, 1000);
      timers.set(key, st);
      updateButtons(card);
    }
  }
  function pauseTimer(card){
    var st = timers.get(card); if(!st) return;
    if(st.running){ clearInterval(st.id); st.id=null; st.running=false; updateButtons(card); }
  }
  function resetTimer(card){
    var inp = card.querySelector('input[type=\"time\"]');
    var dur = toMinutes(inp.value);
    var st = timers.get(card) || {remain: dur*60, id: null, running:false};
    if(st.id) clearInterval(st.id);
    st.remain = dur*60; st.running=false; st.id=null;
    timers.set(card, st);
    updateCountdown(card, st.remain);
    updateButtons(card);
  }
  function updateCountdown(card, seconds){
    seconds = Math.max(0, seconds|0);
    var el = card.querySelector('.countdown');
    var m = Math.floor(seconds/60), s = seconds%60;
    el.textContent = (String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'));
  }
  function updateButtons(card){
    var st = timers.get(card)||{running:false};
    var btnStart = card.querySelector('.btn-start');
    var btnPause = card.querySelector('.btn-pause');
    btnStart.disabled = st.running;
    btnPause.disabled = !st.running;
  }

  function quickSave(card){
    var sel = card.querySelector('select.focus-skill');
    var name = sel ? sel.value : '';
    var durMins = toMinutes(card.querySelector('input[type=\"time\"]').value);
    var energy = Number(card.querySelector('input[name=\"energy\"]')?.value||0);
    var score = Number(card.querySelector('input[name=\"score\"]')?.value||0);
    var note = String(card.querySelector('input[name=\"note\"]')?.value||'');
    var logs = getLS('logs_v1', []);
    var row = { id: 'L'+Date.now(), date: todayStr(), persona:'', skill:name, cp:[], duration:durMins, score:score, energy:energy, drill:'', note: note+' [focus-today]' };
    logs.push(row); setLS('logs_v1', logs);
    try{ alert('Đã lưu nhanh cho '+name+' ('+durMins+'p)'); }catch(_){}
  }

  window.buildFocusToday = function(){
    var host = $('#focusCards'); if(!host) return; host.innerHTML='';
    timers.clear();

    // danh sách đề xuất từ weekly_plan_v1, fallback = 3 skill đầu tiên
    var wk = weekId(new Date());
    var plan = (getLS('weekly_plan_v1',[]).find(function(x){return x.week_id===wk;}) || {});
    var list = plan.linked_skills || [];
    if(list.length<3){
      var fallback = getLS('skills_full', getLS('skills', [])) || [];
      var fallbackNames = fallback.map(function(s){return s.name || s.k || '';}).filter(Boolean);
      list = (list.concat(fallbackNames)).slice(0,3);
    }
    var options = skillNames();

    for (var i=0;i<3;i++){
      var name = list[i] || '';
      var card = document.createElement('div'); card.className='col-4 card focus-card';
      // Build select options
      var optHtml = '<option value=\"\">— Chọn kỹ năng —</option>' + options.map(function(n){ return '<option'+(n===name?' selected':'')+' value=\"'+n.replace(/\"/g,'&quot;')+'\">'+n+'</option>'; }).join('');
      card.innerHTML = ''
        + '<div class=\"row\" style=\"align-items:center;justify-content:space-between\">'
        + '  <h4 style=\"margin:0\">Slot '+(i+1)+'</h4>'
        + '  <select class=\"focus-skill\" style=\"min-width:220px\">'+ optHtml +'</select>'
        + '</div>'
        + '<div class=\"row\" style=\"gap:.75rem;align-items:center\">'
        + '  <label class=\"muted small\" style=\"min-width:80px\">Thời lượng</label>'
        + '  <input type=\"time\" class=\"dur\" step=\"60\" value=\"00:20\">'
        + '  <span class=\"countdown\" style=\"font-variant-tabular-nums:tabular-nums\">00:20</span>'
        + '  <button class=\"btn small btn-start\">Bắt đầu</button>'
        + '  <button class=\"btn small btn-pause\" disabled>Tạm dừng</button>'
        + '  <button class=\"btn small btn-reset\">Đặt lại</button>'
        + '</div>'
        + '<div class=\"row\">'
        + '  <input name=\"score\" type=\"number\" min=\"0\" max=\"10\" placeholder=\"Điểm (0–10)\" style=\"width:120px\">'
        + '  <input name=\"energy\" type=\"number\" min=\"0\" max=\"10\" placeholder=\"Năng lượng (0–10)\" style=\"width:140px\">'
        + '  <input name=\"note\" type=\"text\" placeholder=\"Ghi chú\" style=\"flex:1\">'
        + '  <button class=\"btn small btn-save\">Lưu nhanh</button>'
        + '</div>';
      host.appendChild(card);
      // init countdown
      updateCountdown(card, toMinutes(card.querySelector('input[type=\"time\"]').value)*60);
      // wire up
      card.querySelector('.btn-start').addEventListener('click', function(e){ startTimer(e.target.closest('.focus-card')); });
      card.querySelector('.btn-pause').addEventListener('click', function(e){ pauseTimer(e.target.closest('.focus-card')); });
      card.querySelector('.btn-reset').addEventListener('click', function(e){ resetTimer(e.target.closest('.focus-card')); });
      card.querySelector('.btn-save').addEventListener('click', function(e){ quickSave(e.target.closest('.focus-card')); });
      card.querySelector('input[type=\"time\"]').addEventListener('change', function(e){
        var c = e.target.closest('.focus-card');
        var st = timers.get(c);
        if(st && st.running){ pauseTimer(c); }
        resetTimer(c);
      });
    }
    overrideSaveHandler();
  };

  // build lại mỗi lần mở modal
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('btnFocusToday');
    var modal = document.getElementById('focusModal');
    if (btn && modal){
      btn.addEventListener('click', function(){ try{ buildFocusToday(); }catch(_){ } });
    }
  });
})();
</script></script>


<script>
// /* KPI_MANAGER_IMPL */ — Quản lý KPI theo Kỹ năng (localStorage: kpi_v1)
(function(){
  function $(s, r){ r=r||document; return r.querySelector(s); }
  function $$(s, r){ r=r||document; return Array.from(r.querySelectorAll(s)); }
  function getLS(k,d){ try{ var x=JSON.parse(localStorage.getItem(k)||'null'); return (x==null?d:x);}catch(_){ return d; } }
  function setLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
  function ensureSkills(){
    var skills = getLS('skills_full', getLS('skills', [])) || [];
    return (skills||[]).map(function(s){ return s.name||s.k||''; }).filter(Boolean);
  }
  function openKPIModal(){
    var m = $('#kpiModal'); if(!m) return;
    m.classList.add('open'); m.setAttribute('aria-hidden','false');
  }
  function closeKPIModal(){
    var m = $('#kpiModal'); if(!m) return;
    m.classList.remove('open'); m.setAttribute('aria-hidden','true');
  }
  function fillSkillOptions(){
    var sel = $('#kpiSkill'); if(!sel) return;
    var skills = ensureSkills();
    var val = sel.value;
    sel.innerHTML = skills.map(function(n){ return '<option value="'+n.replace(/"/g,'&quot;')+'">'+n+'</option>'; }).join('');
    if (val && skills.indexOf(val)>=0) sel.value = val;
  }
  function renderKPIList(){
    var host = $('#kpiList'); if(!host) return;
    var list = getLS('kpi_v1', []);
    if (!Array.isArray(list)) list = [];
    host.innerHTML = '';
    if (!list.length){ host.innerHTML = '<div class="muted">Chưa có KPI nào.</div>'; return; }
    // group by skill
    var map = {};
    list.forEach(function(k){ (map[k.skill] = map[k.skill]||[]).push(k); });
    Object.keys(map).sort().forEach(function(skill){
      var title = document.createElement('div'); title.className='kitem'; title.innerHTML = '<strong>'+skill+'</strong>';
      host.appendChild(title);
      map[skill].forEach(function(k, idx){
        var row = document.createElement('div'); row.className='kitem';
        row.innerHTML = '<span>'+k.key+' — '+(k.label||'')+' (target: '+(k.target||'')+(k.unit?(' '+k.unit):'')+')</span>';
        var del = document.createElement('button'); del.className='btn small'; del.textContent='Xóa';
        del.addEventListener('click', function(){
          var arr=getLS('kpi_v1', []);
          var i = arr.findIndex(function(x){ return x.skill===k.skill && x.key===k.key; });
          if(i>=0){ arr.splice(i,1); setLS('kpi_v1', arr); renderKPIList(); }
        });
        row.appendChild(document.createTextNode(' ')); row.appendChild(del);
        host.appendChild(row);
      });
    });
  }
  function addKPI(){
    var skill = $('#kpiSkill').value;
    var key = ($('#kpiKey').value||'').trim();
    var label = ($('#kpiLabel').value||'').trim();
    var target = ($('#kpiTarget').value||'').trim();
    var unit = ($('#kpiUnit').value||'').trim();
    if(!skill || !key){ try{ alert('Chọn kỹ năng và nhập Key.'); }catch(_){ } return; }
    var arr = getLS('kpi_v1', []); if(!Array.isArray(arr)) arr = [];
    // upsert by (skill,key)
    var idx = arr.findIndex(function(x){ return x.skill===skill && x.key===key; });
    var rec = {skill:skill, key:key, label:label, target:target, unit:unit, active:true, updated:new Date().toISOString()};
    if(idx>=0) arr[idx]=rec; else arr.push(rec);
    setLS('kpi_v1', arr);
    renderKPIList();
    try{ alert('Đã lưu KPI cho '+skill+': '+key); }catch(_){}
  }
  document.addEventListener('DOMContentLoaded', function(){
    var btnOpen = $('#btnKPIManager');
    var btnClose = $('#btnCloseKPI');
    var btnAdd = $('#btnAddKPI');
    if(btnOpen){ btnOpen.addEventListener('click', function(){ fillSkillOptions(); renderKPIList(); openKPIModal(); }); }
    if(btnClose){ btnClose.addEventListener('click', closeKPIModal); }
    if(btnAdd){ btnAdd.addEventListener('click', addKPI); }
  });
})();
</script>


<script>
// === Audit UX Patch v1.1 (unify alerts, persist resolve/snooze, toolbar) ===
(function(){
  const getLS = (k, d) => { try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch(_){ return d; } };
  const setLS = (k, v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } };

  function normalizeAlert(a){
    // Radar style
    if(a && a.type){
      const map = {no_log:'info', overfocus:'info', energy_drop:'warn'};
      return { code: String(a.type||'').toUpperCase(), target: a.target||'', sev: map[a.type]||a.sev||'info', source:'radar', date: a.date||new Date().toISOString().slice(0,10) };
    }
    // UseCase style
    return { code: String(a.code||'GEN').toUpperCase(), target: a.target||'', sev: a.sev||'info', source:'usecase', date: a.date||new Date().toISOString().slice(0,10) };
  }
  function keyOf(n){ return (n.code||'')+'::'+(n.target||''); }

  function getState(){ return getLS('audit_alert_state', {}); }
  function setState(s){ setLS('audit_alert_state', s); }

  function inSnooze(state){ if(!state || !state.snooze_until) return false; try{ return new Date(state.snooze_until) > new Date(); }catch(_){ return false; } }

  function unifyAlerts(){
    const a1 = (getLS('alerts', [])||[]).map(normalizeAlert);
    const a2 = (getLS('alerts_v1', [])||[]).map(normalizeAlert);
    const map = {};
    [...a1, ...a2].forEach(n => { const k = keyOf(n); if(!map[k]) map[k]=n; });
    const state = getState();
    const merged = Object.values(map).map(n => {
      const st = state[keyOf(n)] || {};
      return { ...n, resolved: !!st.resolved, snooze_until: st.snooze_until || null };
    });
    setLS('audit_alerts', merged);
    // update cards count (unresolved + not snoozed)
    const count = merged.filter(x => !x.resolved && !inSnooze(x)).length;
    const el = document.getElementById('p1-alerts'); if(el) el.textContent = String(count);
    renderUnifiedList(); // refresh radar list as well
    return merged;
  }

  function ensureToolbar(){
    const host = document.getElementById('alertsList'); if(!host || document.getElementById('alertsToolbar')) return;
    const bar = document.createElement('div'); bar.id='alertsToolbar'; bar.style.margin='6px 0 8px'; bar.style.display='flex'; bar.style.gap='6px'; bar.style.flexWrap='wrap';
    bar.innerHTML = '<button class="btn small" data-f="all">Tất cả</button>' +
                    '<button class="btn small" data-f="unresolved">Chưa xử lý</button>' +
                    '<button class="btn small" data-f="crit">Chỉ cảnh báo mạnh</button>' +
                    '<button class="btn small" id="btnReloadAlerts">↻ Đồng bộ</button>';
    host.parentNode.insertBefore(bar, host);
    bar.addEventListener('click', function(ev){
      const t = ev.target; if(!(t instanceof HTMLElement)) return;
      const f = t.getAttribute('data-f'); if(!f) return;
      bar.setAttribute('data-active', f);
      renderUnifiedList();
    });
    const reload = document.getElementById('btnReloadAlerts');
    if(reload) reload.addEventListener('click', unifyAlerts);
  }

  function renderUnifiedList(){
    ensureToolbar();
    const host = document.getElementById('alertsList'); if(!host) return;
    const merged = getLS('audit_alerts', []);
    const bar = document.getElementById('alertsToolbar');
    const filter = (bar && bar.getAttribute('data-active')) || 'unresolved';
    const state = getState();

    function txt(a){
      if(a.source==='radar'){
        if(a.code==='NO_LOG') return 'No log >7d — ' + (a.target||'');
        if(a.code==='ENERGY_DROP') return 'Energy drop — ' + (a.target||'all');
        if(a.code==='OVERFOCUS') return 'Overfocus — ' + (a.target||'');
      }
      return (a.msg || (a.code + (a.target?(' — '+a.target):'')));
    }
    function sevBadge(a){
      const s = (a.sev||'info').toLowerCase();
      const b = document.createElement('span');
      b.className = 'badge ' + (s==='warn'?'warn':(s==='crit'?'error':''));
      b.textContent = s.toUpperCase();
      b.style.marginRight='8px';
      return b;
    }
    const now = new Date();
    const filtered = merged.filter(a => {
      const st = state[keyOf(a)] || {};
      const snoozed = st.snooze_until && new Date(st.snooze_until) > now;
      if(filter==='unresolved') return !st.resolved && !snoozed;
      if(filter==='crit') return (a.sev==='crit' || a.sev==='warn') && !st.resolved && !snoozed;
      return true;
    });
    host.innerHTML = '';
    if(!filtered.length){ host.appendChild(document.createTextNode('Không có cảnh báo.')); return; }
    filtered.forEach(a => {
      const k = keyOf(a);
      const row = document.createElement('div'); row.className='kitem'; row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.gap='8px';
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
      left.appendChild(sevBadge(a));
      const t = document.createElement('span'); t.textContent = txt(a); left.appendChild(t);
      row.appendChild(left);
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
      // Resolve
      const btnR = document.createElement('button'); btnR.className='btn small'; btnR.textContent='Resolve';
      btnR.addEventListener('click', function(){
        const st = getState(); st[k] = Object.assign({}, st[k], {resolved:true, snooze_until:null});
        setState(st); unifyAlerts();
      });
      // Snooze 3d
      const btnS = document.createElement('button'); btnS.className='btn small'; btnS.textContent='Snooze 3d';
      btnS.addEventListener('click', function(){
        const until = new Date(); until.setDate(until.getDate()+3);
        const st = getState(); st[k] = Object.assign({}, st[k], {snooze_until: until.toISOString().slice(0,10)});
        setState(st); unifyAlerts();
      });
      right.appendChild(btnR); right.appendChild(btnS);
      row.appendChild(right);
      host.appendChild(row);
    });
  }

  // Hook original builders to keep unified store updated
  const __runAudit = window.runAudit;
  if(typeof __runAudit === 'function'){
    window.runAudit = function(){ const res = __runAudit.apply(this, arguments); try{ unifyAlerts(); }catch(_){ } return res; };
  }
  const __buildAlerts = window.buildAlerts;
  if(typeof __buildAlerts === 'function'){
    window.buildAlerts = function(){ const res = __buildAlerts.apply(this, arguments); try{ unifyAlerts(); }catch(_){ } return res; };
  }

  // Quick Log -> also append a light log into logs_v1 (for Radar logic to see activity)
  document.addEventListener('DOMContentLoaded', function(){
    try{
      const btn = document.getElementById('btnSaveLog');
      if(btn && !btn.__patched){
        btn.__patched = true;
        btn.addEventListener('click', function(){
          const q = document.getElementById('quickLog');
          const text = q ? q.value.trim() : '';
          if(!text) return;
          const lv1 = getLS('logs_v1', []);
          const personaSel = document.getElementById('personaSelect');
          const persona = personaSel && personaSel.value ? personaSel.value : 'GEN';
          lv1.push({ date: (new Date()).toISOString().slice(0,10), skill: 'NOTE', energy: 0, persona: persona, note: text });
          setLS('logs_v1', lv1);
          // refresh radar if function exists
          if(typeof buildAlerts === 'function') buildAlerts();
        }, {capture: true});
      }
    }catch(_){}
    // Initial unify on load (after a tiny tick for original init)
    setTimeout(unifyAlerts, 200);
  });
})();
</script>

</body>
</html>
